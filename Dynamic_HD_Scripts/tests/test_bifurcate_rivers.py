'''
Unit tests for the river bifurcation

Created on Feb 16, 2024

@author: thomasriddick
'''

import unittest
import numpy as np
import os.path as path
from tests.context import data_dir
from Dynamic_HD_Scripts.interface.cpp_interface.libs.bifurcate_rivers_basic_icon_wrapper import bifurcate_rivers_basic_icon_cpp

class BifurcateRiversTestCase(unittest.TestCase):

    def testBifurcateRiversBasic(self):
        mouth_positions_filepath = path.join(data_dir,"temp",
                                             "rmouth_positions_test.txt")
        cell_neighbors = np.array([5,7,2,
                                   1,10,3,
                                   2,13,4,
                                   3,16,5,
                                   4,19,1,
                                   20,21,7,
                                   1,6,8,
                                   7,23,9,
                                   8,25,10,
                                   2,9,11,
                                   10,27,12,
                                   11,29,13,
                                   3,12,14,
                                   13,31,15,
                                   14,33,16,
                                   4,15,17,
                                   16,35,18,
                                   17,37,19,
                                   5,18,20,
                                   19,39,6,
                                   6,40,22,
                                   21,41,23,
                                   8,22,24,
                                   23,43,25,
                                   24,26,9,
                                   25,45,27,
                                   11,26,28,
                                   27,47,29,
                                   12,28,30,
                                   29,49,31,
                                   14,30,32,
                                   31,51,33,
                                   15,32,34,
                                   33,53,35,
                                   17,34,36,
                                   35,55,37,
                                   18,36,38,
                                   37,57,39,
                                   20,38,40,
                                   39,59,21,
                                   22,60,42,
                                   41,61,43,
                                   24,42,44,
                                   43,63,45,
                                   26,44,46,
                                   45,64,47,
                                   28,46,48,
                                   47,66,49,
                                   30,48,50,
                                   49,67,51,
                                   32,50,52,
                                   51,69,53,
                                   34,52,54,
                                   53,70,55,
                                   36,54,56,
                                   55,72,57,
                                   38,56,58,
                                   57,73,59,
                                   40,58,60,
                                   59,75,41,
                                   42,75,62,
                                   61,76,63,
                                   44,62,64,
                                   46,63,65,
                                   64,77,66,
                                   48,65,67,
                                   50,66,68,
                                   67,78,69,
                                   52,68,70,
                                   54,69,71,
                                   70,79,72,
                                   56,71,73,
                                   58,72,74,
                                   73,80,75,
                                   60,74,61,
                                   62,80,77,
                                   65,76,78,
                                   68,77,79,
                                   71,78,80,
                                   74,79,76],
                                   dtype=np.int32)
        original_next_cell_index_in = np.array([-2,
                                                -1,
                                                 2,
                                                16,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                27,
                                                29,
                                                30,
                                                30,
                                                33,
                                                15,
                                                18,
                                                19,
                                                -1,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -1,
                                                27,
                                                -1,
                                                -1,
                                                30,
                                                30,
                                                32,
                                                54,
                                                37,
                                                37,
                                                -1,
                                                -1,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -1,
                                                -1,
                                                -1,
                                                -1,
                                                49,
                                                49,
                                                53,
                                                54,
                                                -1,
                                                38,
                                                57,
                                                -1,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                46,
                                                48,
                                                68,
                                                69,
                                                52,
                                                54,
                                                72,
                                                -1,
                                                -2,
                                                -2,
                                                -2,
                                                -2,
                                                78,
                                                68,
                                                72,
                                                -2],
                                                dtype=np.int32)
        cumulative_flow_in = np.array([0,
                                       0,
                                       1,
                                       100,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       1,
                                       1,
                                       1,
                                       1,
                                       102,
                                       101,
                                       1,
                                       2,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       1,
                                       0,
                                       0,
                                       1,
                                       104,
                                       103,
                                       1,
                                       1,
                                       1,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       1,
                                       1,
                                       55,
                                       56,
                                       0,
                                       1,
                                       1,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       1,
                                       1,
                                       1,
                                       53,
                                       54,
                                       1,
                                       1,
                                       0,
                                       0,
                                       0,
                                       0,
                                       0,
                                       50,
                                       51,
                                       1,
                                       0],
                                       dtype=np.int32)
        landsea_mask_in = np.array([True,
                                    True,
                                    False,
                                    False,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    False,
                                    True,
                                    True,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    False,
                                    False,
                                    False,
                                    False,
                                    True,
                                    False,
                                    False,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    False,
                                    True,
                                    True,
                                    True,
                                    True,
                                    True,
                                    False,
                                    False,
                                    False,
                                    True],
                                    dtype=np.int32)
        expected_number_of_outflows_out = np.array([1,
                                                    1,
                                                    1,
                                                    2,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    3,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    2,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    1,
                                                    2,
                                                    2,
                                                    1,
                                                    1],
                                                    dtype=np.int32)
        expected_next_cell_index_out = np.array([-2,
                                                 -1,
                                                 2,
                                                 16,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 27,
                                                 29,
                                                 11,
                                                 29,
                                                 33,
                                                 15,
                                                 18,
                                                 19,
                                                 -1,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -1,
                                                 27,
                                                 -1,
                                                 -1,
                                                 30,
                                                 30,
                                                 32,
                                                 54,
                                                 37,
                                                 37,
                                                 -1,
                                                 -1,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -1,
                                                 -1,
                                                 -1,
                                                 -1,
                                                 49,
                                                 49,
                                                 53,
                                                 54,
                                                 -1,
                                                 38,
                                                 37,
                                                 -1,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -1,
                                                 46,
                                                 48,
                                                 68,
                                                 69,
                                                 52,
                                                 56,
                                                 72,
                                                 -1,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 -2,
                                                 78,
                                                 68,
                                                 72,
                                                 -2],
                                                 dtype=np.int32)
        expected_bifurcations_next_cell_index_slice_one = np.array([-9,
                                                                    -9,
                                                                    -9,
                                                                     2,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    14,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    71,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    64,
                                                                    70,
                                                                    -9,
                                                                    -9],
                                                                    dtype=np.int32)
        expected_bifurcations_next_cell_index_slice_two = np.array([-9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    13,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9,
                                                                    -9],
                                                                    dtype=np.int32)
        expected_bifurcations_next_cell_index_other_slices = np.array([-9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9,
                                                                       -9],
                                                                       dtype=np.int32)
        mouth_positions_text = \
            """primary mouth: 30
            secondary mouth: 29
            secondary mouth: 27
            secondary mouth: 2
            primary mouth: 54
            secondary mouth: 37
            secondary mouth: 72
            secondary mouth: 64"""
        with open(mouth_positions_filepath,"w") as f:
            f.writelines(mouth_positions_text)
        bifurcations_next_cell_index_out = -9*np.ones((80*11),dtype=np.int32)
        number_of_outflows_out = np.zeros((80,),dtype=np.int32)
        cumulative_flow_threshold_fraction_in = 0.1
        minimum_cells_from_split_to_main_mouth_in = 3
        maximum_cells_from_split_to_main_mouth_in = np.iinfo(np.int32).max
        bifurcate_rivers_basic_icon_cpp(cell_neighbors,
                                        original_next_cell_index_in,
                                        cumulative_flow_in,
                                        np.logical_not(landsea_mask_in).\
                                                       astype(np.int32),
                                        number_of_outflows_out,
                                        bifurcations_next_cell_index_out,
                                        mouth_positions_filepath,
                                        minimum_cells_from_split_to_main_mouth_in,
                                        maximum_cells_from_split_to_main_mouth_in,
                                        cumulative_flow_threshold_fraction_in)
        np.testing.assert_array_equal(number_of_outflows_out,
                                      expected_number_of_outflows_out)
        np.testing.assert_array_equal(original_next_cell_index_in,
                                      expected_next_cell_index_out)
        np.testing.assert_array_equal(bifurcations_next_cell_index_out[0:80],
           expected_bifurcations_next_cell_index_slice_one)
        np.testing.assert_array_equal(bifurcations_next_cell_index_out[80:160],
            expected_bifurcations_next_cell_index_slice_two)
        np.testing.assert_array_equal(bifurcations_next_cell_index_out[160:],
            np.tile(expected_bifurcations_next_cell_index_other_slices,9))

if __name__ == "__main__":
    unittest.main()
