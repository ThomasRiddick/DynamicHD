\documentclass{article}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\geometry{a4paper}                   % ... or a4paper or a5paper or ...
%\geometry{landscape}                % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{gensymb}
\usepackage{epstopdf}
\usepackage{enumerate}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{url}
\usepackage{longtable}
\usepackage{afterpage}
\lstdefinestyle{bash_input}{
language=bash,
basicstyle=\small\sffamily,
numbers=left,
numberstyle=\tiny,
numbersep=3pt,
frame=tb,
columns=fullflexible,
backgroundcolor=\color{yellow!20},
linewidth=0.9\linewidth,
xleftmargin=0.1\linewidth
}

\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}
\newcounter{stepnum}[subsection]
\newcommand{\customstep}[2][]{ \refstepcounter{stepnum}\paragraph{Step \thestepnum\label{#1}: #2}}

\title{Generation of HD Parameters Files for ICON Grids: Description and Instructions}
\author{Thomas Riddick}
\date{15th August 2020}
\begin{document}
\maketitle
\tableofcontents
\newpage
\lstset{language=bash}
\section{Introduction}
This document describes the procedures used to generate river directions (also known as flow directions or river routings) and parameters for use with the JSBACH4 HD model running on ICON Icosahedral grids (see section \ref{sec-desc}). It also provides technical instructions for generating these parameters in the necessary format (see section \ref{sec-instr}). The basic method varies depending on whether river directions are required for a low (coarse) resolution ICON grid such as r2b3 or r2b4 or a fine resolution ICON grid such as r2b9. For low resolutions grids the method also varies depending on whether it is desired to include internal (endorheic) drainage basins or not. Discussion on the JSBACH4 HD model, on river direction determination in general and on the tools for this purpose at MPI-M is given in \ref{sub-sec-desc-gen-notes}. It is suggested reader interested only in one particular resolution skip straight to reading the description of the method for that resolution and then the instructions for that resolution before using the general information to help clarify any questions.
\section{Descriptions of Procedures for Generating River Directions and Parameters} \label{sec-desc}
\subsection{General Notes} \label{sub-sec-desc-gen-notes}
The HD model (originally developed for JSBACH3 by Stefan Hagemann\cite{Hagemann:1998aa,Hagemann:1998ab,JGRD:JGRD8049}) in JSBACH4 (when it is being run on a ICON Icosahedral grid) runs on the same grid as the atmospheric (and land) model. It also runs on the same time-step as the rest of the land model. This is a marked difference from JSBACH3 where it ran on its own independent regular latitude-longitude grid at a 0.5\degree resolution. Apart from this difference in spatial and temporal resolution (and grid) the JSBACH4 HD model is scientifically identical to the JSBACH3 HD model. As the coupler is currently setup when using a fractional land-sea mask outflow into the ocean can only occur in cells which are 100\% ocean\footnote{Work is currently under way to allow outflow into the partial ocean cells.}. 

The HD model requires a set of river directions or flow directions for each cell (point) in the HD models grid. These directions always point to a neighbouring cell (or are a sink or outflow point); this includes diagonal neighbours on the latitude-longitude grid (such that each cell has 8 neighbours) and neighbour just touching a corner of the cell on the icon grid (such that each cell has 11 or 12 neighbours). Three components to the flow are simulated - base flow, overland flow and river flow. Base flow and overland flow are where water enters the HD model from the JSBACH soil moisture model. These two flow components flow just one cell from where they enter the model before being merged into the river flow. They use the same flow directions as the rivers themselves.

River directions are generally derived by combining topographic analysis of Digital Elevation Models (DEMs) with information on known river networks. One source of high quality high resolutions river directions is the HydroSheds database \cite{doi:10.1029/2008EO100001}\footnote{A potential alternative source of high quality, high resolution river directions is the MERIT Hydro database\cite{doi:10.1029/2019WR024873} but this is yet to be explored.} which offers a corrected DEM, river directions and flow accumulation on 15 arc second and 30 arc second latitude-longitude grids (the corrected DEM and river directions are also available on a 3 arc second grid). A major downside of this database is that it does not cover regions above 60\degree N (as of the time of writing). A number of derived products (HydroBasins - a map of river basins; HydroRivers - a map of river paths) are also offered - these have been extended to cover the full globe by blending the HydroSheds data with lower quality data from an earlier project. It is worth noting these are derived products - they are generated by analysing the primary HydroSheds dataset.

The most naive method for generating river direction is to route rivers down the path of steepest decent. However; a significant problem with this is DEMs tend to contain very large numbers of false sinks (both a low resolutions due to unresolved valleys and high resolution due to sensing errors). These must be removed by a tool called a sink filling algorithm. Here we use the priority flood sink filling algorithm (for a wide overview of this topic see \cite{barnes2014priority}).

Upscaling of river direction cannot be done using regular upscaling method. Instead specialised method are required based around the idea of preferable preserving lines of high cumulative flow. The algorithm used here is the COTAT plus algorithm\cite{WRCR:WRCR10603}  (or technically a modified version of this; see \cite{gmd-11-4291-2018}). An alternative algorithm, the FLOW algorithm\cite{hess-13-2241-2009}, can produce better results at low resolutions but requires non-local flows (i.e. cell flowing to a cell that isn't one of their neighbours) which aren't currently possible in the HD model and might interfere with parallelisation.

Generation of river direction and parameters for ICON grids is done here at MPI-M using a package of tools originally developed for generating dynamic river directions for JSBACH3\cite{gmd-11-4291-2018} for use in long transient simulations in the PalMod project\cite{Latif:2016aa}. Many of these tools run on ICON grids as well as latitude-longitude grids.  Table \ref{table-tools} list the set of tools current available for latitude-longitude and/or ICON grids including some scaling tools that can be applied to scale between the two grids. Table \ref{table-tools-descs} gives a description of each tool.
\renewcommand{\arraystretch}{1.15}
\begin{table}
\begin{tabular} { | l | c | c | c | c |} 
\hline
Tool & ICON& Lat-Lon & ICON to & Lat-Lon  \\
& Grid & Grid & Lat-Lon & to ICON \\
\hline
Sink Filling Algorithm & \checkmark & \checkmark & N/A & N/A \\ 
Downslope Routing Algorithm & \checkmark & \checkmark & N/A & N/A \\
Land-sea Mask Downscaling Alg. & - & -  & \checkmark & - \\
COTAT+ Upscaling Algorithm & - &  \checkmark & - &  \checkmark \\
Complex Loop Breaking Alg. & - & \checkmark & - & \checkmark \\
Catchment Generation Alg. & \checkmark & \checkmark & N/A & N/A \\
Cumulative Flow Gen. Alg. &  \checkmark & \checkmark & N/A & N/A \\
Parameter Generation Code\footnotemark & \checkmark & \checkmark & N/A & N/A \\
FLOW Upscaling Algorithm & - & \checkmark & - & - \\
Orography Upscaling Algorithm &  - &\checkmark & - & - \\
Basin Analysis Algorithm & \checkmark & \checkmark & N/A & N/A \\
\hline
\end{tabular} 
\caption{List of the various available tools and the grids they can be applied on. The last three tools are not of direct relevance to ICON river direction generation and are only included for reference.}
\label{table-tools}
\end{table}

\footnotetext{This code is a modified version of that developed by Stefan Hagemann.}

\afterpage{
\begin{center}
\begin{longtable} { | l | p{8cm} |} 
\caption{Descriptions of the various tools.} \\
\hline
Tool & Descriptions \\
\hline
Sink Filling Algorithm & Fills enclosed depressions in a DEM up to the level of the lowest point on the rim of the depression (such that after filling enclosed depressions will be removed from the DEM and downslope routing will always reach the ocean). Can be programmed to leave flagged 'true' sinks unfilled if desired. \\
Downslope Routing Algorithm & Generates a set of river direction where each cell points to lowest among its neighbours (or outflows to the ocean) includes a sub-algorithm to deal with flat regions (so that all cells point to other cells such that the flow eventually exits the region). Can be set to report any depressions found as errors or to mark they as inland sink points. \\
Land-sea Mask Downscaling Alg. & Recreates the outline of a coarse land-sea mask in a finer grid. Cross grid downscaling from an ICON grid to a finer latitude-longitude grid is possible.\\
COTAT+ Upscaling Algorithm & Upscales river directions such as to preserve major rivers. Can incorporate inland sink points. Along with the fine river directions requires a set of fine cumulative flows. Automatically breaks simply 2-point loops. Cross grid upscaling from a latitude-longitude grid to a coarser ICON grid is possible.\\
Complex Loop Breaking Alg. & Break complex multiple ($>2$) point loops. Needs the cumulative flow and catchments of both the coarse and fine grids alongside the river directions on both grids.  Cross grid application from a latitude-longitude grid to a coarser ICON grid is possible.   \\
Catchment Generation Alg. &Generates the set of river catchments implied by a set of river directions. Marks any loops. Renumbers catchments by size.\\
Cumulative Flow Gen. Alg. &Generates the total number of cells flowing (directly or indirectly) to each cell for a set of river directions. This is `dry' measure for the size/importance of rivers. Marks any loops. \\
Parameter Generation Code & Code that generates the flow parameters (water residency times) for each cell. This code is adapted from the originally code written by Stefan Hagemann. \\
FLOW Upscaling Algorithm & An alternative upscaling algorithm that performs better at low resolutions but requires non-local flows.\\
Orography Upscaling Algorithm &An algorithm that generates a hydrologically corrected coarse orography from a fine orography by considering the height of rim points within each coarse cell. \\
Basin Analysis Algorithm & An algorithm that analyses lake basins and produces the order with which surrounding cells would inundate as the size of the lake grew along with the quantity of water needed for each such expansion. \\
\hline
\end{longtable}
\label{table-tools-descs}
\end{center}}

At the moment the hydrological buffering effect of lakes is not being accounted for in the flow parameters generated. This differs from JSBACH3 and earlier r2b4 HD parameters files where it was accounted for. This effect will hopefully be turned back on soon.

\subsection{Procedure for Low Resolutions Without Internal Sinks}
\noindent\textbf{Tested for: r2b3, r2b4, r2b5, r2b6}

\noindent Low resolution ICON river directions (from r2b3 to r2b6) without any internal basins are generated by combining the river directions for Australia, South America and Africa from the HydroSheds database (as noted above this database doesn't extend above 60 \degree N) with river direction derived from a carefully corrected orography originally generated for work on dynamic river directions in the context of PalMod (see \cite{gmd-11-4291-2018}) on a 10 minute grid latitude-longitude grid before cross-grid upscaling to the appropriate ICON grid using the COTAT+ algorithm. (The river direction produced by this corrected orography have previously been evaluated against the old JSBACH3 river directions for the present day, the HydroBasins database and various other sources of geographical information.) Figure \ref{fig-low-res-icon-proc} shows a flow diagram of the procedure. \newline

\begin{figure}
\includegraphics[angle=90,width=\textwidth,height=0.98\textheight]{low_res_icon_proc.pdf}
\caption{Flow diagram of the procedure for coarse resolutions without internal sinks.}
\label{fig-low-res-icon-proc}
\end{figure}

\noindent\textbf{Prerequisites:} HydroSheds 30 second river directions and accumulated flows for Australia, Africa and South America, corrected global 10 minute orography, binary ICON icosahedral grid land-sea for target resolution, ICON icosahedral grid orography for target resolution

 \customstep{Upscaling 10 minute river direction for Australia, South America and Africa from HydroSheds.} The downloaded HydroSheds files with the river direction and accumulated flow on a 30 second grid are combined in a GIS package and then exported. Pseudo-coastline is added across the bottom edge of central America and across the join between Africa and the Arabian Peninsular/Asia.  This set of river directions is then upscaled using the COTAT+ algorithm to a 10 minute latitude-longitude grid.
\customstep[step-gen-10min]{Generating 10 minute river direction without internal basins for the entire global using a corrected orography.} River directions are generated for the entire globe using a river carving algorithm (similar to running a sink filling algorithm then a river direction determination algorithm but giving better directions inside of removed internal basins) as described in \cite{gmd-11-4291-2018} from the present day ICE5G DEM \cite{Peltier:2004aa} on a 10 minute resolution with the set of corrections applied that were derived for the dynamic hydrological discharge model\cite{gmd-11-4291-2018}. All internal basins were automatically removed by this process. These river directions will be generated using the r2b4 mask downscaled to the 10 minute latitude-longitude grid.
\customstep[step-splice]{Merge these two sets of 10 minute river directions.} Use the upscaled HydroSheds directions wherever they exist and are not an ocean point or outflow. Fill all other points with the directions derived from the corrected orography. Remove any river directions that are in the ocean according to the downscaled r2b4 mask. \customstep[step-remove-int-basins]{Replace all internal drainage basins with the river directions from the corrected orography for the corresponding area.} All the internal drainage basins will be in regions where the HydroSheds directions are being used. Replacing the with the river directions from the corrected orography will always result in river pathways that flow to the ocean.
\customstep[step-trace-paths]{Trace a path downstream to the sea from each cell marked as part of a loop in the cumulative flow field and replace these paths exclusively with the river directions from the corrected orography.}
First the accumulated flow and catchments are generated from the river directions resulting from the last intermediate step. Then for each cell marked as part of a loop in the cumulative flow trace the path downstream to the sea from that cell in the river directions from corrected orography. Mark all of these cells including the loop cells themselves then replace all of the cells marked in the intermediate river directions from the last step with the river directions from the corrected orography. This ensure (almost) all loops are removed.\footnote{It is possible some loops will still need to removed from the intermediate river directions by hand after this step before proceeding to the next step.} 
\customstep[step-upscale]{Upscale the intermediate river directions as produced above to the desired ICON icosahedral grid using a cross-grid version of the COTAT+ upscaling algorithm.} First generate the necessary diagnostic fields from the intermediate 10 minute river directions (specifically cumulative flow but also the catchments which will be needed in the next step). Then use the cross grid version of the COTAT+ upscaling algorithm to perform the upscaling and remove any simple loops.
\customstep{Run the loop remover to remove any complex loops from the upscaled icosahedral ICON river directions.} This requires both the upscaled icosahedral river directions and the 10 minute river direction as well as the catchments of the icosahedral river directions and the catchments and accumulated flow of the 10 minute latitude-longitude river directions. First generate the catchments for the icosahedral river directions then perform the loop removal. Finally generate the new catchments for the icosahedral river directions and check all loops have been removed.
\customstep[step-gen-flow-para]{Generate the flow parameter and create a hd para file.} Take the river direction from the previous set and run the flow parameters generation code to generate the necessary flow parameters, covert the river directions to the necessary format and create a hdpara file to use as input to JSBACH4.

\subsection{Procedure for Low Resolutions With Internal Sinks} \label{sec-proc-low-res-with-internal-sinks}
\noindent\textbf{Tested for: r2b4}

\noindent The procedure for river direction for low resolution with some or all internal sink points included is similar to that outlined in the previous section but with a number of alterations. If only some (and not all) internal sinks points are to be kept then two different variants of this method exists, \textbf{A} and  \textbf{B}, as described below. (If all internal sinks are to be kept then both variants will produce the same result; it is thus recommended to use variant \textbf{A}  which is simpler.)  Figures \ref{fig-low-res-icon-proc-with-sinks} and \ref{fig-low-res-icon-proc-with-sinks-var} show flow diagrams of the two variants of the procedure. The alterations made to the procedure in the previous section are as follows:
\begin{itemize}
\item In step \ref{step-gen-10min} two sets of river directions are generated:
\begin{itemize} 
\item A set of river direction excluding all internal sinks (as previously).
 \item A set including all sinks or if only some internal basins are desired including only those sinks. For variant \textbf{A} sinks in Australia, Africa and South America are not required (regardless of whether all internal basins or just some are desired). For variant \textbf{B} all sinks (or all those for internal basins that are desired) are required both inside and outside these continents.
\end{itemize}
\item In step \ref{step-splice} the set of river directions including all or some sinks should be merged with the HydroSheds river directions.
\item If all internal sinks should be kept then step \ref{step-remove-int-basins} should be skipped. If only some internal basins should be kept then this step should be modified to remove all other sinks instead of all sinks. It is here the two variants differ:
\begin{description}
\item[Variant A] Internal basins are replaced with the set of river directions excluding all internal sinks. Whether rivers from removed internal basins flow to the sea or to another (non-removed) internal basin will depend on the route taken to the sea from the position of the basin in the set of river directions excluding all internal sinks; this is not justified scientifically however as a whole this option is simpler.
\item[Variant B] Internal basins are replaced with the set of river directions including some or all internal sinks. Rivers from removed internal basins will either flow to other internal basins or to the sea across the lowest point on the basins rim; this is scientifically justifiable however this option as a whole is more complex.
\end{description}
\item In step \ref{step-trace-paths} the set of river directions excluding all sinks should be used (as previously).
\end{itemize}

\begin{figure}
\includegraphics[angle=90,width=\textwidth,height=0.93\textheight]{low_res_icon_proc_with_sinks.pdf}
\caption{Flow diagram of variant \textbf{A} (see main text) of the procedure for coarse resolutions with internal sinks. If all internal sinks are to be kept the internal basin replacement tool makes no changes and returns the input combined river directions unchanged.}
\label{fig-low-res-icon-proc-with-sinks}
\end{figure}

\begin{figure}
\includegraphics[angle=90,width=\textwidth,height=0.93\textheight]{low_res_icon_proc_with_sinks_var.pdf}
\caption{Flow diagram of variant \textbf{B} (see main text) ofﬂ the procedure for coarse resolutions with internal sinks. If all internal sinks are to be kept the internal basin replacement tool makes no changes and returns the input combined river directions unchanged.}
\label{fig-low-res-icon-proc-with-sinks-var}
\end{figure}


\subsection{Procedure for High Resolutions Without Internal Sinks}
\noindent\textbf{Tested for: r2b9}

\noindent High resolution ICON river directions (currently r2b9, potentially r2b7 and r2b8\footnote{Resolutions higher than r2b9 would likely require work on parallelisation of the tools used.}) without any internal basins are created by filling in the depressions (sinks) in a r2b9 orography then generating river directions according to the line of steepest descent from each cell to its neighbours (the flat regions created by sink filling are handled such that water from these areas always reaches the sea). Figure \ref{fig-high-res-icon-proc} shows a flow diagram of the procedure. \newline

\begin{figure}
\includegraphics[angle=90,width=\textwidth,height=0.98\textheight]{high_res_icon_proc.pdf}
\caption{Flow diagram of the procedure for high resolutions without internal sinks.}
\label{fig-high-res-icon-proc}
\end{figure}

\noindent\textbf{Prerequisites:} Orography on Icon icosahedral grid at target resolution, Binary land-sea mask on Icon icosahedral grid at target resolution

\customstep{Fill all sinks point (depressions) in a high resolution orography.} A high resolution r2b9 orography is taken from expar. A sink filling algorithm is run on this orography to remove all sink/depressions. Use the provided  r2b9 land-sea mask.
\customstep{Generate river directions from the filled orography.} River directions are produced using the provided filled orography and the r2b9 land-sea mask according to a downslope routing. The river catchments are then computed from these river directions and checked by eye.
\customstep{Generate the flow parameter and create a hd para file.} Take the river direction from the previous set and run the flow parameters generation code to generate the necessary flow parameters, covert the river directions to the necessary format and create a hdpara file to use as input to JSBACH4.

\section{Instructions} \label{sec-instr}
\subsection{General Notes}

All the necessary tools are contained within the  \lstinline[style=bash_input]{DynamicHD} git repository and the \lstinline[style=bash_input]{parameter_generation_scripts} git submodule. Most of the tools are written in either C++ or Fortran 2003. The interface for these tools differs for data for ICON icosahedral grids and data on normal latitude-longitude grids. Tools for ICON icosahedral grids and cross-grid tools are called from the command line specifying settings, inputs and outputs via command line arguments. Tools for latitude-longitude grids are called from Python using f2py and Cython to call Fortran tools and C++ tools respectively. However the tools required for creating ICON \lstinline[style=bash_input]{HDpara.nc} are run automatically by bash shell scripts thus it should not be necessary to call these tools directly. Although in principle all these tools will work on Mistral the correct library paths and compiler options have not been set for this and thus they are currently limited to the linux system. 

\subsection{Instructions for Low Resolutions Without Internal Sinks}

\emph{Instructions are provided for the bash shell on the Linux desktop system.}

\begin{enumerate}
\item Choose an appropriate base directory (\lstinline[style=bash_input]|${base_directory_path}| for the scripting.
\begin{lstlisting}[style=bash_input,breaklines=true]
mkdir ${base_directory_path}
\end{lstlisting}
\item Download the DynamicHD git repository from github:
\begin{lstlisting}[style=bash_input,breaklines=true]
git clone https://github.com/ThomasRiddick/DynamicHD ${base_directory_path}/DynamicHD
\end{lstlisting}
\item Install the parameter generation scripts git submodule into the DynamicHD repository:
\begin{lstlisting}[style=bash_input,breaklines=true] 
cd ${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts
git clone git+ssh://login1.mpimet.mpg.de/home/mpim/m300468/workspace/Dynamic_HD_Code/Dynamic_HD_bash_scripts/parameter_generation_scripts
\end{lstlisting}

\item Load the necessary models. First unload any existing modules. Then load anaconda3, cdo, nco, and gcc/6.3.0

\begin{lstlisting}[style=bash_input,breaklines=true] 
module load anaconda3
module load cdo
module load nco
module load gcc/6.3.0
\end{lstlisting}


\item Create a working directory for the ICON HD parameter generation process and change to that directory:
\begin{lstlisting}[style=bash_input,breaklines=true] 
cd ${base_directory_path}
mkdir hdpara_gen_workdir
\end{lstlisting}

\item Copy the necessary fixed input data from the linux system (login1) into this working directory (replacing r2bX with the ICON resolution in question):

\begin{lstlisting}[style=bash_input,breaklines=true]
cd hdpara_gen_workdir 
scp username@login1.mpimet.mpg.de:/home/mpim/m300468/mk_ic_rdirs/icon_rdir_gen_top_level_config.cfg $(pwd)
scp username@login1.mpimet.mpg.de:/home/mpim/m300468/mk_ic_rdirs/icon_hdpara_generation_driver.cfg $(pwd)
scp username@login1.mpimet.mpg.de:/home/mpim/m300468/mk_ic_rdirs/corrected_orog_intermediary_ICE5G_and_tarasov_upscaled_srtm30plus_north_america_only_data_ALG4_sinkless_glcc_olson_lsmask_0k_20170517_003802_with_grid.nc $(pwd)
scp username@login1.mpimet.mpg.de:/home/mpim/m300468/mk_ic_rdirs/rdirs_hydrosheds_au_af_sa_upscaled_10min_20200203_163646_corrg.nc $(pwd) 
\end{lstlisting}
\item Prepare a python environment for the scripts run (this will take some minutes to run):
\begin{lstlisting}[style=bash_input,breaklines=true]
${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts/regenerate_conda_environment.sh 
source activate dyhdenv
\end{lstlisting}
\item Edit the files \lstinline[style=bash_input]{icon_rdir_gen_top_level_config.cfg} and \lstinline[style=bash_input]{icon_hdpara_generation_driver.cfg} such that all paths are correct for your system (and all field names match those used in the input files):

\begin{lstlisting}[style=bash_input,breaklines=true]
vim icon_rdir_gen_top_level_config.cfg
vim icon_hdpara_generation_driver.cfg 
\end{lstlisting}

\item Run the main script:
\begin{lstlisting}[style=bash_input,breaklines=true]
${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts/generate_icon_hdpara_top_level_driver.sh input_icon_orography.nc  input_icon_maximum_land_mask.nc  output_icon_hdpara.nc output_icon_catchments.nc output_icon_cumulative_flow_file.nc icon_rdir_gen_top_level_config.cfg $(pwd) input_icon_gridfile.nc ${base_directory_path}/DynamicHD/Dynamic_HD_Resources/cotat_plus_standard_params.nl true
\end{lstlisting}
\end{enumerate}
The script will produce a number of files. The key output file is the icon hdpara file  \lstinline[style=bash_input]{output_icon_hdpara.nc} for input into the ICON model. Also important are the catchments for the generated river directions on the ICON grid in  \lstinline[style=bash_input]{output_icon_catchments.nc} and the cumulative flows for the generated river directions on the ICON grid in \lstinline[style=bash_input]{output_icon_cumulative_flow_file.nc}.  The command line arguments are as follows:
\begin{description}
\item[input\_orography\_filepath] Input file containing an orography on the ICON grid. This is only used to generate flow parameters and not for river directions.
\item[input\_ls\_mask\_filepath] Input file containing a binary land-sea mask on the ICON grid. In this mask land have the value $1$ and sea should have the value $0$.
\item[output\_hdpara\_filepath] Target filepath for the final ICON hdpara file produced by this script.
\item[output\_catchments\_filepath] Target filepath for the final catchments (on the ICON grid) of the ICON river directions created.
\item[output\_accumulated\_flow\_filepath]  Target filepath for the final cumulative flow (on the ICON grid) of the ICON river directions created.
\item[config\_filepath] A file specifying options for the top level bash script.
\item[working\_directory] Working directory to run this script in and place temporary files in. Multiple copies of this script cannot be run with the same working directory simultaneously. 
\item[grid\_file] The grid file describing the ICON grid to create an hdpara file for.
\item[cotat\_params\_file] Upscaling parameters for the upscaling algorithm. An appropriate file is provided: \lstinline[style=bash_input]{DynamicHD/Dynamic_HD_Resources/cotat_plus_standard_params.nl}
\item[compilation\_required]  Flag for compilation. Needs to be set to \lstinline[style=bash_input]{true} the first time you run but you can later set it to \lstinline[style=bash_input]{false} to make the script run quicker
\item[true\_sinks\_filepath (optional)] A file containing the position of false sinks to use on a 10min lat-lon grid. Not required when removing all internal basins.
\end{description}

Once an ICON hdpara file has been created a check should be made that the final mask matches the original input mask. This can be done using:
\begin{lstlisting}[style=bash_input,breaklines=true]
cdo expr,'lsm=(MASK==1 || MASK==2)' output_icon_hdpara.nc mask_from_para.nc
cdo diff mask_from_para.nc input_ls_mask_filepath.nc
\end{lstlisting} 
This should result in zero differences.

The main routines of the script can be examined in:

\lstinline[style=bash_input]{DynamicHD/Dynamic_HD_bash_scripts/generate_icon_hdpara_top_level_driver.sh}

and 

\lstinline[style=bash_input]{DynamicHD/Dynamic_HD_Scripts/Dynamic_HD_Scripts/create_icon_coarse_river_directions_driver.py}


\subsection{Instructions for Low Resolutions With Internal Sinks}

Apart from a number of alterations detailed below the same instructions should be followed as for low resolutions without internal sinks. The alterations required are as follows:
\begin{itemize} 
\item Endorheic/internal basins for Europe, Asia and North America can be added by providing a true sinks file with the desired sink points flagged.  Internal basin are added by finding the lowest point of the depression the basin occupies in the 10min latitude-longitude orography \lstinline[style=bash_input]{corrected_orog_intermediary_ICE5G_and_tarasov_upscaled_srtm30plus_north_america_only_data_ALG4_sinkless_glcc_olson_lsmask_0k_20170517_003802_with_grid.nc} and putting a \lstinline[style=bash_input]{true} (value $1$) flag there in the true sinks file. All other points in this file are set to  \lstinline[style=bash_input]{false} (value $0$). The file path to true sinks file, \lstinline[style=bash_input]{true_sinks_filepath}, is set as a final additional optional argument to \lstinline[style=bash_input]{generate_icon_hdpara_top_level_driver.sh.} (as specified in the previous section).

\item Which internal basins are kept from the Hydrosheds river directions can be adjusted by setting a list of either catchments to include or exclude in \lstinline[style=bash_input]{icon_hdpara_generation_driver.cfg} using respectively either the variable  \lstinline[style=bash_input]{replace_only_catchments} (in which case only these catchments are replaced) or the variable \lstinline[style=bash_input]{exclude_catchments} (in which case these internal basins are kept and all others are replaced). The list should be of the numbers of the catchments (as taken from the \lstinline[style=bash_input]{ten_minute_catchments_temp.nc} produced by a preliminary run of the script with \lstinline[style=bash_input]{keep_all_internal_basins} set to \lstinline[style=bash_input]{True}) and each number should be separated by a comma. Only one of these two variables should be specified in any given configuration. Alternatively if you want to keep all the internal basins from the Hydrosheds river direction the variable \lstinline[style=bash_input]{keep_all_internal_basins} should be set to \lstinline[style=bash_input]{True}; otherwise this variable should be set to \lstinline[style=bash_input]{False}.  

\item How endorheic catchments that are removed are replaced depends on which variant is being used (see section \ref{sec-proc-low-res-with-internal-sinks} for a description of the differences). Variant \textbf{A} (where water is redirected the water towards the sea)  is selected by setting \lstinline[style=bash_input]{replace_internal_basins_with_rdirs_with_truesinks=False}. Variant \textbf{B} is selected by setting \lstinline[style=bash_input]{replace_internal_basins_with_rdirs_with_truesinks=True}. In variant \textbf{B} desired true sink point should also be specified in Africa, Australia and South America (using the same file as for other regions). These can be meaningfully specified even when within an internal catchment for which the Hydrosheds river direction are being used (i.e. an internal catchment that has been 'kept') as although the Hydrosheds river direction are used for the catchment itself flagged true sinks can be used to reconnect other minor endorheic catchments with the given internal catchment in a logical way (i.e. across the lowest rims of basins). 
\end{itemize}
\subsection{Instructions for High Resolutions Without Internal Sinks}

\emph{Instructions are provided for the bash shell on the Linux desktop system.}

\begin{enumerate}

\item Choose an appropriate base directory (\lstinline[style=bash_input]|${base_directory_path}| for the scripting:
\begin{lstlisting}[style=bash_input,breaklines=true]
mkdir ${base_directory_path}
\end{lstlisting}
\item Download the DynamicHD git repository from github:
\begin{lstlisting}[style=bash_input,breaklines=true]
git clone https://github.com/ThomasRiddick/DynamicHD ${base_directory_path}/DynamicHD
\end{lstlisting}
\item Install the parameter generation scripts git submodule into the DynamicHD repository:
\begin{lstlisting}[style=bash_input,breaklines=true] 
cd ${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts
git clone git+ssh://login1.mpimet.mpg.de/home/mpim/m300468/workspace/Dynamic_HD_Code/Dynamic_HD_bash_scripts/parameter_generation_scripts 
\end{lstlisting}
\item Create a working directory for the ICON HD parameter generation process and change to that directory:
\begin{lstlisting}[style=bash_input,breaklines=true] 
cd ${base_directory_path}
mkdir hdpara_gen_workdir
\end{lstlisting}
\item Copy an orography, grid file and land-sea mask for the desired resolution to the working directory:
\begin{lstlisting}[style=bash_input,breaklines=true] 
cp /path/to/orography_r2bX.nc ${base_directory_path}/hdpara_gen_workdir/orography_r2bX.nc 
cp /path/to/landsea_mask_r2bX.nc ${base_directory_path}/hdpara_gen_workdir/landsea_mask_r2bX.nc
cp gridfile_r2bX.nc ${base_directory_path}/hdpara_gen_workdir/gridfile_r2bX.nc
\end{lstlisting}
\item Edit paths in the script \lstinline[style=bash_input]{generate_fine_icon_rdirs}:
\begin{lstlisting}[style=bash_input,breaklines=true] 
vim ${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts/generate_fine_icon_rdirs
\end{lstlisting}
Set:
\begin{lstlisting}[style=bash_input,breaklines=true] 
icon_data_dir=${base_directory_path}/hdpara_gen_workdir/
cpp_icon_tool_dir=${base_directory_path}/DynamicHD/Dynamic_HD_Cpp_Code/Release
grid_file=${icon_data_dir}/gridfile_r2bX.nc
orography_file=${icon_data_dir}/orography_r2bX.nc
lsmask_file=${icon_data_dir}/landsea_mask_r2bX.nc
true_sinks_file=${icon_data_dir}/true_sinks_r2bX.nc
output_orography_file=${icon_data_dir}/orography_r2bX_filled.nc
next_cell_index_file=${icon_data_dir}/rdirs_r2bX.nc
catchments_file=${icon_data_dir}/catchments_r2bX.nc
 \end{lstlisting}
 \item Edit other settings in the script \lstinline[style=bash_input]{generate_fine_icon_rdirs}. Set the field names of required fields in the input files:
\begin{lstlisting}[style=bash_input,breaklines=true]
input_orography_fieldname="z"
input_lsmask_fieldname="cell_sea_land_mask"
input_true_sinks_fieldname="true_sinks"
\end{lstlisting}
(Replacing  \lstinline[style=bash_input]{"z", "cell_sea_land_mask"} and  \lstinline[style=bash_input]{"true_sinks"} as appropriate.) Also set the flag for fractional land-sea mask usage to the false value (which is in this case 0):
\begin{lstlisting}[style=bash_input,breaklines=true]
fractional_lsmask_flag=0 
\end{lstlisting}
\item Run the river direction generation script:
\begin{lstlisting}[style=bash_input,breaklines=true]
cd ${base_directory_path}/hdpara_gen_workdir/
${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts/generate_fine_icon_rdirs
\end{lstlisting}
\item Run the parameter generation script:
\begin{lstlisting}[style=bash_input,breaklines=true]
${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts/parameter_generation_scripts/generate_icon_hd_file_driver.sh ${base_directory_path}/hdpara_gen_workdir/ ${base_directory_path}/DynamicHD/Dynamic_HD_bash_scripts/parameter_generation_scripts/fortran ${base_directory_path}/hdpara_gen_workdir/ ${base_directory_path}/hdpara_gen_workdir/gridfile_r2bX.nc ${base_directory_path}/hdpara_gen_workdir/landsea_mask_r2bX.nc ${base_directory_path}/hdpara_gen_workdir/rdirs_r2bX.nc ${base_directory_path}/hdpara_gen_workdir/orography_r2bX_filled.nc
\end{lstlisting} 
The command line arguments are as follows:
\begin{description}
\item[workdir] Working directory to use for running the script.
\item[fortran\_src\_dir] Directory containing the Fortran code for parameter generations; this is usually a subdirectory of  \lstinline[style=bash_input]{DynamicHD/Dynamic_HD_bash_scripts/parameter_generation_scripts} named \lstinline[style=bash_input]{fortran}.
\item[base\_data\_dir] Prefix to add to paths to input and output files.
\item[grid\_file] Input file containing ICON grid parameters.
\item[lsmasks\_file] Input file containing binary land-sea mask.
\item[rdirs\_file] Intermediary file produced by the previous step containing river direction in the form of indices to the next cell downstream.
\item[orography\_file] Intermediary file produced by the previous step containing the filled orography.
\end{description}
The final \lstinline[style=bash_input]{hdpara.nc} file will be produced by this step. It will be named \lstinline[style=bash_input]{hdpara_icon.nc}
\item The initial reservoirs values (\lstinline[style=bash_input]{hdstart.nc} file) can be generated using the  script \lstinline[style=bash_input]{create_icon_hdstart} included in JSBACH4 in \lstinline[style=bash_input]{scripts/preprocessing}. The initial reservoirs will be interpolated from a given MPI-ESM \lstinline[style=bash_input]{hdpara.nc}.   The follow variables need to set at the top of the script:
\begin{description}
\item[latlon\_initial\_file] This should be a \lstinline[style=bash_input]{hdstart.nc} file for MPI-ESM (JSBACH3) for the relevant starting data from which the JSBACH4 file can be interpolated.
\item[grid\_file] The grid files for the relevant ICON grid.
\item[landsea\_file] The land-sea mask file for the relevant ICON grid.
\item[landsea\_field] The name of the land-sea mask field in the land-sea mask file.
\item[label] The label to attach to the output \lstinline[style=bash_input]{hdstart.nc} file.
\end{description}
The output file produced by this will be named \lstinline[style=bash_input]{hdrestart_[label].nc}
\end{enumerate}

\section{Planned Future Additions to Documentation (i.e. a to-do list)}

\begin{itemize}
\item Fraction land-sea masks for low resolutions
\item Parameter adjustment
\item Solving by hand of loops on edges etc
\item Resolve overflowing lines
\item git switch to known version number
\end{itemize}


\bibliography{ICON_HD_Parameter_Generation_Instructions}{}
\bibliographystyle{plain}

\end{document}
