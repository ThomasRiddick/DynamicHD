module latlon_hd_and_lake_model_test_mod
use fruit
implicit none

contains

    subroutine setup
    end subroutine setup

    subroutine teardown
    end subroutine teardown

subroutine testHdModel
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod

   type(riverparameters), pointer :: river_parameters
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer :: overland_reservoir_nums
   integer,dimension(:,:), pointer :: base_reservoir_nums
   real(dp)   ,dimension(:,:), pointer :: river_retention_coefficients
   real(dp)   ,dimension(:,:), pointer :: overland_retention_coefficients
   real(dp)   ,dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   real(dp)   ,dimension(:,:), pointer :: drainage
   real(dp)   ,dimension(:,:,:), pointer :: drainages
   real(dp)   ,dimension(:,:,:), pointer :: runoffs
   real(dp)   ,dimension(:,:), pointer :: expected_water_to_ocean
   real(dp)   ,dimension(:,:), pointer :: expected_river_inflow
   real(dp)   ,dimension(:,:), pointer :: flow_directions
   type(prognostics), pointer :: global_prognostics_ptr
   integer :: timesteps, i
      timesteps = 200
      allocate(flow_directions(4,4))
      flow_directions = transpose(reshape((/ 2.0, 2.0, 2.0, 2.0, &
                                   4.0, 6.0, 2.0, 2.0, &
                                   6.0, 6.0, 0.0, 4.0, &
                                   9.0, 8.0, 8.0, 7.0 /), &
                                  (/4,4/)))
      allocate(river_reservoir_nums(4,4))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(4,4))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(4,4))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(4,4))
      river_retention_coefficients(:,:) = 0.7
      allocate(overland_retention_coefficients(4,4))
      overland_retention_coefficients(:,:) = 0.5
      allocate(base_retention_coefficients(4,4))
      base_retention_coefficients(:,:) = 0.1
      allocate(landsea_mask(4,4))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(3,3) = 0
      overland_reservoir_nums(3,3) = 0
      base_reservoir_nums(3,3) = 0
      landsea_mask(3,3) = .True.
      river_parameters => riverparameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(4,4,1,1,5)
      allocate(drainage(4,4))
      drainage = transpose(reshape((/ &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 1.0, 0.0, 1.0, &
         1.0, 1.0, 1.0, 1.0 /), &
         (/4,4/)))
      allocate(drainages(4,4,timesteps))
      allocate(runoffs(4,4,timesteps))
      do i = 1,timesteps
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = drainage(:,:)
      end do
      allocate(expected_water_to_ocean(4,4))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 30.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_river_inflow(4,4))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         2.0, 2.0, 6.0, 6.0, &
         0.0, 6.0, 0.0, 8.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      call init_hd_model_for_testing(river_parameters,river_fields,using_lakes=.False.)
      call run_hd_model(timesteps,runoffs,drainages)
      global_prognostics_ptr => get_global_prognostics()
      call assert_equals(global_prognostics_ptr%river_fields%water_to_ocean, &
                         expected_water_to_ocean,4,4)
      call assert_equals(global_prognostics_ptr%river_fields%river_inflow,&
                         expected_river_inflow,4,4)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoffs)
      deallocate(expected_water_to_ocean)
      deallocate(expected_river_inflow)
      call clean_hd_model()
end subroutine testHdModel

subroutine testLakeModel1
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only : add_offset
   type(riverparameters), pointer :: river_parameters
   type(riverprognosticfields), pointer:: river_fields
   type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp)   ,dimension(:,:), pointer :: flow_directions
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer :: overland_reservoir_nums
   integer,dimension(:,:), pointer :: base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp), pointer, dimension(:,:) :: initial_spillover_to_rivers
   real(dp), pointer, dimension(:,:) :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   real(dp) :: step_length
   integer :: nlat,nlon
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: timesteps
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   integer :: flood_index
      step_length = 86400.0_dp
      timesteps = 1000
      nlat = 9
      nlon = 9
      nlat_coarse = 3
      nlon_coarse = 3
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ &
                                  -2,6,2, &
                                   8,7,2, &
                                   8,7,0 /), &
                                    (/3,3/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.7
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.5
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.1
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      river_reservoir_nums(3,3) = 0
      overland_reservoir_nums(3,3) = 0
      base_reservoir_nums(3,3) = 0
      landsea_mask(:,:) = .False.
      landsea_mask(3,3) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(3,3,1,1,5)
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False.,  .True., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds(:,:) = -1.0
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, 80.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, 80.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0,  1.0, 80.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, 10.0, 10.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, 10.0, 10.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 4, 2, 0, 0, 0, 0, 0, &
         0, 0, 5, 5, 0, 0, 0, 0, 0, &
         0, 0, 4, 3, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 4, 4, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index = transpose(reshape((/ &
                                                            0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                           0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
                                                           (/nlon,nlat/)))
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index = transpose(reshape((/ &
                                                                0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0, &
                                                               0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
                                                               (/nlon,nlat/)))
      flood_index = 1
      secondary_merge => &
                    mergeandredirectindices(.false., &
                                            .false., &
                                            1,5, &
                                            1,3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                             secondary_merge)
      allocate(flood_merge_and_redirect_indices_collections(1))
      flood_merge_and_redirect_indices_collections(1)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(1,4) = flood_index
      connect_merge_and_redirect_indices_collections => null()
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(nlat_coarse,nlon_coarse))
      drainage = transpose(reshape((/ &
         1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, &
         1.0, 1.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(runoff(nlat_coarse,nlon_coarse))
      runoff = transpose(reshape((/ &
         1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, &
         1.0, 1.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(drainages(nlat_coarse,nlon_coarse,timesteps))
      allocate(runoffs(nlat_coarse,nlon_coarse,timesteps))
      do i = 1,timesteps
        drainages(:,:,i) = drainage(:,:)/step_length
        runoffs(:,:,i) = runoff(:,:)/step_length
      end do
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers(:,:) = 0.0
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers(:,:) = 0.0
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  2.0, &
         4.0, 0.0, 14.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_river_inflow = expected_river_inflow/step_length
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0, 16.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_ocean = expected_water_to_ocean/step_length
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 10.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/step_length
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
                  0.0,  0.0,  0.0,  80.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  0.0,  80.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  80.0, 80.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  80.0, 80.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  80.0, 80.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  0.0,   0.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  0.0,   0.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  0.0,   0.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
                  0.0,  0.0,  0.0,   0.0, 0.0, 0.0, 0.0, 0.0,  0.0 /), &
                  (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 0.0,1.0/3.0,0.0, &
                 0.2,    0.2,0.0, &
                 0.0,    0.0,0.0 /), &
                  (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               0,2,0, &
               3,3,0, &
               0,0,0 /), &
                  (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               6,6,6, &
              15,15,15, &
               6,6,6 /), &
                  (/3,3/)))
      allocate(expected_lake_volumes(1))
      expected_lake_volumes(1) = 80.0
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(timesteps,runoffs,drainages)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,9
        do j = 1,9
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
            if (lake_type == filling_lake_type) then
              lake_types(i,j) = 1
            else if (lake_type == overflowing_lake_type) then
              lake_types(i,j) = 2
            else if (lake_type == subsumed_lake_type) then
              lake_types(i,j) = 3
            else
              lake_types(i,j) = 4
            end if
          end if
        end do
      end do
      allocate(lake_volumes(1))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(expected_river_inflow,river_fields%river_inflow,3,3,0.0000000001_dp)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,3,3,0.0000000001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,3,3,0.00001_dp)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,9,9)
      call assert_equals(expected_lake_types,lake_types,9,9)
      call assert_equals(expected_diagnostic_lake_volumes,diagnostic_lake_volumes,9,9)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells,lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(diagnostic_lake_volumes)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel1

subroutine testLakeModel2
  use latlon_hd_model_interface_mod
  use latlon_hd_model_mod
  use latlon_lake_model_io_mod, only : add_offset
  type(riverparameters), pointer :: river_parameters
  type(riverprognosticfields), pointer :: river_fields
  type(lakeparameters),pointer :: lake_parameters
  type(lakefields), pointer :: lake_fields_out
  type(lakeprognostics), pointer :: lake_prognostics_out
  type(lakepointer) :: working_lake_ptr
  real(dp)   ,dimension(:,:), pointer :: flow_directions
  integer,dimension(:,:), pointer :: river_reservoir_nums
  integer,dimension(:,:), pointer :: overland_reservoir_nums
  integer,dimension(:,:), pointer :: base_reservoir_nums
  real(dp),dimension(:,:), pointer :: river_retention_coefficients
  real(dp),dimension(:,:), pointer :: overland_retention_coefficients
  real(dp),dimension(:,:), pointer :: base_retention_coefficients
  logical,dimension(:,:), pointer :: landsea_mask
  logical,dimension(:,:), pointer :: lake_centers
  real(dp),dimension(:,:), pointer :: connection_volume_thresholds
  real(dp),dimension(:,:), pointer :: flood_volume_thresholds
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
  integer,dimension(:,:), pointer :: flood_next_cell_lat_index
  integer,dimension(:,:), pointer :: flood_next_cell_lon_index
  integer,dimension(:,:), pointer :: connect_next_cell_lat_index
  integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
  real(dp),dimension(:,:), pointer :: drainage
  real(dp),dimension(:,:,:), pointer :: drainages
  real(dp),dimension(:,:), pointer :: runoff
  real(dp),dimension(:,:,:), pointer :: runoffs
  real(dp), pointer, dimension(:,:) :: initial_spillover_to_rivers
  real(dp), pointer, dimension(:,:) :: initial_water_to_lake_centers
  real(dp),dimension(:,:), pointer :: expected_river_inflow
  real(dp),dimension(:,:), pointer :: expected_water_to_ocean
  real(dp),dimension(:,:), pointer :: expected_water_to_hd
  integer,dimension(:,:), pointer :: expected_lake_numbers
  integer,dimension(:,:), pointer :: expected_lake_types
  real(dp),dimension(:), pointer :: expected_lake_volumes
  real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
  real(dp), dimension(:,:), pointer :: expected_lake_fractions
  integer , dimension(:,:), pointer :: expected_number_lake_cells
  integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
  integer,dimension(:,:), pointer :: lake_types
  real(dp),dimension(:), pointer :: lake_volumes
  real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
  real(dp), dimension(:,:), allocatable :: lake_fractions
  integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
  integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
  type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
   connect_merge_and_redirect_indices_collections
  type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
   flood_merge_and_redirect_indices_collections
  type(mergeandredirectindicescollection), pointer :: collected_indices
  type(mergeandredirectindices), pointer :: primary_merge
  type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
  type(mergeandredirectindices), pointer :: secondary_merge
  real(dp) :: step_length
  integer :: nlat,nlon
  integer :: nlat_coarse,nlon_coarse
  integer :: nlat_surface_model,nlon_surface_model
  integer :: timesteps
  integer :: lake_number
  integer :: i,j
  logical :: instant_throughflow_local
  real(dp) :: lake_retention_coefficient_local
  integer :: lake_type
  integer :: flood_index
    step_length = 86400.0_dp
    timesteps = 10000
    nlat = 20
    nlon = 20
    nlat_coarse = 4
    nlon_coarse = 4
    nlat_surface_model = 3
    nlon_surface_model = 3
    allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
    allocate(flow_directions(nlat_coarse,nlon_coarse))
    flow_directions = transpose(reshape((/ -2, 4, 2, 2, &
                                            6,-2,-2, 2, &
                                            6, 2, 3,-2, &
                                           -2, 0, 6, 0 /), &
                                          (/nlon_coarse, &
                                            nlat_coarse/)))
    allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
    river_reservoir_nums(:,:) = 5
    allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
    overland_reservoir_nums(:,:) = 1
    allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
    base_reservoir_nums(:,:) = 1
    allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
    river_retention_coefficients(:,:) = 0.7
    allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
    overland_retention_coefficients(:,:) = 0.5
    allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
    base_retention_coefficients(:,:) = 0.1
    allocate(landsea_mask(nlat_coarse,nlon_coarse))
    landsea_mask(:,:) = .False.
    river_reservoir_nums(4,4) = 0
    overland_reservoir_nums(4,4) = 0
    base_reservoir_nums(4,4) = 0
    landsea_mask(4,4) = .True.
    river_reservoir_nums(4,2) = 0
    overland_reservoir_nums(4,2) = 0
    base_reservoir_nums(4,2) = 0
    landsea_mask(4,2) = .True.
    river_parameters => RiverParameters(flow_directions, &
                                        river_reservoir_nums, &
                                        overland_reservoir_nums, &
                                        base_reservoir_nums, &
                                        river_retention_coefficients, &
                                        overland_retention_coefficients, &
                                        base_retention_coefficients, &
                                        landsea_mask)
    river_fields => riverprognosticfields(4,4,1,1,5)
    allocate(lake_centers(nlat,nlon))
    lake_centers = transpose(reshape((/ &
        .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,  &
                .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
       (/nlon,nlat/)))
    allocate(connection_volume_thresholds(nlat,nlon))
    connection_volume_thresholds = transpose(reshape((/ &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0, 186.0, 23.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, 56.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0 &
       /), &
       (/nlon,nlat/)))
    allocate(flood_volume_thresholds(nlat,nlon))
    flood_volume_thresholds = transpose(reshape((/ &
       -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
              -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
       0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0, 111.0, 111.0, 56.0, &
            111.0,   -1.0,    -1.0,   -1.0, 2.0, &
       -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,   1.0,   1.0, 56.0, &
            56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,   0.0,   1.0,  1.0, &
            26.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,   1.0,   0.0,  1.0,  &
            26.0, 26.0, 111.0,   -1.0,  -1.0, &
       16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0,   0.0,   0.0,   1.0,  1.0, &
             1.0, 26.0,  56.0,   -1.0,  -1.0, &
       -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,   0.0,   1.0,  1.0, &
             1.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,   1.0,   1.0,  1.0, &
            26.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,  56.0,  56.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
             0.0,  3.0,   3.0, 10.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
             0.0,  3.0,   3.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
       (/nlon,nlat/)))
    allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,2.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
    allocate(flood_next_cell_lat_index(nlat,nlon))
    flood_next_cell_lat_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
       2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
       -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
       -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
       -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
       7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
       -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
       -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    allocate(flood_next_cell_lon_index(nlat,nlon))
    flood_next_cell_lon_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
       19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
       -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
       -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
       -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
       2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
       -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
       -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    allocate(connect_next_cell_lat_index(nlat,nlon))
    connect_next_cell_lat_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    allocate(connect_next_cell_lon_index(nlat,nlon))
    connect_next_cell_lon_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    call add_offset(flood_next_cell_lat_index,1,(/-1/))
    call add_offset(flood_next_cell_lon_index,1,(/-1/))
    call add_offset(connect_next_cell_lat_index,1,(/-1/))
    call add_offset(connect_next_cell_lon_index,1,(/-1/))
    instant_throughflow_local=.True.
    lake_retention_coefficient_local=0.1_dp
    allocate(corresponding_surface_cell_lat_index(nlat,nlon))
    corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
    allocate(corresponding_surface_cell_lon_index(nlat,nlon))
    corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
    allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
    connect_merge_and_redirect_indices_index(:,:) =0
    allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
    flood_merge_and_redirect_indices_index(:,:) = 0
    allocate(flood_merge_and_redirect_indices_collections(9))
    connect_merge_and_redirect_indices_collections=> null()
    flood_index = 1
    primary_merge => &
    mergeandredirectindices(.true.,&
                            .false., &
                            6, &
                            2, &
                            1, &
                            0)
    allocate(primary_merges(1))
    primary_merges(1)%ptr => primary_merge
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          null())
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(3,16) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    8, &
                                    18, &
                                    1, &
                                    3)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(4,6) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .true., &
                                    6, &
                                    10, &
                                    7, &
                                    14)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(5,8) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .true., &
                                    7, &
                                    14, &
                                    7, &
                                    14)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(6,12) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    6, &
                                    4, &
                                    1, &
                                    0)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(8,2) = flood_index
    flood_index = flood_index + 1
    primary_merge => &
      mergeandredirectindices(.true., &
                              .true., &
                              6, &
                              8, &
                              6, &
                              5)
    allocate(primary_merges(1))
    primary_merges(1)%ptr => primary_merge
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          null())
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(8,17) = flood_index
    flood_index = flood_index + 1
    primary_merge => &
      mergeandredirectindices(.true., &
                              .true., &
                              7, &
                              12, &
                              5, &
                              13)
    allocate(primary_merges(1))
    primary_merges(1)%ptr => primary_merge
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          null())
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(9,15) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    16, &
                                    15, &
                                    3, &
                                    3)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(14,19) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    17, &
                                    3, &
                                    3, &
                                    1)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(16,4) = flood_index
    do i = 1,size(flood_merge_and_redirect_indices_collections)
      collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
      call collected_indices%add_offset_to_collection(1)
    end do
    lake_parameters => LakeParameters(lake_centers, &
                                      connection_volume_thresholds, &
                                      flood_volume_thresholds, &
                                      cell_areas_on_surface_model_grid, &
                                      flood_next_cell_lat_index, &
                                      flood_next_cell_lon_index, &
                                      connect_next_cell_lat_index, &
                                      connect_next_cell_lon_index, &
                                      connect_merge_and_redirect_indices_index, &
                                      flood_merge_and_redirect_indices_index, &
                                      connect_merge_and_redirect_indices_collections, &
                                      flood_merge_and_redirect_indices_collections, &
                                      corresponding_surface_cell_lat_index, &
                                      corresponding_surface_cell_lon_index, &
                                      nlat,nlon, &
                                      nlat_coarse,nlon_coarse, &
                                      nlat_surface_model,nlon_surface_model, &
                                      instant_throughflow_local, &
                                      lake_retention_coefficient_local)
    allocate(drainage(nlat_coarse,nlon_coarse))
    drainage = transpose(reshape((/ &
       1.0, 1.0, 1.0, 1.0, &
       1.0, 1.0, 1.0, 1.0, &
       1.0, 1.0, 1.0, 1.0, &
       1.0, 0.0, 1.0, 0.0 /), &
       (/nlon_coarse,nlat_coarse/)))
    allocate(runoff(nlat_coarse,nlon_coarse))
    runoff = transpose(reshape((/ &
       1.0, 1.0, 1.0, 1.0, &
       1.0, 1.0, 1.0, 1.0, &
       1.0, 1.0, 1.0, 1.0, &
       1.0, 0.0, 1.0, 0.0  /), &
       (/nlon_coarse,nlat_coarse/)))
    allocate(drainages(nlat_coarse,nlon_coarse,timesteps))
    allocate(runoffs(nlat_coarse,nlon_coarse,timesteps))
    do i = 1,timesteps
      drainages(:,:,i) = drainage(:,:)/step_length
      runoffs(:,:,i) = runoff(:,:)/step_length
    end do
    allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
    initial_spillover_to_rivers(:,:) = 0.0
    allocate(initial_water_to_lake_centers(nlat,nlon))
    initial_water_to_lake_centers(:,:) = 0.0
    allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
    expected_river_inflow = transpose(reshape((/ &
        0.0, 0.0, 0.0, 0.0, &
       0.0, 0.0, 0.0, 2.0, &
       0.0, 2.0, 0.0, 0.0, &
       0.0, 0.0, 0.0, 0.0 /), &
       (/nlon_coarse,nlat_coarse/)))
    expected_river_inflow = expected_river_inflow/step_length
    allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
    expected_water_to_ocean = transpose(reshape((/ &
        0.0, 0.0, 0.0, 0.0, &
       0.0, 0.0, 0.0, 0.0, &
       0.0, 0.0, 0.0, 0.0, &
       0.0, 6.0, 0.0, 22.0 /), &
       (/nlon_coarse,nlat_coarse/)))
    expected_water_to_ocean = expected_water_to_ocean/step_length
    allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
    expected_water_to_hd = transpose(reshape((/ &
        0.0, 0.0, 0.0,  0.0, &
       0.0, 0.0, 0.0, 12.0, &
       0.0, 0.0, 0.0,  0.0, &
       0.0, 2.0, 0.0, 18.0 /), &
       (/nlon_coarse,nlat_coarse/)))
    expected_water_to_hd = expected_water_to_hd/step_length
    allocate(expected_lake_numbers(nlat,nlon))
    expected_lake_numbers = transpose(reshape((/ &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
       1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
       0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
       0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
       0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
       1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
       0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 0, 0, &
       0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
       (/nlon,nlat/)))
    allocate(expected_lake_types(nlat,nlon))
    expected_lake_types = transpose(reshape((/ &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    3, &
   3,    2,    3,    0,    0,    0,    0,    0,    0,    0,    0,    0,    2,    2,    2,    2,    0,    0,    0,    3, &
   0,    3,    3,    0,    0,    2,    2,    0,    0,    0,    0,    2,    2,    2,    2,    2,    0,    0,    0,    0, &
   0,    3,    3,    0,    0,    3,    3,    3,    3,    0,    0,    0,    3,    2,    2,    2,    2,    0,    0,    0, &
   0,    3,    3,    2,    3,    3,    0,    3,    3,    2,    2,    3,    2,    3,    2,    2,    2,    2,    0,    0, &
   3,    3,    3,    0,    3,    3,    3,    3,    3,    0,    2,    3,    3,    2,    2,    2,    2,    2,    0,    0, &
   0,    3,    3,    0,    0,    3,    0,    3,    0,    0,    0,    2,    3,    2,    2,    2,    2,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    2,    2,    2,    2,    2,    2,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    2,    2,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    2,    2,    2,    2,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    2,    2,    2,    0,    0, &
   0,    0,    0,    2,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0, &
   0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
       (/nlon,nlat/)))
    allocate(expected_diagnostic_lake_volumes(nlat,nlon))
    expected_diagnostic_lake_volumes = transpose(reshape((/ &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  430.0,&
                   430.0,430.0,430.0,0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  430.0,430.0,430.0,430.0,0.0,  0.0,  0.0,  430.0,&
                   0.0, 430.0,430.0,0.0,  0.0,  430.0,430.0, 0.0,  0.0,  0.0,  &
                   0.0, 430.0,430.0,430.0,430.0,430.0,0.0,   0.0,  0.0,  0.0,  &
                   0.0, 430.0,430.0,0.0,  0.0,  430.0,430.0, 430.0,430.0,0.0,  &
                   0.0, 0.0,  430.0,430.0,430.0,430.0,430.0, 0.0,  0.0,  0.0,  &
                   0.0, 430.0,430.0,430.0,430.0,430.0,0.0,   430.0,430.0,430.0,&
                   430.0,430.0,430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,  &
                   430.0,430.0,430.0,0.0,  430.0,430.0,430.0,430.0,430.0,0.0,  &
                   430.0,430.0,430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,   &
                   0.0,  430.0,430.0,0.0,  0.0,  430.0,0.0,  430.0,0.0,  0.0,   &
                   0.0,  430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,  0.0,   &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   &
                   0.0,  430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,  0.0,   &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   &
                   0.0,  0.0,  430.0,430.0,0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  10.0, 10.0, 10.0, 10.0, 0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  10.0, 10.0, 10.0, 0.0,  0.0,    &
                   0.0,  0.0,  0.0,  1.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0 /), &
       (/nlon,nlat/)))
    allocate(expected_lake_fractions(3,3))
    expected_lake_fractions = transpose(reshape((/ &
                0.380952,0.305556,0.404762, &
                0.160714,0.229167,0.321429, &
                0.0238095,0.0,0.0714286 /), &
          (/3,3/)))
    allocate(expected_number_lake_cells(3,3))
    expected_number_lake_cells = transpose(reshape((/ &
                16,11,17, &
                9,11,18, &
                1, 0, 3 /), &
          (/3,3/)))
    allocate(expected_number_fine_grid_cells(3,3))
    expected_number_fine_grid_cells = transpose(reshape((/ &
              42,36,42, &
              56,48,56, &
              42,36,42 /), &
          (/3,3/)))
    allocate(expected_lake_volumes(6))
    expected_lake_volumes = (/46.0, 1.0, 38.0, 6.0, 340.0, 10.0/)
    call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                   lake_parameters, &
                                   initial_water_to_lake_centers, &
                                   initial_spillover_to_rivers)
    call run_hd_model(timesteps,runoffs,drainages)
    lake_prognostics_out => get_lake_prognostics()
    lake_fields_out => get_lake_fields()
    allocate(lake_types(nlat,nlon))
    lake_types(:,:) = 0
    do i = 1,20
      do j = 1,20
        lake_number = lake_fields_out%lake_numbers(i,j)
        if (lake_number > 0) then
          working_lake_ptr = lake_prognostics_out%lakes(lake_number)
          lake_type = working_lake_ptr%lake_pointer%lake_type
            if (lake_type == filling_lake_type) then
              lake_types(i,j) = 1
            else if (lake_type == overflowing_lake_type) then
              lake_types(i,j) = 2
            else if (lake_type == subsumed_lake_type) then
              lake_types(i,j) = 3
            else
              lake_types(i,j) = 4
            end if
        end if
      end do
    end do
    allocate(lake_volumes(6))
    do i = 1,size(lake_volumes)
      working_lake_ptr = lake_prognostics_out%lakes(i)
      lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
    end do
    diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
    call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
    call renumber_lakes(lake_fields_out)
    call reorder_lake_volumes(lake_volumes)
#endif
    call assert_equals(expected_river_inflow,river_fields%river_inflow,&
                       nlat_coarse,nlon_coarse,0.0000000001_dp)
    call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.0000000001_dp)
    call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4,0.0000000001_dp)
    call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
    call assert_equals(expected_lake_types,lake_types,20,20)
    call assert_equals(expected_diagnostic_lake_volumes,diagnostic_lake_volumes,20,20)
    call assert_equals(expected_lake_volumes,lake_volumes,6)
    call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
    call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
    call assert_equals(expected_number_fine_grid_cells,lake_parameters%number_fine_grid_cells,3,3)
    deallocate(lake_fractions)
    deallocate(lake_volumes)
    deallocate(drainage)
    deallocate(drainages)
    deallocate(runoff)
    deallocate(runoffs)
    deallocate(initial_spillover_to_rivers)
    deallocate(initial_water_to_lake_centers)
    deallocate(diagnostic_lake_volumes)
    deallocate(expected_river_inflow)
    deallocate(expected_water_to_ocean)
    deallocate(expected_water_to_hd)
    deallocate(expected_lake_numbers)
    deallocate(expected_lake_types)
    deallocate(expected_lake_volumes)
    deallocate(expected_diagnostic_lake_volumes)
    deallocate(expected_lake_fractions)
    deallocate(expected_number_lake_cells)
    deallocate(expected_number_fine_grid_cells)
    deallocate(lake_types)
    call clean_lake_model()
    call clean_hd_model()
end subroutine testLakeModel2

subroutine testLakeModel3
 use latlon_hd_model_interface_mod
  use latlon_hd_model_mod
  use latlon_lake_model_io_mod, only: add_offset
  type(riverparameters), pointer :: river_parameters
  type(riverprognosticfields), pointer :: river_fields
  type(lakeparameters),pointer :: lake_parameters
  type(lakefields), pointer :: lake_fields_out
  type(lakeprognostics), pointer :: lake_prognostics_out
  type(lakepointer) :: working_lake_ptr
  real(dp)   ,dimension(:,:), pointer :: flow_directions
  integer,dimension(:,:), pointer :: river_reservoir_nums
  integer,dimension(:,:), pointer :: overland_reservoir_nums
  integer,dimension(:,:), pointer :: base_reservoir_nums
  real(dp),dimension(:,:), pointer :: river_retention_coefficients
  real(dp),dimension(:,:), pointer :: overland_retention_coefficients
  real(dp),dimension(:,:), pointer :: base_retention_coefficients
  logical,dimension(:,:), pointer :: landsea_mask
  logical,dimension(:,:), pointer :: lake_centers
  real(dp),dimension(:,:), pointer :: connection_volume_thresholds
  real(dp),dimension(:,:), pointer :: flood_volume_thresholds
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
  integer,dimension(:,:), pointer :: flood_next_cell_lat_index
  integer,dimension(:,:), pointer :: flood_next_cell_lon_index
  integer,dimension(:,:), pointer :: connect_next_cell_lat_index
  integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
  real(dp),dimension(:,:), pointer :: drainage
  real(dp),dimension(:,:,:), pointer :: drainages
  real(dp),dimension(:,:,:), pointer :: drainages_copy
  real(dp),dimension(:,:), pointer :: runoff
  real(dp),dimension(:,:,:), pointer :: runoffs
  real(dp),dimension(:,:,:), pointer :: runoffs_copy
  real(dp),dimension(:,:), pointer :: evaporation
  real(dp),dimension(:,:,:), pointer :: evaporations
  real(dp),dimension(:,:,:), pointer :: evaporations_set_two
  real(dp), pointer, dimension(:,:) :: initial_spillover_to_rivers
  real(dp), pointer, dimension(:,:) :: initial_water_to_lake_centers
  real(dp),dimension(:,:), pointer :: expected_river_inflow
  real(dp),dimension(:,:), pointer :: expected_water_to_ocean
  real(dp),dimension(:,:), pointer :: expected_water_to_hd
  integer,dimension(:,:), pointer :: expected_lake_numbers
  integer,dimension(:,:), pointer :: expected_lake_types
  real(dp),dimension(:), pointer :: expected_lake_volumes
  real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
  real(dp),dimension(:,:), pointer :: expected_intermediate_diagnostic_lake_volumes
  real(dp),dimension(:,:), pointer :: expected_intermediate_river_inflow
  real(dp),dimension(:,:), pointer :: expected_intermediate_water_to_ocean
  real(dp),dimension(:,:), pointer :: expected_intermediate_water_to_hd
  integer,dimension(:,:), pointer :: expected_intermediate_lake_numbers
  integer,dimension(:,:), pointer :: expected_intermediate_lake_types
  real(dp),dimension(:), pointer :: expected_intermediate_lake_volumes
  real(dp), dimension(:,:), pointer :: expected_lake_fractions
  integer, dimension(:,:), pointer :: expected_number_lake_cells
  integer, dimension(:,:), pointer :: expected_number_fine_grid_cells
  real(dp), dimension(:,:), pointer :: expected_intermediate_lake_fractions
  integer , dimension(:,:), pointer :: expected_intermediate_number_lake_cells
  integer , dimension(:,:), pointer :: expected_intermediate_number_fine_grid_cells
  integer,dimension(:,:), pointer :: lake_types
  real(dp),dimension(:), pointer :: lake_volumes
  real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
  real(dp), dimension(:,:), allocatable :: lake_fractions
  integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
  integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
  type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
   connect_merge_and_redirect_indices_collections
  type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
   flood_merge_and_redirect_indices_collections
  type(mergeandredirectindicescollection), pointer :: collected_indices
  type(mergeandredirectindices), pointer :: primary_merge
  type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
  type(mergeandredirectindices), pointer :: secondary_merge
  real(dp) :: step_length
  integer :: nlat,nlon
  integer :: nlat_coarse,nlon_coarse
  integer :: nlat_surface_model,nlon_surface_model
  integer :: lake_number
  integer :: i,j
  logical :: instant_throughflow_local
  real(dp) :: lake_retention_coefficient_local
  integer :: lake_type
  integer :: flood_index
      step_length = 86400.0_dp
      nlat = 20
      nlon = 20
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ -2, 4, 2, 2, &
                                              6,-2,-2, 2, &
                                              6, 2, 3,-2, &
                                             -2, 0, 6, 0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.7
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.5
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.1
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(4,4,1,1,5)
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
        .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,  &
                .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, 186.0, 23.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, 56.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
               -1.0, -1.0, -1.0, -1.0, -1.0 &
         /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
       -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
              -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
       0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0, 111.0, 111.0, 56.0, &
            111.0,   -1.0,    -1.0,   -1.0, 2.0, &
       -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,   1.0,   1.0, 56.0, &
            56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,   0.0,   1.0,  1.0, &
            26.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,   1.0,   0.0,  1.0,  &
            26.0, 26.0, 111.0,   -1.0,  -1.0, &
       16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0,   0.0,   0.0,   1.0,  1.0, &
             1.0, 26.0,  56.0,   -1.0,  -1.0, &
       -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,   0.0,   1.0,  1.0, &
             1.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,   1.0,   1.0,  1.0, &
            26.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,  56.0,  56.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
             0.0,  3.0,   3.0, 10.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
             0.0,  3.0,   3.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true.,  &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      flood_index = flood_index +1
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage = transpose(reshape((/ &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 0.0, 1.0, 0.0 /), &
         (/4,4/)))
      allocate(runoff(4,4))
      runoff = transpose(reshape((/ &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 1.0, 1.0, 1.0, &
         1.0, 0.0, 1.0, 0.0  /), &
         (/4,4/)))
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)/step_length
        runoffs(:,:,i) = runoff(:,:)/step_length
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      evaporation(:,:) = 100.0
      allocate(evaporations_set_two(3,3,5000))
      do i = 1,5000
        evaporations_set_two(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_spillover_to_rivers(4,4))
      initial_spillover_to_rivers(:,:) = 0.0
      allocate(initial_water_to_lake_centers(20,20))
      initial_water_to_lake_centers(:,:) = 0.0
      allocate(expected_river_inflow(4,4))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 2.0, &
         0.0, 2.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      expected_river_inflow(:,:) = expected_river_inflow(:,:)/step_length
      allocate(expected_water_to_ocean(4,4))
      expected_water_to_ocean = transpose(reshape((/ &
          -96.0,   0.0,   0.0,   0.0, &
         0.0, -96.0, -196.0,   0.0, &
         0.0,   0.0,   0.0, -94.0, &
         -98.0,   4.0,   0.0,   4.0 /), &
         (/4,4/)))
      expected_water_to_ocean(:,:) = expected_water_to_ocean(:,:)/step_length
      allocate(expected_water_to_hd(4,4))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      expected_water_to_hd(:,:) = expected_water_to_hd(:,:)/step_length
      allocate(expected_lake_numbers(20,20))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(expected_lake_types(20,20))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/0.0, 0.0, 0.0, 0.0, 0.0, 0.0/)
      allocate(expected_diagnostic_lake_volumes(20,20))
      expected_diagnostic_lake_volumes(:,:) = 0.0
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 0.06666666,0.16666667,0.0, &
                 1.0,0.02325581395,0.0, &
                 0.06666666,0.1428571429,0.0 /), &
          (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               1,1,0, &
               1,1,0, &
               1,1,0 /), &
          (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6, 311, &
                1,43, 1, &
               15, 7, 1 /), &
          (/3,3/)))
      allocate(expected_intermediate_river_inflow(4,4))
      expected_intermediate_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 2.0, &
         0.0, 2.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      expected_intermediate_river_inflow(:,:) = &
        expected_intermediate_river_inflow(:,:)/step_length
      allocate(expected_intermediate_water_to_ocean(4,4))
      expected_intermediate_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 6.0, 0.0, 22.0 /), &
         (/4,4/)))
      expected_intermediate_water_to_ocean(:,:) = &
        expected_intermediate_water_to_ocean(:,:)/step_length
      allocate(expected_intermediate_water_to_hd(4,4))
      expected_intermediate_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0,  0.0, &
         0.0, 0.0, 0.0, 12.0, &
         0.0, 0.0, 0.0,  0.0, &
         0.0, 2.0, 0.0, 18.0 /), &
         (/4,4/)))
      expected_intermediate_water_to_hd(:,:) = &
        expected_intermediate_water_to_hd(:,:)/step_length
      allocate(expected_intermediate_lake_numbers(20,20))
      expected_intermediate_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(expected_intermediate_lake_types(20,20))
      expected_intermediate_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, &
         3, 2, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, &
         0, 3, 3, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, &
         0, 3, 3, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 3, 3, 2, 3, 3, 0, 3, 3, 2, 2, 3, 2, 3, 2, 2, 2, 2, 0, 0, &
         3, 3, 3, 0, 3, 3, 3, 3, 3, 0, 2, 3, 3, 2, 2, 2, 2, 2, 0, 0, &
         0, 3, 3, 0, 0, 3, 0, 3, 0, 0, 0, 2, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(expected_intermediate_diagnostic_lake_volumes(nlat,nlon))
      expected_intermediate_diagnostic_lake_volumes = transpose(reshape((/ &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  430.0,&
                   430.0,430.0,430.0,0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  &
                   0.0,  0.0,  430.0,430.0,430.0,430.0,0.0,  0.0,  0.0,  430.0,&
                   0.0, 430.0,430.0,0.0,  0.0,  430.0,430.0, 0.0,  0.0,  0.0,  &
                   0.0, 430.0,430.0,430.0,430.0,430.0,0.0,   0.0,  0.0,  0.0,  &
                   0.0, 430.0,430.0,0.0,  0.0,  430.0,430.0, 430.0,430.0,0.0,  &
                   0.0, 0.0,  430.0,430.0,430.0,430.0,430.0, 0.0,  0.0,  0.0,  &
                   0.0, 430.0,430.0,430.0,430.0,430.0,0.0,   430.0,430.0,430.0,&
                   430.0,430.0,430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,  &
                   430.0,430.0,430.0,0.0,  430.0,430.0,430.0,430.0,430.0,0.0,  &
                   430.0,430.0,430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,   &
                   0.0,  430.0,430.0,0.0,  0.0,  430.0,0.0,  430.0,0.0,  0.0,   &
                   0.0,  430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,  0.0,   &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   &
                   0.0,  430.0,430.0,430.0,430.0,430.0,430.0,0.0,  0.0,  0.0,   &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   &
                   0.0,  0.0,  430.0,430.0,0.0,  0.0,  0.0,  0.0,  0.0,  0.0,   &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  10.0, 10.0, 10.0, 10.0, 0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  10.0, 10.0, 10.0, 0.0,  0.0,    &
                   0.0,  0.0,  0.0,  1.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,    &
                   0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0,  0.0 /), &
       (/nlon,nlat/)))
      allocate(expected_intermediate_lake_fractions(3,3))
      expected_intermediate_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.976744186,0.0, &
                 1.0,1.0,0.0 /), &
       (/3,3/)))
      allocate(expected_intermediate_number_lake_cells(3,3))
      expected_intermediate_number_lake_cells = transpose(reshape((/ &
               15,6, 0, &
                1,42,0, &
               15,7, 0 /), &
       (/3,3/)))
      allocate(expected_intermediate_number_fine_grid_cells(3,3))
      expected_intermediate_number_fine_grid_cells = transpose(reshape((/ &
               15,6 ,311, &
                1,43,1, &
               15,7 ,1  /), &
       (/3,3/)))
      allocate(expected_intermediate_lake_volumes(6))
      expected_intermediate_lake_volumes = (/46.0, 1.0, 38.0, 6.0, 340.0, 10.0/)
      allocate(runoffs_copy(4,4,5000))
      allocate(drainages_copy(4,4,5000))
      drainages_copy(:,:,:) = drainages(:,:,:)
      runoffs_copy(:,:,:) = runoffs(:,:,:)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5000,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_intermediate_river_inflow,river_fields%river_inflow,&
                         4,4,0.0000000001_dp)
      call assert_equals(expected_intermediate_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_intermediate_water_to_hd,lake_fields_out%water_to_hd,4,4,0.00001_dp)
      call assert_equals(expected_intermediate_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_intermediate_lake_types,lake_types,20,20)
      call assert_equals(expected_intermediate_diagnostic_lake_volumes,diagnostic_lake_volumes,20,20)
      call assert_equals(expected_intermediate_lake_volumes,lake_volumes,6)
      call assert_equals(expected_intermediate_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_intermediate_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_intermediate_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      call run_hd_model(5000,runoffs_copy,drainages_copy,evaporations_set_two)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      deallocate(diagnostic_lake_volumes)
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,&
                         4,4,0.0000000001_dp)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4,0.00001_dp)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_diagnostic_lake_volumes,diagnostic_lake_volumes,20,20,0.00001_dp)
      call assert_equals(expected_lake_volumes,lake_volumes,6)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(drainages_copy)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(runoffs_copy)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(evaporations_set_two)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_intermediate_river_inflow)
      deallocate(expected_intermediate_water_to_ocean)
      deallocate(expected_intermediate_water_to_hd)
      deallocate(expected_intermediate_lake_numbers)
      deallocate(expected_intermediate_lake_types)
      deallocate(expected_intermediate_lake_volumes)
      deallocate(expected_intermediate_diagnostic_lake_volumes)
      deallocate(expected_intermediate_lake_fractions)
      deallocate(expected_intermediate_number_lake_cells)
      deallocate(expected_intermediate_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel3

subroutine testLakeModel4
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   real(dp) :: seconds_per_day
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flow_directions
   real :: low_lake_volume
   real :: high_lake_volume
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   logical,dimension(:,:), pointer :: flood_local_redirect
   logical,dimension(:,:), pointer :: connect_local_redirect
   logical,dimension(:,:), pointer :: additional_flood_local_redirect
   logical,dimension(:,:), pointer :: additional_connect_local_redirect
   integer,dimension(:,:), pointer :: merge_points
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp), pointer, dimension(:,:) :: initial_spillover_to_rivers
   real(dp), pointer, dimension(:,:) :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: third_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: third_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_hd
   real(dp), dimension(:,:), pointer :: fourth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: fourth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: fourth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_hd
   real(dp), dimension(:,:), pointer :: fifth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: fifth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: fifth_intermediate_expected_number_fine_grid_cells
   integer,dimension(:,:), pointer :: lake_types
   integer :: connection_merge_not_set_flood_merge_as_primary
   integer :: connection_merge_not_set_flood_merge_as_secondary
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   integer :: flood_index
      connection_merge_not_set_flood_merge_as_primary = 9
      connection_merge_not_set_flood_merge_as_secondary = 10
      nlat_coarse = 3
      nlon_coarse = 3
      nlat_surface_model = 2
      nlon_surface_model = 2
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      seconds_per_day = 86400.0_dp
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,6,2,&
                                             8,7,2,&
                                             8,7,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(3,3) = 0
      overland_reservoir_nums(3,3) = 0
      base_reservoir_nums(3,3) = 0
      landsea_mask(3,3) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(3,3,1,1,5)
      nlat = 9
      nlon = 9
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False.,  .True., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds(:,:) = -1.0
      low_lake_volume = 2.0*real(seconds_per_day)
      high_lake_volume = 5.0*real(seconds_per_day)
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0,  low_lake_volume, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_local_redirect(nlat,nlon))
      flood_local_redirect(:,:) = .False.
      allocate(connect_local_redirect(nlat,nlon))
      connect_local_redirect(:,:) = .False.
      allocate(additional_flood_local_redirect(nlat,nlon))
      additional_flood_local_redirect(:,:) = .False.
      allocate(additional_connect_local_redirect(nlat,nlon))
      additional_connect_local_redirect(:,:) = .False.
      allocate(merge_points(nlat,nlon))
      merge_points = transpose(reshape((/ &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, connection_merge_not_set_flood_merge_as_secondary,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, &
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype,&
         no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype, no_merge_mtype /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
        cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0, &
          3.5,4.0  /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 4, 2, 0, 0, 0, 0, 0, &
         0, 0, 5, 5, 0, 0, 0, 0, 0, &
         0, 0, 4, 3, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 4, 4, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,1 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,1, &
                                                           2,2,2,2,2,2,2,2,2 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(1))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
        secondary_merge => &
          mergeandredirectindices(.false., &
                                  .false., &
                                  1, &
                                  5, &
                                  1, &
                                  3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                             secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(1,4) = flood_index
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(nlat_coarse,nlon_coarse))
      drainage = transpose(reshape((/ &
                                    1.0,0.0,0.0,&
                                    0.0,0.0,0.0,&
                                    0.0,0.0,0.0 /), &
                          (/nlon_coarse,nlat_coarse/)))
      allocate(runoff(nlat_coarse,nlon_coarse))
      runoff(:,:) = 0.0
      allocate(evaporation(nlat_surface_model,nlon_surface_model))
      evaporation(:,:) = 0.0
      allocate(drainages(nlat_coarse,nlon_coarse,1000))
      allocate(runoffs(nlat_coarse,nlon_coarse,1000))
      allocate(evaporations(nlat_surface_model,nlon_surface_model,1000))
      do i = 1,1000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers(:,:) = 0.0
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers(:,:) = 0.0
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  1.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(2,2))
      expected_lake_fractions = transpose(reshape((/ &
                  1.0, 0.0, &
                  0.0, 0.0 /), &
         (/2,2/)))
      allocate(expected_number_lake_cells(2,2))
      expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0 /), &
         (/2,2/)))
      allocate(expected_number_fine_grid_cells(2,2))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(expected_lake_volumes(1))
      expected_lake_volumes = (/ 432000.0 /)

      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/seconds_per_day
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    172800.0, 0.0, 0.0,  0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(2,2))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.125,0.0, &
                 0.0,  0.0 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_number_lake_cells(2,2))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               1,0, &
               0,0 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(2,2))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8, 1, &
               1,71 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_lake_volumes(1))
      first_intermediate_expected_lake_volumes = (/ 172800.0 /)

      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      second_intermediate_expected_water_to_hd = &
        second_intermediate_expected_water_to_hd/seconds_per_day
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(2,2))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.75,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(second_intermediate_expected_number_lake_cells(2,2))
      second_intermediate_expected_number_lake_cells =  transpose(reshape((/ &
               6,0, &
               0,0 /), &
         (/2,2/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(2,2))
      second_intermediate_expected_number_fine_grid_cells =  transpose(reshape((/ &
               8, 1, &
               1,71 /), &
         (/2,2/)))
      allocate(second_intermediate_expected_lake_volumes(1))
      second_intermediate_expected_lake_volumes = (/ 259200.0 /)

      allocate(third_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      third_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      third_intermediate_expected_water_to_hd = &
        third_intermediate_expected_water_to_hd/seconds_per_day
      allocate(third_intermediate_expected_lake_numbers(nlat,nlon))
      third_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_types(nlat,nlon))
      third_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_fractions(2,2))
      third_intermediate_expected_lake_fractions = transpose(reshape((/ &
                  0.75,0.0, &
                  0.0,0.0 /), &
         (/2,2/)))
      allocate(third_intermediate_expected_number_lake_cells(2,2))
      third_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               6,0, &
               0,0 /), &
         (/2,2/)))
      allocate(third_intermediate_expected_number_fine_grid_cells(2,2))
      third_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))

      allocate(third_intermediate_expected_lake_volumes(1))
      third_intermediate_expected_lake_volumes = (/ 432000.0 /)

      allocate(fourth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fourth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fourth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      fourth_intermediate_expected_water_to_hd = &
        fourth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(fourth_intermediate_expected_lake_fractions(2,2))
      fourth_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(fourth_intermediate_expected_number_lake_cells(2,2))
      fourth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0  /), &
         (/2,2/)))
      allocate(fourth_intermediate_expected_number_fine_grid_cells(2,2))
      fourth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71  /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fifth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fifth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      fifth_intermediate_expected_water_to_hd = &
        fifth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(fifth_intermediate_expected_lake_fractions(2,2))
      fifth_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0, 0.0, &
                 0.0, 0.0 /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_number_lake_cells(2,2))
      fifth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0 /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_number_fine_grid_cells(2,2))
      fifth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))

      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(1))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)

      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes, &
                         first_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(3,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(second_intermediate_expected_water_to_ocean,river_fields%water_to_ocean,&
                         3,3,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(third_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(third_intermediate_expected_water_to_ocean, &
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(third_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(third_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         third_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(third_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(third_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(6,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fourth_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(fourth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(fourth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(fourth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(fourth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(7,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fifth_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(fifth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(fifth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(fifth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(fifth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(fifth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(8,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(third_intermediate_expected_river_inflow)
      deallocate(third_intermediate_expected_water_to_ocean)
      deallocate(third_intermediate_expected_water_to_hd)
      deallocate(third_intermediate_expected_lake_numbers)
      deallocate(third_intermediate_expected_lake_types)
      deallocate(third_intermediate_expected_lake_volumes)
      deallocate(third_intermediate_expected_diagnostic_lake_volumes)
      deallocate(third_intermediate_expected_lake_fractions)
      deallocate(third_intermediate_expected_number_lake_cells)
      deallocate(third_intermediate_expected_number_fine_grid_cells)
      deallocate(fourth_intermediate_expected_river_inflow)
      deallocate(fourth_intermediate_expected_water_to_ocean)
      deallocate(fourth_intermediate_expected_water_to_hd)
      deallocate(fourth_intermediate_expected_lake_fractions)
      deallocate(fourth_intermediate_expected_number_lake_cells)
      deallocate(fourth_intermediate_expected_number_fine_grid_cells)
      deallocate(fifth_intermediate_expected_river_inflow)
      deallocate(fifth_intermediate_expected_water_to_ocean)
      deallocate(fifth_intermediate_expected_water_to_hd)
      deallocate(fifth_intermediate_expected_lake_fractions)
      deallocate(fifth_intermediate_expected_number_lake_cells)
      deallocate(fifth_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel4

subroutine testLakeModel5
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   real(dp) :: seconds_per_day
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flow_directions
   real :: low_lake_volume
   real :: high_lake_volume
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp), pointer, dimension(:,:) :: initial_spillover_to_rivers
   real(dp), pointer, dimension(:,:) :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: third_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: third_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_hd
   real(dp), dimension(:,:), pointer :: fourth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: fourth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: fourth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_hd
   real(dp), dimension(:,:), pointer :: fifth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: fifth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: fifth_intermediate_expected_number_fine_grid_cells
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
  integer :: flood_index
      nlat_coarse = 3
      nlon_coarse = 3
      nlat_surface_model = 2
      nlon_surface_model = 2
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      seconds_per_day = 86400.0_dp
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,6,2,&
                                             8,7,2,&
                                             8,7,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(3,3) = 0
      overland_reservoir_nums(3,3) = 0
      base_reservoir_nums(3,3) = 0
      landsea_mask(3,3) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(3,3,1,1,5)
      nlat = 9
      nlon = 9
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False.,  .True., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds(:,:) = -1.0
      low_lake_volume = 2.0*real(seconds_per_day)
      high_lake_volume = 5.0*real(seconds_per_day)
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0,  low_lake_volume, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,5.0, &
          3.0,4.0 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 4, 2, 0, 0, 0, 0, 0, &
         0, 0, 5, 5, 0, 0, 0, 0, 0, &
         0, 0, 4, 3, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 4, 4, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,1 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,1, &
                                                           2,2,2,2,2,2,2,2,2 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(1))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      1, &
                                      5, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(1,4) = flood_index
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(runoff(nlat_coarse,nlon_coarse))
      allocate(runoffs(nlat_coarse,nlon_coarse,1000))
      runoff = transpose(reshape((/ &
                                   1.0,0.0,0.0, &
                                   0.0, 0.0, 0.0, &
                                   0.0, 0.0, 0.0 /), &
                                   (/nlon_coarse,nlat_coarse/)))
      allocate(drainage(nlat_coarse,nlon_coarse))
      allocate(drainages(nlat_coarse,nlon_coarse,1000))
      drainage(:,:) = 0.0
      allocate(evaporation(nlat_surface_model,nlon_surface_model))
      allocate(evaporations(nlat_surface_model,nlon_surface_model,1000))
      evaporation(:,:) = 0.0
      do i = 1,1000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers(:,:) = 0.0
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers(:,:) = 0.0
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  1.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(2,2))
      expected_lake_fractions = transpose(reshape((/ &
                  1.0,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(expected_number_lake_cells(2,2))
      expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0 /), &
         (/2,2/)))
      allocate(expected_number_fine_grid_cells(2,2))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(expected_lake_volumes(1))
      expected_lake_volumes = (/ 432000.0 /)

      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/seconds_per_day
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    172800.0, 0.0, 0.0,  0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(2,2))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.125,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_number_lake_cells(2,2))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               1,0, &
               0,0 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(2,2))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_lake_volumes(1))
      first_intermediate_expected_lake_volumes = (/ 172800.0 /)

      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      second_intermediate_expected_water_to_hd = &
        second_intermediate_expected_water_to_hd/seconds_per_day
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(2,2))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.75,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(second_intermediate_expected_number_lake_cells(2,2))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               6,0, &
               0,0 /), &
         (/2,2/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(2,2))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(second_intermediate_expected_lake_volumes(1))
      second_intermediate_expected_lake_volumes = (/ 259200.0 /)

      allocate(third_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      third_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      third_intermediate_expected_water_to_hd = &
        third_intermediate_expected_water_to_hd/seconds_per_day
      allocate(third_intermediate_expected_lake_numbers(nlat,nlon))
      third_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_types(nlat,nlon))
      third_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_fractions(2,2))
      third_intermediate_expected_lake_fractions= transpose(reshape((/ &
                 0.75,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(third_intermediate_expected_number_lake_cells(2,2))
      third_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               6,0, &
               0,0 /), &
         (/2,2/)))
      allocate(third_intermediate_expected_number_fine_grid_cells(2,2))
      third_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))

      allocate(third_intermediate_expected_lake_volumes(1))
      third_intermediate_expected_lake_volumes = (/ 432000.0 /)

      allocate(fourth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fourth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fourth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      fourth_intermediate_expected_water_to_hd = &
        fourth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(fourth_intermediate_expected_lake_fractions(2,2))
      fourth_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.0, &
                 0.0,0.0  /), &
         (/2,2/)))
      allocate(fourth_intermediate_expected_number_lake_cells(2,2))
      fourth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0 /), &
         (/2,2/)))
      allocate(fourth_intermediate_expected_number_fine_grid_cells(2,2))
      fourth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fifth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fifth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      fifth_intermediate_expected_water_to_hd = &
        fifth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(fifth_intermediate_expected_lake_fractions(2,2))
      fifth_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.0, &
                 0.0,0.0  /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_number_lake_cells(2,2))
      fifth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0  /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_number_fine_grid_cells(2,2))
      fifth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71  /), &
         (/2,2/)))
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(1))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(3,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(second_intermediate_expected_water_to_ocean, &
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
            do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(third_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(third_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(third_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(third_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         third_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(third_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(third_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(6,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fourth_intermediate_expected_river_inflow,&
                         river_fields%river_inflow,3,3)
      call assert_equals(fourth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,&
                         3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(fourth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(fourth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(fourth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(7,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fifth_intermediate_expected_river_inflow,&
                         river_fields%river_inflow,3,3)
      call assert_equals(fifth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(fifth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(fifth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(fifth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(fifth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(8,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(third_intermediate_expected_river_inflow)
      deallocate(third_intermediate_expected_water_to_ocean)
      deallocate(third_intermediate_expected_water_to_hd)
      deallocate(third_intermediate_expected_lake_numbers)
      deallocate(third_intermediate_expected_lake_types)
      deallocate(third_intermediate_expected_lake_volumes)
      deallocate(third_intermediate_expected_diagnostic_lake_volumes)
      deallocate(third_intermediate_expected_lake_fractions)
      deallocate(third_intermediate_expected_number_lake_cells)
      deallocate(third_intermediate_expected_number_fine_grid_cells)
      deallocate(fourth_intermediate_expected_river_inflow)
      deallocate(fourth_intermediate_expected_water_to_ocean)
      deallocate(fourth_intermediate_expected_water_to_hd)
      deallocate(fourth_intermediate_expected_lake_fractions)
      deallocate(fourth_intermediate_expected_number_lake_cells)
      deallocate(fourth_intermediate_expected_number_fine_grid_cells)
      deallocate(fifth_intermediate_expected_river_inflow)
      deallocate(fifth_intermediate_expected_water_to_ocean)
      deallocate(fifth_intermediate_expected_water_to_hd)
      deallocate(fifth_intermediate_expected_lake_fractions)
      deallocate(fifth_intermediate_expected_number_lake_cells)
      deallocate(fifth_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel5

subroutine testLakeModel6
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   real(dp) :: seconds_per_day
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flow_directions
   real :: low_lake_volume
   real :: high_lake_volume
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:), pointer :: drainage_two
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp), pointer, dimension(:,:) :: initial_spillover_to_rivers
   real(dp), pointer, dimension(:,:) :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: third_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: third_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_hd
   real(dp), dimension(:,:), pointer :: fourth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: fourth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: fourth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_hd
   real(dp), dimension(:,:), pointer :: fifth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: fifth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: fifth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: sixth_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: sixth_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: sixth_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: sixth_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: sixth_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: sixth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: seven_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: seven_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: seven_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: seven_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: seven_intermediate_expected_lake_types
   real(dp), dimension(:,:), pointer :: seven_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: seven_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: seven_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:), pointer :: seven_intermediate_expected_lake_volumes
   real(dp),dimension(:,:), pointer :: seven_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: eight_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: eight_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: eight_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: eight_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: eight_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: eight_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: eight_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: eight_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: eight_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: eight_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: nine_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: nine_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: nine_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: nine_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: nine_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: nine_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: nine_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: nine_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: nine_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: nine_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: ten_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: ten_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: ten_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: ten_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: ten_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: ten_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: ten_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: ten_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: ten_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: ten_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: eleven_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: eleven_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: eleven_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: eleven_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: eleven_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: eleven_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: eleven_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: eleven_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: eleven_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: eleven_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: twelve_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: twelve_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: twelve_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: twelve_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: twelve_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: twelve_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: twelve_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: twelve_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: twelve_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: twelve_intermediate_expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
  integer :: flood_index
      nlat_coarse = 3
      nlon_coarse = 3
      nlat_surface_model = 2
      nlon_surface_model = 2
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      seconds_per_day = 86400.0_dp
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,6,2,&
                                             8,7,2,&
                                             8,7,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(3,3) = 0
      overland_reservoir_nums(3,3) = 0
      base_reservoir_nums(3,3) = 0
      landsea_mask(3,3) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 9
      nlon = 9
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False.,  .True., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds(:,:) = -1.0
      low_lake_volume = 2.0*real(seconds_per_day)
      high_lake_volume = 5.0*real(seconds_per_day)
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0,  low_lake_volume, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.5, &
          3.0,4.0 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 4, 2, 0, 0, 0, 0, 0, &
         0, 0, 5, 5, 0, 0, 0, 0, 0, &
         0, 0, 4, 3, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 4, 4, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,1 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,2,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,1,1,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,1, &
                                                           2,2,2,2,2,2,2,2,2  /), &

         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(1))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      secondary_merge => &
          mergeandredirectindices(.false., &
                                  .false., &
                                  1, &
                                  5, &
                                  1, &
                                  3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(1,4) = flood_index
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(nlat_coarse,nlon_coarse))
      drainage = transpose(reshape((/ &
                                     2.0, 0.0, 0.0, &
                                     0.0, 0.0, 0.0, &
                                     0.0, 0.0, 0.0 /), &
                                     (/nlon_coarse,nlat_coarse/)))
      allocate(drainages(nlat_coarse,nlon_coarse,30000))
      do i = 1,30
        drainages(:,:,i) = drainage(:,:)
      end do
      allocate(drainage_two(nlat_coarse,nlon_coarse))
      drainage_two = transpose(reshape((/ &
                                         0.0, 0.0, 0.0, &
                                         0.0, 0.0, 0.0, &
                                         0.0, 0.0, 0.0 /), &
                                         (/nlon_coarse,nlat_coarse/)))
      do i = 31,30000
        drainages(:,:,i) = drainage_two(:,:)
      end do
      allocate(runoff(nlat_coarse,nlon_coarse))
      allocate(runoffs(nlat_coarse,nlon_coarse,30000))
      runoff(:,:) = 0.0
      allocate(evaporation(nlat_surface_model,nlon_surface_model))
      allocate(evaporations(nlat_surface_model,nlon_surface_model,30000))
      evaporation = transpose(reshape((/ &
                                         86400.0, 0.0, &
                                         0.0, 0.0 /), &
                                         (/nlon_surface_model,nlat_surface_model/)))
      do i = 1,30000
        runoffs(:,:,i) = runoff(:,:)
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers(:,:) = 0.0
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers(:,:) = 0.0
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          -1.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
               0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(2,2))
      expected_lake_fractions = transpose(reshape((/ &
                 0.125,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(expected_number_lake_cells(2,2))
      expected_number_lake_cells = transpose(reshape((/ &
               1,0, &
               0,0 /), &
         (/2,2/)))
      allocate(expected_number_fine_grid_cells(2,2))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
     allocate(expected_lake_volumes(1))
     expected_lake_volumes = (/ 0.0 /)

      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/seconds_per_day
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    172800.0, 0.0, 0.0,  0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(2,2))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.125,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_number_lake_cells(2,2))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               1,0, &
               0,0 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(2,2))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(first_intermediate_expected_lake_volumes(1))
      first_intermediate_expected_lake_volumes = (/ 172800.0 /)

      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      second_intermediate_expected_water_to_hd = &
        second_intermediate_expected_water_to_hd/seconds_per_day
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(2,2))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
                0.75,0.0, &
               0.0,0.0  /), &
       (/2,2/)))
      allocate(second_intermediate_expected_number_lake_cells(2,2))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             6,0, &
             0,0 /), &
       (/2,2/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(2,2))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71  /), &
       (/2,2/)))
      allocate(second_intermediate_expected_lake_volumes(1))
      second_intermediate_expected_lake_volumes = (/ 259200.0 /)

      allocate(third_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      third_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      third_intermediate_expected_water_to_hd = &
        third_intermediate_expected_water_to_hd/seconds_per_day
      allocate(third_intermediate_expected_lake_numbers(nlat,nlon))
      third_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_types(nlat,nlon))
      third_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_fractions(2,2))
      third_intermediate_expected_lake_fractions = transpose(reshape((/ &
               0.75,0.0, &
               0.0,0.0 /), &
       (/2,2/)))
      allocate(third_intermediate_expected_number_lake_cells(2,2))
      third_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             6,0, &
             0,0 /), &
       (/2,2/)))
      allocate(third_intermediate_expected_number_fine_grid_cells(2,2))
      third_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71 /), &
       (/2,2/)))
      allocate(third_intermediate_expected_lake_volumes(1))
      third_intermediate_expected_lake_volumes = (/ 432000.0 /)

      allocate(fourth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fourth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fourth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      fourth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      fourth_intermediate_expected_water_to_hd = &
        fourth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(fourth_intermediate_expected_lake_fractions(2,2))
      fourth_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(fourth_intermediate_expected_number_lake_cells(2,2))
      fourth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0 /), &
         (/2,2/)))
      allocate(fourth_intermediate_expected_number_fine_grid_cells(2,2))
      fourth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fifth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(fifth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      fifth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      fifth_intermediate_expected_water_to_hd = &
        fifth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(fifth_intermediate_expected_lake_fractions(2,2))
      fifth_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_number_lake_cells(2,2))
      fifth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               8,0, &
               0,0 /), &
         (/2,2/)))
      allocate(fifth_intermediate_expected_number_fine_grid_cells(2,2))
      fifth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(sixth_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      sixth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(sixth_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      sixth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(sixth_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      sixth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 86400.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      sixth_intermediate_expected_water_to_hd = &
        sixth_intermediate_expected_water_to_hd/seconds_per_day
      allocate(sixth_intermediate_expected_lake_numbers(nlat,nlon))
      sixth_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(sixth_intermediate_expected_lake_types(nlat,nlon))
      sixth_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(sixth_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      sixth_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,    0.0,    0.0,    432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(sixth_intermediate_expected_lake_fractions(2,2))
      sixth_intermediate_expected_lake_fractions = transpose(reshape((/ &
               1.0,0.0, &
               0.0,0.0 /), &
       (/2,2/)))
      allocate(sixth_intermediate_expected_number_lake_cells(2,2))
      sixth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             8,0, &
             0,0 /), &
       (/2,2/)))
      allocate(sixth_intermediate_expected_number_fine_grid_cells(2,2))
      sixth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71 /), &
       (/2,2/)))
      allocate(sixth_intermediate_expected_lake_volumes(1))
      sixth_intermediate_expected_lake_volumes = (/ 432000.0 /)

      allocate(seven_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      seven_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0,0.0,0.0,&
          0.0,0.0,1.0,&
          0.0,0.0,0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(seven_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      seven_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(seven_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      seven_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      seven_intermediate_expected_water_to_hd = &
        seven_intermediate_expected_water_to_hd/seconds_per_day
      allocate(seven_intermediate_expected_lake_numbers(nlat,nlon))
      seven_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(seven_intermediate_expected_lake_types(nlat,nlon))
      seven_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(seven_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      seven_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    345600.0, 345600.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    345600.0, 345600.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    345600.0, 345600.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(seven_intermediate_expected_lake_fractions(2,2))
      seven_intermediate_expected_lake_fractions = transpose(reshape((/ &
               0.75,0.0, &
               0.0,0.0 /), &
       (/2,2/)))
      allocate(seven_intermediate_expected_number_lake_cells(2,2))
      seven_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             6,0, &
             0,0 /), &
       (/2,2/)))
      allocate(seven_intermediate_expected_number_fine_grid_cells(2,2))
      seven_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71 /), &
       (/2,2/)))
      allocate(seven_intermediate_expected_lake_volumes(1))
      seven_intermediate_expected_lake_volumes = (/ 345600.0 /)

      allocate(eight_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      eight_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0,0.0,0.0,&
          0.0,0.0,0.0,&
          0.0,0.0,0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(eight_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      eight_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(eight_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      eight_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      eight_intermediate_expected_water_to_hd = &
        eight_intermediate_expected_water_to_hd/seconds_per_day
      allocate(eight_intermediate_expected_lake_numbers(nlat,nlon))
      eight_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(eight_intermediate_expected_lake_types(nlat,nlon))
      eight_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(eight_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      eight_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    259200.0, 259200.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(eight_intermediate_expected_lake_fractions(2,2))
      eight_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.75,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(eight_intermediate_expected_number_lake_cells(2,2))
      eight_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               6,0, &
               0,0 /), &
         (/2,2/)))
      allocate(eight_intermediate_expected_number_fine_grid_cells(2,2))
      eight_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               8,1, &
               1,71 /), &
         (/2,2/)))
      allocate(eight_intermediate_expected_lake_volumes(1))
      eight_intermediate_expected_lake_volumes = (/ 259200.0 /)

      allocate(nine_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      nine_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0,0.0,0.0,&
          0.0,0.0,0.0,&
          0.0,0.0,0.0  /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(nine_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      nine_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(nine_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      nine_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      nine_intermediate_expected_water_to_hd = &
        nine_intermediate_expected_water_to_hd/seconds_per_day
      allocate(nine_intermediate_expected_lake_numbers(nlat,nlon))
      nine_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(nine_intermediate_expected_lake_types(nlat,nlon))
      nine_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(nine_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      nine_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    172800.0, 172800.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    172800.0, 172800.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    172800.0, 172800.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(nine_intermediate_expected_lake_fractions(2,2))
      nine_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.75,0.0, &
                 0.0,0.0 /), &
         (/2,2/)))
      allocate(nine_intermediate_expected_number_lake_cells(2,2))
      nine_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               6,0, &
               0,0 /), &
         (/2,2/)))
      allocate(nine_intermediate_expected_number_fine_grid_cells(2,2))
      nine_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
         8,1, &
         1,71 /), &
         (/2,2/)))
      allocate(nine_intermediate_expected_lake_volumes(1))
      nine_intermediate_expected_lake_volumes = (/ 172800.0 /)

      allocate(ten_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      ten_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0,0.0,0.0,&
          0.0,0.0,0.0,&
          0.0,0.0,0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(ten_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      ten_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(ten_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      ten_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      ten_intermediate_expected_water_to_hd = &
        ten_intermediate_expected_water_to_hd/seconds_per_day
      allocate(ten_intermediate_expected_lake_numbers(nlat,nlon))
      ten_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(ten_intermediate_expected_lake_types(nlat,nlon))
      ten_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(ten_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      ten_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    86400.0,  0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(ten_intermediate_expected_lake_fractions(2,2))
      ten_intermediate_expected_lake_fractions = transpose(reshape((/ &
               0.125,0.0, &
               0.0,0.0 /), &
       (/2,2/)))
      allocate(ten_intermediate_expected_number_lake_cells(2,2))
      ten_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             1,0, &
             0,0 /), &
       (/2,2/)))
      allocate(ten_intermediate_expected_number_fine_grid_cells(2,2))
      ten_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71 /), &
       (/2,2/)))
      allocate(ten_intermediate_expected_lake_volumes(1))
      ten_intermediate_expected_lake_volumes = (/ 86400.0 /)
      allocate(eleven_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      eleven_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0,0.0,0.0,&
          0.0,0.0,0.0,&
          0.0,0.0,0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(eleven_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      eleven_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(eleven_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      eleven_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      eleven_intermediate_expected_water_to_hd = &
        eleven_intermediate_expected_water_to_hd/seconds_per_day
      allocate(eleven_intermediate_expected_lake_numbers(nlat,nlon))
      eleven_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(eleven_intermediate_expected_lake_types(nlat,nlon))
      eleven_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(eleven_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      eleven_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0,    0,    0,    0,   0,    0,    0,    0,    0, &
         0,    0,    0,    0,   0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(eleven_intermediate_expected_lake_fractions(2,2))
      eleven_intermediate_expected_lake_fractions = transpose(reshape((/ &
               0.125,0.0, &
               0.0,0.0 /), &
       (/2,2/)))
      allocate(eleven_intermediate_expected_number_lake_cells(2,2))
      eleven_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             1,0, &
             0,0 /), &
       (/2,2/)))
      allocate(eleven_intermediate_expected_number_fine_grid_cells(2,2))
      eleven_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71 /), &
       (/2,2/)))
      allocate(eleven_intermediate_expected_lake_volumes(1))
      eleven_intermediate_expected_lake_volumes = (/ 0.0 /)

      allocate(twelve_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      twelve_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0,0.0,0.0,&
          0.0,0.0,0.0,&
          0.0,0.0,0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(twelve_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      twelve_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(twelve_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      twelve_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      twelve_intermediate_expected_water_to_hd = &
        twelve_intermediate_expected_water_to_hd/seconds_per_day
      allocate(twelve_intermediate_expected_lake_numbers(nlat,nlon))
      twelve_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(twelve_intermediate_expected_lake_types(nlat,nlon))
      twelve_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    1,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(twelve_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      twelve_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0,    0,    0,    0,   0,    0,    0,    0,    0, &
         0,    0,    0,    0,   0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(twelve_intermediate_expected_lake_fractions(2,2))
      twelve_intermediate_expected_lake_fractions = transpose(reshape((/ &
               0.125,0.0, &
               0.0,0.0 /), &
       (/2,2/)))
      allocate(twelve_intermediate_expected_number_lake_cells(2,2))
      twelve_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             1,0, &
             0,0 /), &
       (/2,2/)))
      allocate(twelve_intermediate_expected_number_fine_grid_cells(2,2))
      twelve_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             8,1, &
             1,71 /), &
       (/2,2/)))
      allocate(twelve_intermediate_expected_lake_volumes(1))
      twelve_intermediate_expected_lake_volumes = (/ 0.0 /)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(1))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(3,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(third_intermediate_expected_river_inflow, river_fields%river_inflow,3,3)
      call assert_equals(third_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(third_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(third_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         third_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(third_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(third_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(third_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(6,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fourth_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(fourth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(sixth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         sixth_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(fourth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(fourth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(fourth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(7,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fifth_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(fifth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(fifth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(sixth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         sixth_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(fifth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(fifth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(fifth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(8,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(sixth_intermediate_expected_river_inflow,&
                         river_fields%river_inflow,3,3)
      call assert_equals(sixth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(sixth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(sixth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         sixth_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(sixth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(sixth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(30,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(sixth_intermediate_expected_river_inflow, river_fields%river_inflow,3,3)
      call assert_equals(sixth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(sixth_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(sixth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         sixth_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(sixth_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(sixth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(sixth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(31,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(seven_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(seven_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(seven_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(seven_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(seven_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(seven_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         seven_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(seven_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(seven_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(seven_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(32,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(eight_intermediate_expected_river_inflow,&
                         river_fields%river_inflow,3,3)
      call assert_equals(eight_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(eight_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(eight_intermediate_expected_lake_numbers,&
                         lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(eight_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(eight_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         eight_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(eight_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(eight_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(eight_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(33,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(nine_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(nine_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(nine_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(nine_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(nine_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(nine_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         nine_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(nine_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(nine_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(nine_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(34,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(ten_intermediate_expected_river_inflow,&
                         river_fields%river_inflow,3,3)
      call assert_equals(ten_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(ten_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(ten_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(ten_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(ten_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         ten_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(ten_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(ten_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(ten_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(35,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(eleven_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(eleven_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(eleven_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(eleven_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(eleven_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(eleven_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes, &
                         eleven_intermediate_expected_diagnostic_lake_volumes,nlat,nlon,&
                         0.0000000000001_dp)
      call assert_equals(eleven_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(eleven_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(eleven_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(36,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(twelve_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(twelve_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(twelve_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(twelve_intermediate_expected_lake_numbers,&
                         lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(twelve_intermediate_expected_lake_types,lake_types,nlat,nlat)
      call assert_equals(twelve_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         twelve_intermediate_expected_diagnostic_lake_volumes,nlat,nlon,&
                         0.0000000000001_dp)
      call assert_equals(twelve_intermediate_expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(twelve_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(twelve_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(37,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(expected_river_inflow, river_fields%river_inflow,3,3)
      call assert_equals(expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,nlat,nlon,&
                         0.0000000000001_dp)
      call assert_equals(expected_lake_fractions,lake_fractions,2,2,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,2,2)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,2,2)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(drainage_two)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(third_intermediate_expected_river_inflow)
      deallocate(third_intermediate_expected_water_to_ocean)
      deallocate(third_intermediate_expected_water_to_hd)
      deallocate(third_intermediate_expected_lake_numbers)
      deallocate(third_intermediate_expected_lake_types)
      deallocate(third_intermediate_expected_lake_volumes)
      deallocate(third_intermediate_expected_diagnostic_lake_volumes)
      deallocate(third_intermediate_expected_lake_fractions)
      deallocate(third_intermediate_expected_number_lake_cells)
      deallocate(third_intermediate_expected_number_fine_grid_cells)
      deallocate(fourth_intermediate_expected_river_inflow)
      deallocate(fourth_intermediate_expected_water_to_ocean)
      deallocate(fourth_intermediate_expected_water_to_hd)
      deallocate(fourth_intermediate_expected_lake_fractions)
      deallocate(fourth_intermediate_expected_number_lake_cells)
      deallocate(fourth_intermediate_expected_number_fine_grid_cells)
      deallocate(fifth_intermediate_expected_river_inflow)
      deallocate(fifth_intermediate_expected_water_to_ocean)
      deallocate(fifth_intermediate_expected_water_to_hd)
      deallocate(fifth_intermediate_expected_lake_fractions)
      deallocate(fifth_intermediate_expected_number_lake_cells)
      deallocate(fifth_intermediate_expected_number_fine_grid_cells)
      deallocate(sixth_intermediate_expected_river_inflow)
      deallocate(sixth_intermediate_expected_water_to_ocean)
      deallocate(sixth_intermediate_expected_water_to_hd)
      deallocate(sixth_intermediate_expected_lake_numbers)
      deallocate(sixth_intermediate_expected_lake_types)
      deallocate(sixth_intermediate_expected_lake_volumes)
      deallocate(sixth_intermediate_expected_diagnostic_lake_volumes)
      deallocate(sixth_intermediate_expected_lake_fractions)
      deallocate(sixth_intermediate_expected_number_lake_cells)
      deallocate(sixth_intermediate_expected_number_fine_grid_cells)
      deallocate(seven_intermediate_expected_river_inflow)
      deallocate(seven_intermediate_expected_water_to_ocean)
      deallocate(seven_intermediate_expected_water_to_hd)
      deallocate(seven_intermediate_expected_lake_numbers)
      deallocate(seven_intermediate_expected_lake_types)
      deallocate(seven_intermediate_expected_lake_volumes)
      deallocate(seven_intermediate_expected_diagnostic_lake_volumes)
      deallocate(seven_intermediate_expected_lake_fractions)
      deallocate(seven_intermediate_expected_number_lake_cells)
      deallocate(seven_intermediate_expected_number_fine_grid_cells)
      deallocate(eight_intermediate_expected_river_inflow)
      deallocate(eight_intermediate_expected_water_to_ocean)
      deallocate(eight_intermediate_expected_water_to_hd)
      deallocate(eight_intermediate_expected_lake_numbers)
      deallocate(eight_intermediate_expected_lake_types)
      deallocate(eight_intermediate_expected_lake_volumes)
      deallocate(eight_intermediate_expected_diagnostic_lake_volumes)
      deallocate(eight_intermediate_expected_lake_fractions)
      deallocate(eight_intermediate_expected_number_lake_cells)
      deallocate(eight_intermediate_expected_number_fine_grid_cells)
      deallocate(nine_intermediate_expected_river_inflow)
      deallocate(nine_intermediate_expected_water_to_ocean)
      deallocate(nine_intermediate_expected_water_to_hd)
      deallocate(nine_intermediate_expected_lake_numbers)
      deallocate(nine_intermediate_expected_lake_types)
      deallocate(nine_intermediate_expected_lake_volumes)
      deallocate(nine_intermediate_expected_diagnostic_lake_volumes)
      deallocate(nine_intermediate_expected_lake_fractions)
      deallocate(nine_intermediate_expected_number_lake_cells)
      deallocate(nine_intermediate_expected_number_fine_grid_cells)
      deallocate(ten_intermediate_expected_river_inflow)
      deallocate(ten_intermediate_expected_water_to_ocean)
      deallocate(ten_intermediate_expected_water_to_hd)
      deallocate(ten_intermediate_expected_lake_numbers)
      deallocate(ten_intermediate_expected_lake_types)
      deallocate(ten_intermediate_expected_lake_volumes)
      deallocate(ten_intermediate_expected_diagnostic_lake_volumes)
      deallocate(ten_intermediate_expected_lake_fractions)
      deallocate(ten_intermediate_expected_number_lake_cells)
      deallocate(ten_intermediate_expected_number_fine_grid_cells)
      deallocate(eleven_intermediate_expected_river_inflow)
      deallocate(eleven_intermediate_expected_water_to_ocean)
      deallocate(eleven_intermediate_expected_water_to_hd)
      deallocate(eleven_intermediate_expected_lake_numbers)
      deallocate(eleven_intermediate_expected_lake_types)
      deallocate(eleven_intermediate_expected_lake_volumes)
      deallocate(eleven_intermediate_expected_diagnostic_lake_volumes)
      deallocate(eleven_intermediate_expected_lake_fractions)
      deallocate(eleven_intermediate_expected_number_lake_cells)
      deallocate(eleven_intermediate_expected_number_fine_grid_cells)
      deallocate(twelve_intermediate_expected_river_inflow)
      deallocate(twelve_intermediate_expected_water_to_ocean)
      deallocate(twelve_intermediate_expected_water_to_hd)
      deallocate(twelve_intermediate_expected_lake_numbers)
      deallocate(twelve_intermediate_expected_lake_types)
      deallocate(twelve_intermediate_expected_lake_volumes)
      deallocate(twelve_intermediate_expected_diagnostic_lake_volumes)
      deallocate(twelve_intermediate_expected_lake_fractions)
      deallocate(twelve_intermediate_expected_number_lake_cells)
      deallocate(twelve_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel6

subroutine testLakeModel7
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   real(dp) :: seconds_per_day
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flow_directions
   real :: low_lake_volume
   real :: high_lake_volume
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   integer :: flood_index
      nlat_coarse = 3
      nlon_coarse = 3
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      seconds_per_day = 86400.0_dp
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,6,2,&
                                             8,7,2,&
                                             8,7,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(3,3) = 0
      overland_reservoir_nums(3,3) = 0
      base_reservoir_nums(3,3) = 0
      landsea_mask(3,3) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 9
      nlon = 9
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False.,  .True., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds(:,:) = -1.0
      low_lake_volume = 2.0*real(seconds_per_day)
      high_lake_volume = 5.0*real(seconds_per_day)
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0,  low_lake_volume, high_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, low_lake_volume, low_lake_volume, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 4, 2, 0, 0, 0, 0, 0, &
         0, 0, 5, 5, 0, 0, 0, 0, 0, &
         0, 0, 4, 3, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 3, 4, 0, 0, 0, 0, 0, &
         0, 0, 4, 4, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2, &
                                                           3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3, &
                                                           1,1,1,2,2,2,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(1))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
        secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      1, &
                                      5, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(1,4) = flood_index
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainages(nlat_coarse,nlon_coarse,1000))
      drainages(:,:,:) = 0.0
      allocate(runoffs(nlat_coarse,nlon_coarse,1000))
      runoffs(:,:,:) = 0.0
      allocate(evaporations(nlat_surface_model,nlon_surface_model,1000))
      evaporations(:,:,:) = 0.0
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 4.0*high_lake_volume, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0,  86400.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0, 16.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = &
        expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,    0.0,    0.0,    432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 0.0,1.0/3.0,0.0, &
                 0.25,    0.25,0.0, &
                 0.0,    0.0,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               0,2,0, &
               3,3,0, &
               0,0,0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               6,6,6, &
              12,12,12, &
               9,9,9 /), &
         (/3,3/)))

      allocate(expected_lake_volumes(1))
      expected_lake_volumes = (/ 432000.0 /)

      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  16.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  15.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/seconds_per_day
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0, 0.0,  0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0, 0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,  0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,   0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(3,3))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
               0.0,1.0/3.0,0.0, &
               0.25,    0.25,0.0, &
               0.0,    0.0,0.0 /), &
       (/3,3/)))
      allocate(first_intermediate_expected_number_lake_cells(3,3))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
             0,2,0, &
             3,3,0, &
             0,0,0 /), &
       (/3,3/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(3,3))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
             6,6,6, &
            12,12,12, &
             9,9,9 /), &
       (/3,3/)))
      allocate(first_intermediate_expected_lake_volumes(1))
      first_intermediate_expected_lake_volumes = (/ 432000.0 /)

      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  16.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0, &
         0.0, 0.0,  0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      second_intermediate_expected_water_to_hd = &
        second_intermediate_expected_water_to_hd/seconds_per_day
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
             0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    1,    1,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
             0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    2,    2,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0, &
         0,    0,    0,    0,    0,    0,    0,    0,    0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
             0.0,    0.0,    0.0,    432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    432000.0,   0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    432000.0, 432000.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(3,3))
      second_intermediate_expected_lake_fractions= transpose(reshape((/ &
                 0.0,1.0/3.0,0.0, &
                 0.25,    0.25,0.0, &
                 0.0,    0.0,0.0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_lake_cells(3,3))
      second_intermediate_expected_number_lake_cells= transpose(reshape((/ &
               0,2,0, &
               3,3,0, &
               0,0,0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(3,3))
      second_intermediate_expected_number_fine_grid_cells= transpose(reshape((/ &
               6,6,6, &
              12,12,12, &
               9,9,9 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_lake_volumes(1))
      second_intermediate_expected_lake_volumes = (/ 432000.0 /)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(0,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(1))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd, &
                         lake_fields_out%water_to_hd/seconds_per_day,3,3)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,&
                         nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(1,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(second_intermediate_expected_river_inflow,&
                         river_fields%river_inflow,3,3)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,3,3)
      call assert_equals(second_intermediate_expected_lake_numbers,&
                         lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_types,&
                         lake_types,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,nlat,nlon)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(expected_river_inflow,river_fields%river_inflow,3,3)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,3,3,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,3,3)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,nlat,nlon)
      call assert_equals(expected_lake_types,lake_types,nlat,nlon)
      call assert_equals(expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,&
                         nlat,nlon)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainages)
      deallocate(runoffs)
      deallocate(evaporations)
      deallocate(lake_fractions)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel7

subroutine testLakeModel8
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   real(dp) :: seconds_per_day
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: third_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: third_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: third_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp),dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,4,2,2,&
                                            6,-2,-2,2,&
                                            6,2,3,-2,&
                                            -2,0,6,0 /), &
                                  (/nlat_coarse,nlon_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(20,20))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(20,20))
      connection_volume_thresholds = transpose(reshape((/ &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,   186.0, 23.0,  -1.0, -1.0,     -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   56.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(20,20))
      flood_volume_thresholds = transpose(reshape((/ &
           -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  -1.0,&
               -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,   -1.0,&
          111.0, 111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,&
            1.0,   1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,&
            0.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,&
            1.0,   0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0, 0.0,&
            0.0,   1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,&
            0.0,   1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,&
            1.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
           56.0,  56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(20,20))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(20,20))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(20,20))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(20,20))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = 0.0
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
           0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          430.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 2.0*86400.0, 0.0, 0.0, &
         0.0, 0.0, 1.0*86400.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = &
        expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, &
         3, 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 3, &
         0, 3, 3, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, &
         0, 3, 3, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 3, 3, 1, 3, 3, 0, 3, 3, 1, 1, 3, 1, 3, 1, 1, 1, 1, 0, 0, &
         3, 3, 3, 0, 3, 3, 3, 3, 3, 0, 1, 3, 3, 1, 1, 1, 1, 1, 0, 0, &
         0, 3, 3, 0, 0, 3, 0, 3, 0, 0, 0, 1, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     430.0, &
         430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     430.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,       0.0,    &
          430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,       0.0,    &
          0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0,   430.0,&
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,       430.0,&
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 0.0,     430.0, 0.0,     0.0,       0.0,    &
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.976744186,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               15, 6, 0, &
                1,42, 0, &
               15, 1, 0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
                15,6 ,311, &
                1 ,43,1, &
                15,7 ,1  /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 340.0, 0.0 /)
      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 2.0, 0.0, 0.0, &
         0.0, 0.0, 1.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/seconds_per_day
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
              0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0,   0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(3,3))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.06666666667,0.1666666667,0.0, &
                 1.0,0.02325581395,0.0, &
                 0.06666666667,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_lake_cells(3,3))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
                1, 1, 0, &
                1, 1, 0, &
                1, 1, 0  /), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(3,3))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               15,6 ,311, &
                1,43,1, &
               15,7 ,1  /), &
         (/3,3/)))
      allocate(first_intermediate_expected_lake_volumes(6))
      first_intermediate_expected_lake_volumes = (/ 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /)
      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 2.0, 0.0, 1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         384.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      second_intermediate_expected_water_to_hd = &
        second_intermediate_expected_water_to_hd/seconds_per_day
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, &
         1, 1, 1, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, &
         2, 2, 2, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         46.0,   0.0,  46.0,   0.0,   0.0,   0.0,   0.0,  0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         46.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,  0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(3,3))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.1666666667,0.0, &
                 1.0,0.02325581395,0.0, &
                 0.06666666667,0.1428571429,0.0 /), &
       (/3,3/)))
      allocate(second_intermediate_expected_number_lake_cells(3,3))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               15,1,0, &
                1,1,0, &
                1,1,0 /), &

       (/3,3/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(3,3))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               15,6 ,311, &
                1,43,1, &
               15,7 ,1 /), &
       (/3,3/)))
      allocate(second_intermediate_expected_lake_volumes(6))
      second_intermediate_expected_lake_volumes = (/46.0, 0.0, 0.0, 0.0, 0.0, 0.0 /)
      allocate(third_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      third_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(third_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      third_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      third_intermediate_expected_water_to_hd = &
        third_intermediate_expected_water_to_hd/seconds_per_day
      allocate(third_intermediate_expected_lake_numbers(nlat,nlon))
      third_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 3, 3, 0, 3, 3, 0, 0, 4, 0, 4, 0, 0, 0, 0, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 0, 4, 4, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 0, 4, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_types(nlat,nlon))
      third_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         0, 2, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 2, 2, 0, 2, 2, 0, 0, 3, 0, 3, 0, 0, 0, 0, 0, 0, &
         2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 0, 3, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         46.0,   0.0,     46.0,  0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         0.0,    46.0,    46.0,  0.0,   0.0,    0.0,   38.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,    46.0,    46.0,  0.0,   0.0,   38.0,   38.0,   38.0,   38.0,    0.0,   0.0,   0.0,   7.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,    46.0,    46.0,  0.0,  38.0,    38.0,   0.0,   38.0,   38.0,    0.0,   0.0,   7.0,   0.0,&
            7.0, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         46.0,   46.0,    46.0,  0.0,  38.0,   38.0,   38.0,   38.0,   38.0,    0.0,   0.0,   7.0,   7.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,    46.0,    46.0,  0.0,   0.0,   38.0,    0.0,   38.0,    0.0,    0.0,   0.0,   0.0,   7.0,&
            0.0,   7.0, 0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   7.0, 0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_fractions(3,3))
      third_intermediate_expected_lake_fractions = transpose(reshape((/ &
               1.0,1.0,0.0, &
               1.0,0.04651162791,0.0, &
               1.0,0.1428571429,0.0 /), &
       (/3,3/)))
      allocate(third_intermediate_expected_number_lake_cells(3,3))
      third_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               15,6,0, &
                1,2,0, &
               15,1,0 /), &
       (/3,3/)))
      allocate(third_intermediate_expected_number_fine_grid_cells(3,3))
      third_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
            15,6 ,311, &
            1 ,43,1, &
            15,7 ,1  /), &
       (/3,3/)))
      allocate(third_intermediate_expected_lake_volumes(6))
      third_intermediate_expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 1.0, 0.0 /)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(0,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(1,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals( third_intermediate_expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals( third_intermediate_expected_water_to_ocean,&
                          river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals( third_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals( third_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals( third_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals( third_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals( diagnostic_lake_volumes,&
                          third_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals( third_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals( third_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals( third_intermediate_expected_number_fine_grid_cells, &
                          lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(3,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals( expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals( expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals( expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals( expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals( expected_lake_types,lake_types,20,20)
      call assert_equals( expected_lake_volumes,lake_volumes,6)
      call assert_equals( diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals( expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals( expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals( expected_number_fine_grid_cells, &
                          lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(lake_fractions)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(third_intermediate_expected_river_inflow)
      deallocate(third_intermediate_expected_water_to_ocean)
      deallocate(third_intermediate_expected_water_to_hd)
      deallocate(third_intermediate_expected_lake_numbers)
      deallocate(third_intermediate_expected_lake_types)
      deallocate(third_intermediate_expected_lake_volumes)
      deallocate(third_intermediate_expected_diagnostic_lake_volumes)
      deallocate(third_intermediate_expected_lake_fractions)
      deallocate(third_intermediate_expected_number_lake_cells)
      deallocate(third_intermediate_expected_number_fine_grid_cells)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel8

subroutine testLakeModel9
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   type(riverprognosticfields), pointer :: river_fields
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp) :: seconds_per_day
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,4,2,2, &
                                            6,-2,-2,2, &
                                            6,2,3,-2, &
                                            -2,0,6,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0,&
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    186.0,  23.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   56.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, -1.0,&
          -1.0,    -1.0, 111.0, 111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,&
          -1.0, 111.0,   1.0,   1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,&
          -1.0,    -1.0,   0.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0,&
         1.0,   6.0,   1.0,   0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0, -1.0,&
         1.0,   0.0,   0.0,   1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,&
          -1.0,   1.0,   0.0,   1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,  56.0,   1.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,  56.0,  56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,&
          -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3  /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = (0.0)
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
           0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          440.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 2.0*86400.0, 0.0, 0.0, &
         0.0, 0.0, 1.0*86400.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, &
         3, 2, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, &
         0, 3, 3, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, &
         0, 3, 3, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 3, 3, 2, 3, 3, 0, 3, 3, 2, 2, 3, 2, 3, 2, 2, 2, 2, 0, 0, &
         3, 3, 3, 0, 3, 3, 3, 3, 3, 0, 2, 3, 3, 2, 2, 2, 2, 2, 0, 0, &
         0, 3, 3, 0, 0, 3, 0, 3, 0, 0, 0, 2, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     430.0, &
         430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     430.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     &
         0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, &
         430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     &
         430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 0.0,     430.0, 0.0,     0.0,     &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,  10.0,  10.0,  10.0,  10.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,  10.0,  10.0,  10.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.976744186,0.0, &
                 1.0,1.0,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               15, 6,0, &
                1,42,0, &
               15, 7,0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43, 1, &
               15, 7, 1 /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 340.0,10.0 /)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals( expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals( expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals( expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals( expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals( expected_lake_types,lake_types,20,20)
      call assert_equals( expected_lake_volumes,lake_volumes,6)
      call assert_equals( diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals( expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals( expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals( expected_number_fine_grid_cells, &
                          lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel9

subroutine testLakeModel10
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   real(dp) :: seconds_per_day
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ &
                                            -2,4,2,2, &
                                            6,-2,-2,2, &
                                            6,2,3,-2, &
                                            -2,0,6,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0,&
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,   186.0,   23.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   56.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,  -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0, 111.0, 111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0, &
          -1.0,  -1.0, 111.0,   1.0,   1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0, &
          -1.0,  -1.0,    -1.0,   0.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0, &
          -1.0, 1.0,   6.0,   1.0,   0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0,10.0,&
           -1.0, 1.0,   0.0,   0.0,   1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0, &
          -1.0,  -1.0,   1.0,   0.0,   1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,  56.0,   1.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,  56.0,  56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0, &
          -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = (0.0)
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
           0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          120.0, 0.0, 0.0, 0.0, &
         0.0, 20.0, 0.0, 0.0, &
         0.0, 2.0*86400.0, 0.0, 0.0, &
         0.0, 0.0, 1.0*86400.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 0, 3, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 3, 3, 0, 3, 3, 0, 5, 4, 5, 4, 5, 5, 5, 0, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         0, 2, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, 1, 1, 1, 0, 0, 0, 0, &
         0, 2, 2, 0, 2, 2, 0, 2, 2, 0, 1, 3, 1, 3, 1, 1, 1, 0, 0, 0, &
         2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 1, 3, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 1, 3, 1, 1, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 46.0, &
         46.0, 0.0, 46.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 46.0, &
         0.0, 46.0, 46.0, 0.0, 0.0, 0.0, 38.0, 0.0, 0.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 46.0, 46.0, 0.0, 0.0, 38.0, 38.0, 38.0, 38.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 46.0, 46.0, 0.0, 38.0, 38.0, 0.0, 38.0, 38.0, 0.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, &
         46.0, 46.0, 46.0, 0.0, 38.0, 38.0, 38.0, 38.0, 38.0, 0.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, &
         0.0, 46.0, 46.0, 0.0, 0.0, 38.0, 0.0, 38.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.5581395349,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               15,6,0, &
                1,24,0, &
               15,1,0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43,  1, &
               15, 7,  1 /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 50.0, 0.0 /)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel10

subroutine testLakeModel11
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   real(dp) :: seconds_per_day
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/-2,4,2,2,&
                                            8,-2,-2,2,&
                                            6,2,3,-2,&
                                            -2,0,6,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,   186.0,   23.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   56.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,   -1.0,&
          111.0, 111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,&
            1.0,   1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,&
            0.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,&
            1.0,   0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0, 0.0,&
            0.0,   1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,&
            0.0,   1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,&
            1.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
           56.0,  56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3  /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = (0.0)
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 430.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, &
         3, 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 3, &
         0, 3, 3, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, &
         0, 3, 3, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 3, 3, 1, 3, 3, 0, 3, 3, 1, 1, 3, 1, 3, 1, 1, 1, 1, 0, 0, &
         3, 3, 3, 0, 3, 3, 3, 3, 3, 0, 1, 3, 3, 1, 1, 1, 1, 1, 0, 0, &
         0, 3, 3, 0, 0, 3, 0, 3, 0, 0, 0, 1, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     430.0, &
         430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     430.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     &
           0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     &
           0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, &
           430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     &
           430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 0.0,     430.0, 0.0,     0.0,     &
           0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     &
           0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.976744186,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               15, 6,0, &
                1,42,0, &
               15, 1,0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43,  1, &
               15, 7,  1 /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 340.0, 0.0 /)
      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/seconds_per_day
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 3, 3, 0, 3, 3, 0, 5, 4, 5, 4, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 1, 1, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 3, 3, 0, 3, 3, 0, 1, 3, 1, 3, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 3, 3, 3, 3, 3, 0, 1, 3, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 1, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0,   0.0,&
             0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 100.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   100.0, 100.0, 100.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0, 100.0, 100.0, 100.0, 100.0,   0.0,   0.0,&
            0.0,   100.0, 100.0, 100.0, 100.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0, 100.0, 100.0,   0.0, 100.0, 100.0,   0.0, 100.0,&
          100.0,   100.0, 100.0, 100.0, 100.0, 100.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0, 100.0, 100.0, 100.0, 100.0, 100.0,   0.0, 100.0,&
          100.0,   100.0, 100.0, 100.0, 100.0, 100.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0, 100.0,   0.0, 100.0,   0.0,   0.0,   0.0,&
          100.0,   100.0, 100.0, 100.0, 100.0, 100.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
          100.0,   100.0, 100.0, 100.0, 100.0, 100.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   100.0, 100.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,     0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(3,3))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.06666666667,1.0,0.0, &
                 1.0,0.6744186047,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_lake_cells(3,3))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               1,6,0, &
               1,29,0, &
               15,1,0 /), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(3,3))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43,  1, &
               15, 7,  1  /), &
         (/3,3/)))
      allocate(first_intermediate_expected_lake_volumes(6))
      first_intermediate_expected_lake_volumes = (/0.0, 0.0, 38.0, 6.0, 56.0, 0.0 /)

      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         275.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      second_intermediate_expected_water_to_hd = &
        second_intermediate_expected_water_to_hd/seconds_per_day
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         0, 0, 0, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 3, 3, 0, 3, 3, 2, 2, 3, 2, 3, 2, 2, 2, 2, 0, 0, &
         0, 0, 0, 0, 3, 3, 3, 3, 3, 0, 2, 3, 3, 2, 2, 2, 2, 2, 0, 0, &
         0, 0, 0, 0, 0, 3, 0, 3, 0, 0, 0, 2, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, &
           0.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 155.0,   0.0,   0.0,   0.0,  0.0, &
           155.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0, 155.0, 155.0, 155.0, 155.0,   0.0,  0.0, &
           0.0, 155.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0, 155.0, 155.0,   0.0, 155.0, 155.0, 155.0, 155.0,&
            155.0, 155.0, 155.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0, 155.0, 155.0, 155.0, 155.0, 155.0,   0.0, 155.0,&
            155.0, 155.0, 155.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0, 155.0,   0.0, 155.0,   0.0,   0.0,   0.0,&
            155.0, 155.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            155.0, 155.0, 155.0, 155.0, 155.0, 155.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0, 155.0, 155.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
             0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(3,3))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 0.06666666667,1.0,0.0, &
                 1.0,0.8837209302,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_lake_cells(3,3))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
               1,6,0, &
               1,38,0, &
              15,1,0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(3,3))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
                15,6 ,311, &
                1 ,43,1, &
                15,7 ,1 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_lake_volumes(6))
      second_intermediate_expected_lake_volumes = (/0.0, 0.0, 38.0, 6.0, 111.0, 0.0 /)

      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(0,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(first_intermediate_expected_river_inflow, river_fields%river_inflow,4,4)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd/86400.0,4,4)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(1,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel11

subroutine testLakeModel12
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
  type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   type(mergeandredirectindices), pointer :: primary_merge
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   real(dp) :: seconds_per_day
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ &
                                            -2,4,2,2, &
                                            8,-2,-2,2, &
                                            6,2,3,-2, &
                                            -2,0,6,0  /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
         .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0,&
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,     186.0, 23.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   56.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,   -1.0,&
          111.0, 111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,&
            1.0,   1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,&
            0.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,&
            1.0,   0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0, 0.0,&
            0.0,   1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,&
            0.0,   1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,&
            1.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
           56.0,  56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,&
             -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = (0.0)
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
           0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 440.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, &
         3, 2, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, &
         0, 3, 3, 0, 0, 2, 2, 0, 0, 0, 0, 2, 2, 2, 2, 2, 0, 0, 0, 0, &
         0, 3, 3, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 3, 3, 2, 3, 3, 0, 3, 3, 2, 2, 3, 2, 3, 2, 2, 2, 2, 0, 0, &
         3, 3, 3, 0, 3, 3, 3, 3, 3, 0, 2, 3, 3, 2, 2, 2, 2, 2, 0, 0, &
         0, 3, 3, 0, 0, 3, 0, 3, 0, 0, 0, 2, 3, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     430.0, &
         430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     430.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,    &
            0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,    &
            0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0,&
            430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,    &
            430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 0.0,     430.0, 0.0,     0.0,    &
            0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,  10.0,  10.0,  10.0,  10.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,  10.0,  10.0,  10.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,    &
            0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.976744186,0.0, &
                 1.0,1.0,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               15, 6, 0, &
                1,42, 0, &
               15, 7, 0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43,  1, &
               15, 7,  1 /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 340.0,10.0 /)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(4,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel12

subroutine testLakeModel13
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
   type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   real(dp) :: seconds_per_day
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ &
                                            -2,4,2,2, &
                                            6,-2,-2,2, &
                                            6,2,3,-2, &
                                            -2,0,6,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                         river_reservoir_nums, &
                                         overland_reservoir_nums, &
                                         base_reservoir_nums, &
                                         river_retention_coefficients, &
                                         overland_retention_coefficients, &
                                         base_retention_coefficients, &
                                         landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,   186.0,   23.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   56.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,   -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0, -1.0,&
              -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0, -1.0,&
             -1.0, 111.0, 111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0,&
          111.0,   1.0,   1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,&
             -1.0,   0.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,&
            6.0,   1.0,   0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0, 1.0, 1.0,&
            0.0,   0.0,   1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,&
            1.0,   0.0,   1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
           56.0,   1.0,   1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,  56.0,  56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,&
             -1.0,    -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3  /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = (0.0)
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         120.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 20.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 0, 3, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 3, 3, 0, 3, 3, 0, 5, 4, 5, 4, 5, 5, 5, 0, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         0, 2, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, 1, 1, 1, 0, 0, 0, 0, &
         0, 2, 2, 0, 2, 2, 0, 2, 2, 0, 1, 3, 1, 3, 1, 1, 1, 0, 0, 0, &
         2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 1, 3, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 1, 3, 1, 1, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 46.0, &
         46.0, 0.0, 46.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 46.0, &
         0.0, 46.0, 46.0, 0.0, 0.0, 0.0, 38.0, 0.0, 0.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 46.0, 46.0, 0.0, 0.0, 38.0, 38.0, 38.0, 38.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 46.0, 46.0, 0.0, 38.0, 38.0, 0.0, 38.0, 38.0, 0.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, &
         46.0, 46.0, 46.0, 0.0, 38.0, 38.0, 38.0, 38.0, 38.0, 0.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, &
         0.0, 46.0, 46.0, 0.0, 0.0, 38.0, 0.0, 38.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 56.0, 56.0, 56.0, 56.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.5581395349,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
               15,6, 0, &
                1,24,0, &
               15,1, 0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43,  1, &
               15, 7,  1 /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 50.0, 0.0 /)

      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(5,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel13

subroutine testLakeModel14
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
   type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer ::  overland_reservoir_nums
   integer,dimension(:,:), pointer ::  base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp), dimension(:,:), pointer :: expected_lake_fractions
   integer , dimension(:,:), pointer :: expected_number_lake_cells
   integer , dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp), dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer , dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp), dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp), dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer :: nlat_coarse, nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: nlat,nlon
   integer :: lake_number
   integer :: i,j
   logical :: instant_throughflow_local
   real(dp) :: lake_retention_coefficient_local
   integer :: lake_type
   real(dp) :: seconds_per_day
   integer :: flood_index
      seconds_per_day = 86400.0_dp
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ -2,4,2,2,&
                                            6,-2,-2,2,&
                                            6,2,3,-2,&
                                            -2,0,6,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_reservoir_nums(4,2) = 0
      overland_reservoir_nums(4,2) = 0
      base_reservoir_nums(4,2) = 0
      landsea_mask(4,2) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
          .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0,&
             -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, 186.0, 23.0,  -1.0, -1.0,     &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
          56.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0,    -1.0,   -1.0,  -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
         0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,111.0,&
          111.0, 56.0, 111.0,   -1.0,    -1.0,   -1.0, 2.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,   1.0,&
            1.0, 56.0,  56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,   0.0,&
            1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,   1.0,&
            0.0,  1.0,  26.0, 26.0, 111.0,   -1.0,  -1.0, &
         16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0,   0.0, 0.0,&
            1.0,  1.0,   1.0, 26.0,  56.0,   -1.0,  -1.0, &
         -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,   0.0,&
            1.0,  1.0,   1.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,   1.0,&
            1.0,  1.0,  26.0, 56.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,  56.0,&
           56.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,   0.0,  3.0,   3.0, 10.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,   0.0,  3.0,   3.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
         -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,&
             -1.0,   -1.0,    -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
         2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
         -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
         -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
         -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
         7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
         -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
         -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
         19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
         -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
         -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
         -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
         2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
         -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
         -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,2,2,1,1,1,1,2,2,2,2,2,1,1,1,1, &
                                                             1,1,1,1,1,3,3,3,3,1,1,1,1,2,2,2,2,1,1,1, &
                                                             1,1,1,2,3,3,1,3,3,2,2,1,2,1,2,2,2,2,1,1, &
                                                             1,1,1,1,3,3,3,3,3,1,2,1,1,2,2,2,2,2,1,1, &
                                                             1,1,1,1,1,3,1,3,1,1,1,2,1,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,2,2,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,1,1, &
                                                             1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                             1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,1, &
                                                             1,2,1,3,3,3,3,3,3,3,3,3,2,2,2,2,3,3,3,1, &
                                                             3,1,1,3,3,2,2,3,3,3,3,2,2,2,2,2,3,3,3,3, &
                                                             3,1,1,3,3,1,1,1,1,3,3,3,2,2,2,2,2,3,3,3, &
                                                             3,1,1,2,1,1,3,1,1,2,2,2,2,2,2,2,2,2,3,3, &
                                                             1,1,1,3,1,1,1,1,1,3,2,2,2,2,2,2,2,2,3,3, &
                                                             3,1,1,3,3,1,3,1,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,2,2,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,3,3, &
                                                             3,3,3,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                             3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(9))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                6, &
                                2, &
                                1, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      8, &
                                      18, &
                                      1, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(4,6) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      6, &
                                      10, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,8) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      7, &
                                      14, &
                                      7, &
                                      14)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      6, &
                                      4, &
                                      1, &
                                      0)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,2) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                6, &
                                8, &
                                6, &
                                5)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(8,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                12, &
                                5, &
                                13)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(9,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      16, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,19) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      17, &
                                      3, &
                                      3, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,4) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = 0.0
      allocate(drainages(4,4,5000))
      allocate(runoffs(4,4,5000))
      do i = 1,5000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 0.0
      allocate(evaporations(3,3,5000))
      do i = 1,5000
        evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         430.0,0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(nlat_coarse,nlon_coarse))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 2.0*86400.0, 0.0, 0.0, &
         0.0, 0.0, 1.0*86400.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_river_inflow(nlat_coarse,nlon_coarse))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_ocean(nlat_coarse,nlon_coarse))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(expected_water_to_hd(nlat_coarse,nlon_coarse))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      expected_water_to_hd = expected_water_to_hd/seconds_per_day
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, &
         3, 1, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 3, &
         0, 3, 3, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, &
         0, 3, 3, 0, 0, 3, 3, 3, 3, 0, 0, 0, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 3, 3, 1, 3, 3, 0, 3, 3, 1, 1, 3, 1, 3, 1, 1, 1, 1, 0, 0, &
         3, 3, 3, 0, 3, 3, 3, 3, 3, 0, 1, 3, 3, 1, 1, 1, 1, 1, 0, 0, &
         0, 3, 3, 0, 0, 3, 0, 3, 0, 0, 0, 1, 3, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     430.0, &
         430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     430.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 0.0,     0.0,     0.0,       0.0,    &
          430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 430.0, 430.0, 430.0, 0.0,       0.0,    &
          0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0,   430.0,&
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         430.0, 430.0, 430.0, 0.0,     430.0, 430.0, 430.0, 430.0, 430.0, 0.0,       430.0,&
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0, &
         0.0,     430.0, 430.0, 0.0,     0.0,     430.0, 0.0,     430.0, 0.0,     0.0,       0.0,    &
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          430.0, 430.0, 430.0, 430.0, 430.0, 430.0, 0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     430.0, 430.0, 0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0, &
         0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,       0.0,    &
          0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0,     0.0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,0.0, &
                 1.0,0.976744186,0.0, &
                 1.0,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
              15, 6,0, &
               1,42,0, &
              15, 1,0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43, 1, &
               15, 7, 1 /), &
         (/3,3/)))
      allocate(expected_lake_volumes(6))
      expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 340.0, 0.0 /)

      allocate(first_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         384.0/86400.0, 0.0, 0.0, 0.0, &
         0.0, 2.0, 0.0, 0.0, &
         0.0, 0.0, 1.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(first_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         384.0/86400.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/86400.0_dp
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, &
         1, 1, 1, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, &
         2, 2, 2, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         46.0,   0.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         46.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
            0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  46.0,  46.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
           0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(3,3))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,0.1666666667,0.0,  &
                 1.0,0.02325581395,0.0, &
                 0.06666666667,0.1428571429,0.0 /), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_lake_cells(3,3))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
              15,1,0, &
               1,1,0, &
               1,1,0 /), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(3,3))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43, 1, &
               15, 7, 1 /), &
         (/3,3/)))
      allocate(first_intermediate_expected_lake_volumes(6))
      first_intermediate_expected_lake_volumes = (/46.0, 0.0, 0.0, 0.0, 0.0, 0.0 /)

      allocate(second_intermediate_expected_river_inflow(nlat_coarse,nlon_coarse))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_ocean(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 2.0, 0.0, 1.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_water_to_hd(nlat_coarse,nlon_coarse))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/nlon_coarse,nlat_coarse/)))
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
         0, 1, 1, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 3, 3, 0, 3, 3, 0, 0, 4, 0, 4, 0, 0, 0, 0, 0, 0, &
         1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 0, 4, 4, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 0, 4, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         2, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, &
         0, 2, 2, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 2, 2, 2, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 2, 2, 0, 2, 2, 0, 0, 3, 0, 3, 0, 0, 0, 0, 0, 0, &
         2, 2, 2, 0, 2, 2, 2, 2, 2, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 0, 0, 2, 0, 2, 0, 0, 0, 0, 3, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         46.0,   0.0,    46.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  46.0, &
         0.0,    46.0,   46.0,   0.0,   0.0,    0.0,   38.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,    46.0,   46.0,   0.0,   0.0,    38.0,  38.0,   38.0,&
            38.0,  0.0,   0.0,   0.0,   7.0, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,    46.0,   46.0,   0.0,  38.0,    38.0,   0.0,   38.0,&
            38.0,  0.0,   0.0,   7.0, 0.0,   7.0, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         46.0,   46.0,   46.0,   0.0,  38.0,    38.0,  38.0,   38.0,&
            38.0,  0.0,   0.0,   7.0, 7.0, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,    46.0,   46.0,   0.0,   0.0,    38.0,   0.0,   38.0,&
             0.0,    0.0,   0.0,   0.0,   7.0, 0.0,   7.0, 0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   7.0, 0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,     0.0,    0.0,   0.0,   0.0,    0.0,    0.0,    0.0,&
             0.0,    0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(3,3))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
                 1.0,1.0,          0.0, &
                 1.0,0.04651162791,0.0, &
                 1.0,0.1428571429, 0.0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_lake_cells(3,3))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
              15,6,0, &
               1,2,0, &
              15,1,0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(3,3))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
               15, 6,311, &
                1,43, 1, &
               15, 7, 1 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_lake_volumes(6))
      second_intermediate_expected_lake_volumes = (/46.0, 0.0, 38.0, 6.0, 1.0, 0.0 /)

      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(0,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(6))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd/86400.0_dp,4,4,0.000000000001_dp)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(1,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(2,runoffs,drainages,evaporations)
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      lake_types(:,:) = 0
      do i = 1,20
        do j = 1,20
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes(lake_fields_out)
      call reorder_lake_volumes(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4)
      call assert_equals(expected_water_to_ocean,river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,lake_fields_out%water_to_hd,4,4)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,6)
      call assert_equals(diagnostic_lake_volumes,expected_diagnostic_lake_volumes,20,20)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(lake_fractions)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel14

subroutine testLakeModel15
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
   type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer :: overland_reservoir_nums
   integer,dimension(:,:), pointer :: base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   real(dp),dimension(:,:), pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: lake_evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp),dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp),dimension(:,:), pointer :: expected_lake_fractions
   integer,dimension(:,:), pointer :: expected_number_lake_cells
   integer,dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: third_intermediate_expected_lake_volumes
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: third_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: third_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: fourth_intermediate_expected_lake_volumes
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_number_fine_grid_cells
   integer,dimension(:,:), pointer :: lake_types
   real(dp),dimension(:), pointer :: fifth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: sixth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: seventh_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: eighth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: ninth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: tenth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: eleventh_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: twelfth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: thirteenth_intermediate_expected_lake_volumes
   real(dp) :: lake_retention_coefficient_local
   logical :: use_realistic_surface_coupling_in
   logical :: instant_throughflow_local
   integer :: i,j
   integer :: nlat,nlon
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: lake_number,lake_type
   integer :: flood_index
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(nlat_coarse,nlon_coarse))
      flow_directions = transpose(reshape((/ 3,2,2,1, &
                                             6,6,-2,4, &
                                             6,8,8,2, &
                                             9,8,8,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(nlat_coarse,nlon_coarse))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(nlat_coarse,nlon_coarse))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(nlat_coarse,nlon_coarse))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(nlat_coarse,nlon_coarse))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(nlat_coarse,nlon_coarse))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(nlat_coarse,nlon_coarse))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(nlat_coarse,nlon_coarse))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      use_realistic_surface_coupling_in = .true.
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .True., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0/), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,  &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0,  &
         574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, -1.0, &
         -1.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0,  &
         574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, -1.0, &
         -1.0, 574.0, 206.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, &
          36.0, 36.0, 36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 366.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0,  &
         36.0, 36.0, 36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0,  &
         36.0, 36.0, 36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0,  &
         36.0, 36.0, 36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 0.0, &
          0.0, 0.0, 0.0, 0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0,  &
         0.0, 0.0, 0.0, 0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0,  &
         0.0, 0.0, 0.0, 0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0,  &
         0.0, 0.0, 0.0, 0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0,  &
         0.0, 0.0, 0.0, 0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0,  &
         0.0, 0.0, 0.0, 0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, &
          366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 1459.0, 1459.0, 1459.0, 1459.0, 574.0, -1.0, &
         -1.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, &
          366.0, 366.0, 366.0, 366.0, 366.0, 366.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, &
          366.0, 366.0, 366.0, 366.0, 366.0, 366.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, &
          366.0, 366.0, 366.0, 366.0, 366.0, 366.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, &
          574.0, 574.0, 574.0, 574.0, 574.0, 574.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 1459.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, &
         574.0, 574.0, 574.0, 574.0, 574.0, 574.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(3,3))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5, 3.0, 2.5, &
         3.0, 4.0, 3.0, &
         2.5, 3.0, 2.5 /), &
         (/3,3/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 18, -1, &
         -1, 2, 13, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 13, 14, -1, &
         -1, 2, 12, 12, 12, 12, 12, 12, 3, 3, 3, 3, 3, 12, 12, 12, 12, 13, 2, -1, &
         -1, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, -1, &
         -1, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, -1, &
         -1, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, -1, &
         -1, 6, 6, 6, 6, 6, 6, 6, 12, 7, 7, 7, 7, 6, 6, 6, 6, 6, 6, -1, &
         -1, 7, 7, 7, 7, 7, 7, 7, 7, 11, 8, 8, 8, 7, 7, 7, 7, 7, 7, -1, &
         -1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 10, 9, 11, 8, 8, 8, 8, 8, 8, -1, &
         -1, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 9, 9, 9, 9, 9, 9, 9, -1, &
         -1, 10, 10, 10, 10, 10, 10, 10, 10, 11, 10, 11, 11, 10, 10, 10, 10, 10, 10, -1, &
         -1, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 11, 11, 11, 11, 11, 11, -1, &
         -1, 12, 14, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 15, 12, -1, &
         -1, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, -1, -1, -1, -1, -1, -1, &
         -1, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, -1, -1, -1, -1, -1, -1, &
         -1, 17, 2, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, -1, -1, -1, -1, -1, -1, &
         -1, 1, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, -1, -1, -1, -1, -1, -1, &
         -1, 13, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 15, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 16, 17, 18, 13, -1, &
         -1, 14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 16, 17, 18, 1, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 14, 15, 16, 17, 13, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 12, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 12, 12, 9, 10, 8, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 12, 11, 11, 9, 9, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 8, 11, 9, 10, 12, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 8, 8, 12, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 16, 17, 15, 18, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 13, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
          1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      instant_throughflow_local=.True.
      lake_retention_coefficient_local=0.1_dp
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(1))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      15, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,18) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff(:,:) = 0.0
      allocate(drainages(4,4,10000))
      allocate(runoffs(4,4,10000))
      do i = 1,10000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 1.0
      allocate(lake_evaporations(3,3,180))
      do i = 1,180
        lake_evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(20,20))
      initial_water_to_lake_centers = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  1459.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(4,4))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_river_inflow(4,4))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_water_to_ocean(4,4))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_water_to_hd(4,4))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &

        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &

        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &

        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &

        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &

        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,1,1,1, 1,1,1,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &

        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0,  &
        0,0,0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0,0,0  /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
          0.0, 0.0, 0.0, &
         0.0, 0.5625,  0.0, &
         0.0, 0.0, 0.0/), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
           0, 0,  0, &
         0, 36,  0, &
         0, 0,  0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(expected_lake_volumes(1))
      expected_lake_volumes = (/0.0/)
      allocate(first_intermediate_expected_river_inflow(4,4))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(first_intermediate_expected_water_to_ocean(4,4))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(first_intermediate_expected_water_to_hd(4,4))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
              0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   0.0,   0.0,   0.0,   0.0,   1459.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0,   1459.0, &
            1459.0,   1459.0,    1459.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,    0.0,   0.0,  &
           0.0,   0.0,   0.0,   0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(3,3))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.6944444444, 0.8333333333, 0.6944444444, &
         0.8333333333, 1.0, 0.75, &
         0.6944444444, 0.8333333333, 0.0/), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_lake_cells(3,3))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          25, 40, 25, &
         40, 64, 36, &
         25, 40, 0/), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(3,3))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(first_intermediate_expected_lake_volumes(1))
      first_intermediate_expected_lake_volumes =  (/1459.0/)
      allocate(second_intermediate_expected_river_inflow(4,4))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(second_intermediate_expected_water_to_ocean(4,4))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(second_intermediate_expected_water_to_hd(4,4))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  &
             0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,&
             1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
               1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
             1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
             1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
              1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   0.0,   0.0,   0.0,   0.0,   1440.041667,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,  &
          1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667,   1440.041667, &
            1440.041667,    1440.041667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(3,3))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.6944444444, 0.8333333333, 0.6944444444, &
         0.8333333333, 1.0, 0.75, &
         0.6944444444, 0.8333333333, 0.0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_lake_cells(3,3))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          25, 40, 25, &
         40, 64, 36, &
         25, 40, 0/), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(3,3))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(second_intermediate_expected_lake_volumes(1))
      second_intermediate_expected_lake_volumes = (/1440.041667/)
      allocate(third_intermediate_expected_river_inflow(4,4))
      third_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(third_intermediate_expected_water_to_ocean(4,4))
      third_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(third_intermediate_expected_water_to_hd(4,4))
      third_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(third_intermediate_expected_lake_numbers(nlat,nlon))
      third_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_types(nlat,nlon))
      third_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  &
             0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
               586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                 586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,  &
               586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,  &
               586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
                586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   0.0,   0.0,   0.0,   0.0,   586.9166667,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,&
            586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667,   586.9166667, &
              586.9166667,    586.9166667,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_fractions(3,3))
      third_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.6944444444, 0.8333333333, 0.6944444444, &
         0.8333333333, 1.0, 0.75, &
         0.6944444444, 0.8333333333, 0.0 /), &
         (/3,3/)))
      allocate(third_intermediate_expected_number_lake_cells(3,3))
      third_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          25, 40, 25, &
         40, 64, 36, &
         25, 40, 0/), &
         (/3,3/)))
      allocate(third_intermediate_expected_number_fine_grid_cells(3,3))
      third_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(third_intermediate_expected_lake_volumes(1))
      third_intermediate_expected_lake_volumes = (/586.9166667/)
      allocate(fourth_intermediate_expected_river_inflow(4,4))
      fourth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fourth_intermediate_expected_water_to_ocean(4,4))
      fourth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fourth_intermediate_expected_water_to_hd(4,4))
      fourth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fourth_intermediate_expected_lake_numbers(nlat,nlon))
      fourth_intermediate_expected_lake_numbers = transpose(reshape((/ &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(fourth_intermediate_expected_lake_types(nlat,nlon))
      fourth_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(fourth_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      fourth_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 567.9583333, 567.9583333,    567.9583333, 567.9583333, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333, 567.9583333,&
             567.9583333, 567.9583333, 567.9583333, 567.9583333,&
          567.9583333, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(fourth_intermediate_expected_lake_fractions(3,3))
      fourth_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.3333333333, 0.5, 0.3333333333, &
         0.6666666667, 1.0, 0.5833333333, &
         0.3333333333, 0.5, 0.0 /), &
         (/3,3/)))
      allocate(fourth_intermediate_expected_number_lake_cells(3,3))
      fourth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          12, 24, 12, &
         32, 64, 28, &
         12, 24, 0/), &
         (/3,3/)))
      allocate(fourth_intermediate_expected_number_fine_grid_cells(3,3))
      fourth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(fourth_intermediate_expected_lake_volumes(1))
      fourth_intermediate_expected_lake_volumes = (/567.9583333/)

      allocate(fifth_intermediate_expected_lake_volumes(1))
      fifth_intermediate_expected_lake_volumes = (/369.2083332/)
      allocate(sixth_intermediate_expected_lake_volumes(1))
      sixth_intermediate_expected_lake_volumes = (/355.9583332/)

      allocate(seventh_intermediate_expected_lake_volumes(1))
      seventh_intermediate_expected_lake_volumes = (/213.625/)
      allocate(eighth_intermediate_expected_lake_volumes(1))
      eighth_intermediate_expected_lake_volumes = (/203.458/)

      allocate(ninth_intermediate_expected_lake_volumes(1))
      ninth_intermediate_expected_lake_volumes = (/99.0833/)
      allocate(tenth_intermediate_expected_lake_volumes(1))
      tenth_intermediate_expected_lake_volumes = (/92.125/)

      allocate(eleventh_intermediate_expected_lake_volumes(1))
      eleventh_intermediate_expected_lake_volumes = (/39.625/)
      allocate(twelfth_intermediate_expected_lake_volumes(1))
      twelfth_intermediate_expected_lake_volumes = (/35.875/)

      allocate(thirteenth_intermediate_expected_lake_volumes(1))
      thirteenth_intermediate_expected_lake_volumes = (/2.125/)

      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(0,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(1))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,1)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(1,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,20,20,0.0001_dp)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(46,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(third_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(third_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(third_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(third_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(third_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(third_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         third_intermediate_expected_diagnostic_lake_volumes,20,20,0.0001_dp)
      call assert_equals(third_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(third_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(third_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(47,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(fourth_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(fourth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(fourth_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(fourth_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         fourth_intermediate_expected_diagnostic_lake_volumes,20,20,0.0001_dp)
      call assert_equals(fourth_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(fourth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(fourth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(62,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(fifth_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(63,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(sixth_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(77,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(seventh_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(78,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(eighth_intermediate_expected_lake_volumes,lake_volumes,1,0.001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(93,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(ninth_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(94,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(tenth_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(108,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(eleventh_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(109,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(twelfth_intermediate_expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(124,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      call assert_equals(thirteenth_intermediate_expected_lake_volumes,lake_volumes,1,0.001_dp)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(125,runoffs,drainages,lake_evaporations,&
                          use_realistic_surface_coupling_in)
      lake_prognostics_out => get_lake_prognostics()
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,1,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         expected_diagnostic_lake_volumes,20,20,0.0001_dp)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_fractions)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(lake_evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(third_intermediate_expected_river_inflow)
      deallocate(third_intermediate_expected_water_to_ocean)
      deallocate(third_intermediate_expected_water_to_hd)
      deallocate(third_intermediate_expected_lake_numbers)
      deallocate(third_intermediate_expected_lake_types)
      deallocate(third_intermediate_expected_lake_volumes)
      deallocate(third_intermediate_expected_diagnostic_lake_volumes)
      deallocate(third_intermediate_expected_lake_fractions)
      deallocate(third_intermediate_expected_number_lake_cells)
      deallocate(third_intermediate_expected_number_fine_grid_cells)
      deallocate(fourth_intermediate_expected_river_inflow)
      deallocate(fourth_intermediate_expected_water_to_ocean)
      deallocate(fourth_intermediate_expected_water_to_hd)
      deallocate(fourth_intermediate_expected_lake_numbers)
      deallocate(fourth_intermediate_expected_lake_types)
      deallocate(fourth_intermediate_expected_lake_volumes)
      deallocate(fourth_intermediate_expected_diagnostic_lake_volumes)
      deallocate(fourth_intermediate_expected_lake_fractions)
      deallocate(fourth_intermediate_expected_number_lake_cells)
      deallocate(fourth_intermediate_expected_number_fine_grid_cells)
      deallocate(fifth_intermediate_expected_lake_volumes)
      deallocate(sixth_intermediate_expected_lake_volumes)
      deallocate(seventh_intermediate_expected_lake_volumes)
      deallocate(eighth_intermediate_expected_lake_volumes)
      deallocate(ninth_intermediate_expected_lake_volumes)
      deallocate(tenth_intermediate_expected_lake_volumes)
      deallocate(eleventh_intermediate_expected_lake_volumes)
      deallocate(twelfth_intermediate_expected_lake_volumes)
      deallocate(thirteenth_intermediate_expected_lake_volumes)
      deallocate(lake_types)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel15

subroutine testLakeModel16
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
   type(lakeparameters),pointer :: lake_parameters
   type(riverprognosticfields), pointer :: river_fields
   real(dp),dimension(:,:), pointer :: flow_directions
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer :: overland_reservoir_nums
   integer,dimension(:,:), pointer :: base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   real(dp),dimension(:,:), pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:,:), pointer :: lake_evaporations
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: lake_volumes_all_timesteps
   real(dp),dimension(:,:), pointer :: expected_lake_volumes_all_timesteps
   real(dp) :: lake_retention_coefficient_local
   logical :: use_realistic_surface_coupling_in
   logical :: instant_throughflow_local
   integer :: i
   integer :: nlat,nlon
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: flood_index
      use_realistic_surface_coupling_in = .true.
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(flow_directions(4,4))
      flow_directions = transpose(reshape((/ 3,2,2,1,&
                                             6,6,-2,4,&
                                             6,8,8,2,&
                                             9,8,8,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(4,4))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(4,4))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(4,4))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(4,4))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(4,4))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(4,4))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(4,4))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,&
           .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .True.,  &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0/), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,     &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0,   &
         574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, -1.0, &
         -1.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0,   &
         574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, -1.0, &
         -1.0, 574.0, 206.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0, 36.0,    &
          36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 366.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0, 36.0, 36.0,     &
          36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0, 36.0, 36.0,     &
          36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 36.0, 36.0, 36.0,     &
          36.0, 36.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 36.0, 0.0, 0.0, 0.0, 0.0,   &
           0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0, 0.0, 0.0, 0.0,    &
           0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0, 0.0, 0.0, 0.0,    &
           0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0, 0.0, 0.0, 0.0,    &
           0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0, 0.0, 0.0, 0.0,    &
           0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 96.0, 96.0, 96.0, 96.0, 96.0, 0.0, 0.0, 0.0, 0.0, 0.0,    &
           0.0, 206.0, 206.0, 206.0, 206.0, 206.0, 574.0, -1.0, &
         -1.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0,   &
           366.0, 366.0, 366.0, 366.0, 1459.0, 1459.0, 1459.0, 1459.0, 574.0, -1.0, &
         -1.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0,   &
           366.0, 366.0, 366.0, 366.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0,   &
           366.0, 366.0, 366.0, 366.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 574.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0, 366.0,   &
           366.0, 366.0, 366.0, 366.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0,   &
            574.0, 574.0, 574.0, 574.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 1459.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0, 574.0,  &
           574.0, 574.0, 574.0, 574.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(3,3))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5, 3.0, 2.5, &
         3.0, 4.0, 3.0, &
         2.5, 3.0, 2.5 /), &
         (/3,3/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 18, -1, &
         -1, 2, 13, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 13, 14, -1, &
         -1, 2, 12, 12, 12, 12, 12, 12, 3, 3, 3, 3, 3, 12, 12, 12, 12, 13, 2, -1, &
         -1, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, -1, &
         -1, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 4, 4, 4, 4, 4, 4, -1, &
         -1, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 5, 5, 5, 5, 5, 5, -1, &
         -1, 6, 6, 6, 6, 6, 6, 6, 12, 7, 7, 7, 7, 6, 6, 6, 6, 6, 6, -1, &
         -1, 7, 7, 7, 7, 7, 7, 7, 7, 11, 8, 8, 8, 7, 7, 7, 7, 7, 7, -1, &
         -1, 8, 8, 8, 8, 8, 8, 8, 8, 8, 10, 9, 11, 8, 8, 8, 8, 8, 8, -1, &
         -1, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10, 10, 9, 9, 9, 9, 9, 9, 9, -1, &
         -1, 10, 10, 10, 10, 10, 10, 10, 10, 11, 10, 11, 11, 10, 10, 10, 10, 10, 10, -1, &
         -1, 11, 11, 11, 11, 11, 11, 11, 12, 12, 12, 12, 12, 11, 11, 11, 11, 11, 11, -1, &
         -1, 12, 14, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 15, 12, -1, &
         -1, 15, 15, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, -1, -1, -1, -1, -1, -1, &
         -1, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, -1, -1, -1, -1, -1, -1, &
         -1, 17, 2, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, -1, -1, -1, -1, -1, -1, &
         -1, 1, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, 17, -1, -1, -1, -1, -1, -1, &
         -1, 13, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, 18, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 15, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 16, 17, 18, 13, -1, &
         -1, 14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 16, 17, 18, 1, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 14, 15, 16, 17, 13, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 12, 12, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 12, 12, 9, 10, 8, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 12, 11, 11, 9, 9, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 8, 11, 9, 10, 12, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 8, 8, 12, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 2, 3, 4, 5, 6, 7, 7, 8, 9, 10, 11, 13, 14, 15, 16, 17, 18, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 16, 17, 15, 18, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 1, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 13, 13, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, 14, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
          1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3 /), &
         (/nlon,nlat/)))
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(1))
      connect_merge_and_redirect_indices_collections => null()
      flood_index = 1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      15, &
                                      15, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(14,18) = flood_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0
      allocate(runoff(4,4))
      runoff = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 15.0/86400.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(drainages(4,4,10000))
      allocate(runoffs(4,4,10000))
      do i = 1,10000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 1.0
      allocate(lake_evaporations(3,3,10000))
      do i = 1,10000
        lake_evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  1459.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0, 0.0, 0.0, 0.0, 0.0 /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(4,4))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))

      allocate(expected_lake_volumes_all_timesteps(1,500))
      expected_lake_volumes_all_timesteps = reshape((/ &
        1455.04, 1451.08, 1447.13, 1443.17, 1439.21, 1435.25, 1431.29, &
        1427.33, 1423.38, 1419.42, 1415.46, 1411.5, 1407.54, 1403.58, &
        1399.63, 1395.67, 1391.71, 1387.75, 1383.79, 1379.83, 1375.88, &
        1371.92, 1367.96, 1364.0, 1360.04, 1356.08, 1352.13, 1348.17, &
        1344.21, 1340.25, 1336.29, 1332.33, 1328.38, 1324.42, 1320.46, &
        1316.5, 1312.54, 1308.58, 1304.63, 1300.67, 1296.71, 1292.75, &
        1288.79, 1284.83, 1280.88, 1276.92, 1272.96, 1269.0, 1265.04, &
        1261.08, 1257.13, 1253.17, 1249.21, 1245.25, 1241.29, 1237.33, &
        1233.38, 1229.42, 1225.46, 1221.5, 1217.54, 1213.58, 1209.63, &
        1205.67, 1201.71, 1197.75, 1193.79, 1189.83, 1185.88, 1181.92, &
        1177.96, 1174.0, 1170.04, 1166.08, 1162.13, 1158.17, 1154.21, &
        1150.25, 1146.29, 1142.33, 1138.38, 1134.42, 1130.46, 1126.5, &
        1122.54, 1118.58, 1114.63, 1110.67, 1106.71, 1102.75, 1098.79, &
        1094.83, 1090.88, 1086.92, 1082.96, 1079.0, 1075.04, 1071.08, &
        1067.13, 1063.17, 1059.21, 1055.25, 1051.29, 1047.33, 1043.38, &
        1039.42, 1035.46, 1031.5, 1027.54, 1023.58, 1019.63, 1015.67, &
        1011.71, 1007.75, 1003.79, 999.833, 995.875, 991.917, 987.958, &
        984.0, 980.042, 976.083, 972.125, 968.167, 964.208, 960.25, &
        956.292, 952.333, 948.375, 944.417, 940.458, 936.5, 932.542, &
        928.583, 924.625, 920.667, 916.708, 912.75, 908.792, 904.833, &
        900.875, 896.917, 892.958, 889.0, 885.042, 881.083, 877.125, &
        873.167, 869.208, 865.25, 861.292, 857.333, 853.375, 849.417, &
        845.458, 841.5, 837.542, 833.583, 829.625, 825.667, 821.708, &
        817.75, 813.792, 809.833, 805.875, 801.917, 797.958, 794.0, &
        790.042, 786.083, 782.125, 778.167, 774.208, 770.25, 766.292, &
        762.333, 758.375, 754.417, 750.458, 746.5, 742.542, 738.583, &
        734.625, 730.667, 726.708, 722.75, 718.792, 714.833, 710.875, &
        706.917, 702.958, 699.0, 695.042, 691.083, 687.125, 683.167, &
        679.208, 675.25, 671.292, 667.333, 663.375, 659.417, 655.458, &
        651.5, 647.542, 643.583, 639.625, 635.667, 631.708, 627.75, &
        623.792, 619.833, 615.875, 611.917, 607.958, 604.0, 600.042, &
        596.083, 592.125, 588.167, 584.208, 580.25, 576.292, 572.333, &
        574.083, 570.125, 571.875, 573.625, 575.375, 571.417, 573.167, &
        574.917, 570.958, 572.708, 574.458, 570.5, 572.25, 574.0, 570.042, &
        571.792, 573.542, 575.292, 571.333, 573.083, 574.833, 570.875, &
        572.625, 574.375, 570.417, 572.167, 573.917, 575.667, 571.708, &
        573.458, 575.208, 571.25, 573.0, 574.75, 570.792, 572.542, &
        574.292, 570.333, 572.083, 573.833, 575.583, 571.625, 573.375, &
        575.125, 571.167, 572.917, 574.667, 570.708, 572.458, 574.208, &
        570.25, 572.0, 573.75, 575.5, 571.542, 573.292, 575.042, 571.083, &
        572.833, 574.583, 570.625, 572.375, 574.125, 570.167, 571.917, &
        573.667, 575.417, 571.458, 573.208, 574.958, 571.0, 572.75, &
        574.5, 570.542, 572.292, 574.042, 570.083, 571.833, 573.583, &
        575.333, 571.375, 573.125, 574.875, 570.917, 572.667, 574.417, &
        570.458, 572.208, 573.958, 575.708, 571.75, 573.5, 575.25, &
        571.292, 573.042, 574.792, 570.833, 572.583, 574.333, 570.375, &
        572.125, 573.875, 575.625, 571.667, 573.417, 575.167, 571.208, &
        572.958, 574.708, 570.75, 572.5, 574.25, 570.292, 572.042, 573.792, &
        575.542, 571.583, 573.333, 575.083, 571.125, 572.875, 574.625, &
        570.667, 572.417, 574.167, 570.208, 571.958, 573.708, 575.458, 571.5, &
        573.25, 575.0, 571.042, 572.792, 574.542, 570.583, 572.333, 574.083, &
        570.125, 571.875, 573.625, 575.375, 571.417, 573.167, 574.917, 570.958, &
        572.708, 574.458, 570.5, 572.25, 574.0, 570.042, 571.792, 573.542, &
        575.292, 571.333, 573.083, 574.833, 570.875, 572.625, 574.375, 570.417, &
        572.167, 573.917, 575.667, 571.708, 573.458, 575.208, 571.25, 573.0, &
        574.75, 570.792, 572.542, 574.292, 570.333, 572.083, 573.833, 575.583, &
        571.625, 573.375, 575.125, 571.167, 572.917, 574.667, 570.708, 572.458, &
        574.208, 570.25, 572.0, 573.75, 575.5, 571.542, 573.292, 575.042, 571.083, &
        572.833, 574.583, 570.625, 572.375, 574.125, 570.167, 571.917, 573.667, &
        575.417, 571.458, 573.208, 574.958, 571.0, 572.75, 574.5, 570.542, 572.292, &
        574.042, 570.083, 571.833, 573.583, 575.333, 571.375, 573.125, 574.875, 570.917, &
        572.667, 574.417, 570.458, 572.208, 573.958, 575.708, 571.75, 573.5, 575.25, &
        571.292, 573.042, 574.792, 570.833, 572.583, 574.333, 570.375, 572.125, 573.875, &
        575.625, 571.667, 573.417, 575.167, 571.208, 572.958, 574.708, 570.75, 572.5, &
        574.25, 570.292, 572.042, 573.792, 575.542, 571.583, 573.333, 575.083, 571.125, &
        572.875, 574.625, 570.667, 572.417, 574.167, 570.208, 571.958, 573.708, 575.458, &
        571.5, 573.25, 575.0, 571.042, 572.792, 574.542, 570.583, 572.333, 574.083, 570.125 /), &
         (/1,500/))
      allocate(lake_volumes_all_timesteps(1,500))
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(500,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in, &
                            "",lake_volumes_all_timesteps)
      call assert_equals(lake_volumes_all_timesteps,expected_lake_volumes_all_timesteps, &
                         1,500,0.01_dp)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(lake_evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(lake_volumes_all_timesteps)
      deallocate(expected_lake_volumes_all_timesteps)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel16

subroutine testLakeModel17
   use latlon_hd_model_interface_mod
   use latlon_hd_model_mod
   use latlon_lake_model_io_mod, only: add_offset
   type(riverparameters), pointer :: river_parameters
   type(lakeparameters),pointer :: lake_parameters
   type(lakefields), pointer :: lake_fields_out
   type(riverprognosticfields), pointer :: river_fields
   type(lakeprognostics), pointer :: lake_prognostics_out
   type(lakepointer) :: working_lake_ptr
   real(dp),dimension(:,:), pointer :: flow_directions
   integer,dimension(:,:), pointer :: river_reservoir_nums
   integer,dimension(:,:), pointer :: overland_reservoir_nums
   integer,dimension(:,:), pointer :: base_reservoir_nums
   real(dp),dimension(:,:), pointer :: river_retention_coefficients
   real(dp),dimension(:,:), pointer :: overland_retention_coefficients
   real(dp),dimension(:,:), pointer :: base_retention_coefficients
   logical,dimension(:,:), pointer :: landsea_mask
   logical,dimension(:,:), pointer :: lake_centers
   real(dp),dimension(:,:), pointer :: connection_volume_thresholds
   real(dp),dimension(:,:), pointer :: flood_volume_thresholds
   real(dp),dimension(:,:), pointer :: cell_areas_on_surface_model_grid
   integer,dimension(:,:), pointer :: flood_next_cell_lat_index
   integer,dimension(:,:), pointer :: flood_next_cell_lon_index
   integer,dimension(:,:), pointer :: connect_next_cell_lat_index
   integer,dimension(:,:), pointer :: connect_next_cell_lon_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
   integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
   real(dp),dimension(:,:), pointer :: drainage
   real(dp),dimension(:,:), pointer :: runoff
   real(dp),dimension(:,:), pointer :: evaporation
   real(dp),dimension(:,:), pointer :: initial_water_to_lake_centers
   real(dp),dimension(:,:), pointer :: initial_spillover_to_rivers
   real(dp),dimension(:,:), pointer :: expected_river_inflow
   real(dp),dimension(:,:), pointer :: expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: expected_water_to_hd
   integer,dimension(:,:), pointer :: expected_lake_numbers
   integer,dimension(:,:), pointer :: expected_lake_types
   real(dp),dimension(:,:), pointer :: expected_diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: expected_lake_volumes
   real(dp),dimension(:,:), pointer :: expected_lake_fractions
   integer,dimension(:,:), pointer :: expected_number_lake_cells
   integer,dimension(:,:), pointer :: expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: first_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: first_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: first_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: first_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: second_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: second_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: second_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: second_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: third_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: third_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: third_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: third_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: fourth_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: fourth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:), pointer :: first_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: second_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: third_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: fourth_intermediate_expected_lake_volumes
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: fifth_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: fifth_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: fifth_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: fifth_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: fifth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: sixth_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: sixth_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: sixth_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: sixth_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: sixth_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:,:), pointer :: seventh_intermediate_expected_river_inflow
   real(dp),dimension(:,:), pointer :: seventh_intermediate_expected_water_to_ocean
   real(dp),dimension(:,:), pointer :: seventh_intermediate_expected_water_to_hd
   integer,dimension(:,:), pointer :: seventh_intermediate_expected_lake_numbers
   integer,dimension(:,:), pointer :: seventh_intermediate_expected_lake_types
   real(dp),dimension(:,:), pointer :: seventh_intermediate_expected_diagnostic_lake_volumes
   real(dp),dimension(:,:), pointer :: seventh_intermediate_expected_lake_fractions
   integer,dimension(:,:), pointer :: seventh_intermediate_expected_number_lake_cells
   integer,dimension(:,:), pointer :: seventh_intermediate_expected_number_fine_grid_cells
   real(dp),dimension(:), pointer :: fifth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: sixth_intermediate_expected_lake_volumes
   real(dp),dimension(:), pointer :: seventh_intermediate_expected_lake_volumes
   integer,dimension(:,:), pointer :: lake_types
   real(dp) :: lake_retention_coefficient_local
   logical :: use_realistic_surface_coupling_in
   logical :: instant_throughflow_local
   integer :: i,j
   integer :: nlat,nlon
   integer :: nlat_coarse,nlon_coarse
   integer :: nlat_surface_model,nlon_surface_model
   integer :: lake_number,lake_type
   real(dp),dimension(:,:,:), pointer :: drainages
   real(dp),dimension(:,:,:), pointer :: runoffs
   real(dp),dimension(:,:,:), pointer :: lake_evaporations
   real(dp),dimension(:,:), pointer :: diagnostic_lake_volumes
   real(dp),dimension(:), pointer :: lake_volumes
   real(dp),dimension(:,:), allocatable :: lake_fractions
   integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
   integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
   type(mergeandredirectindicescollection), pointer :: collected_indices
   type(mergeandredirectindices), pointer :: primary_merge
   type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
   type(mergeandredirectindices), pointer :: secondary_merge
   real(dp),dimension(:,:), pointer :: lake_volumes_all_timesteps
   real(dp),dimension(:,:), pointer :: expected_lake_volumes_all_timesteps
   integer :: connect_index
   integer :: flood_index
      use_realistic_surface_coupling_in = .true.
      nlat_coarse = 4
      nlon_coarse = 4
      nlat_surface_model = 3
      nlon_surface_model = 3
      allocate(lake_fractions(nlat_surface_model,nlon_surface_model))
      allocate(flow_directions(4,4))
      flow_directions = transpose(reshape((/5,5,5,5,&
                                            2,2,5,5,&
                                            5,4,8,8,&
                                            8,7,4,0 /), &
                                            (/nlon_coarse, &
                                              nlat_coarse/)))
      allocate(river_reservoir_nums(4,4))
      river_reservoir_nums(:,:) = 5
      allocate(overland_reservoir_nums(4,4))
      overland_reservoir_nums(:,:) = 1
      allocate(base_reservoir_nums(4,4))
      base_reservoir_nums(:,:) = 1
      allocate(river_retention_coefficients(4,4))
      river_retention_coefficients(:,:) = 0.0
      allocate(overland_retention_coefficients(4,4))
      overland_retention_coefficients(:,:) = 0.0
      allocate(base_retention_coefficients(4,4))
      base_retention_coefficients(:,:) = 0.0
      allocate(landsea_mask(4,4))
      landsea_mask(:,:) = .False.
      river_reservoir_nums(4,4) = 0
      overland_reservoir_nums(4,4) = 0
      base_reservoir_nums(4,4) = 0
      landsea_mask(4,4) = .True.
      river_parameters => RiverParameters(flow_directions, &
                                          river_reservoir_nums, &
                                          overland_reservoir_nums, &
                                          base_reservoir_nums, &
                                          river_retention_coefficients, &
                                          overland_retention_coefficients, &
                                          base_retention_coefficients, &
                                          landsea_mask)
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      nlat = 20
      nlon = 20
      allocate(lake_centers(nlat,nlon))
      lake_centers = transpose(reshape((/ &
          .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False.,&
            .False., .False., .False., .False., .False.,&
              .False., .False., .False., .False., .False., &
         .False., .False., .False.,  .True., .False.,  .False., .False.,  .True., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False.,  .True., .False., .False., .False., &
         .False.,  .True., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False.,  .True., .False., .False., .False., &
            .False., .True., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False.,  .True., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False., &
         .False., .False., .False., .False., .False.,  .False., .False., .False., .False., .False., &
          .False., .False., .False., .False., .False., &
            .False., .False., .False., .False., .False. /), &
         (/nlon,nlat/)))
      allocate(connection_volume_thresholds(nlat,nlon))
      connection_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,&
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 101.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0 /), &
         (/nlon,nlat/)))
      allocate(flood_volume_thresholds(nlat,nlon))
      flood_volume_thresholds = transpose(reshape((/ &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, 0.0, 0.0, 27.0, -1.0, 0.0, 0.0, -1.0, 0.0, &
           0.0, 0.0, 104.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, 0.0, 0.0, 0.0, 204.0, 0.0, 0.0, 0.0, 0.0,   &
           0.0, 0.0, 0.0, 204.0, 173.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, 0.0, 0.0, 0.0, -1.0, 0.0, 0.0, 0.0, 0.0,    &
           0.0, 0.0, 0.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, 48.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, -1.0, 82.0, -1.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, -1.0, 149.0, -1.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, 0.0, 0.0, 0.0, -1.0, -1.0, 0.0, 0.0, 0.0, -1.0, &
         -1.0, 66.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,  &
           -1.0, 18.0, 0.0, 0.0, -1.0, -1.0, 63.0, 0.0, 0.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,  &
           -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -1.0, -1.0,&
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  &
          45.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  &
           0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,  &
           0.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
         -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0,   &
          -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0/), &
         (/nlon,nlat/)))
      allocate(cell_areas_on_surface_model_grid(3,3))
      cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5, 3.0, 2.5, &
         3.0, 4.0, 3.0, &
         2.5, 3.0, 2.5 /), &
         (/3,3/)))
      allocate(flood_next_cell_lat_index(nlat,nlon))
      flood_next_cell_lat_index = transpose(reshape((/ &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, 2, 3, 3, -1, 2, 3, -1, 4, 5, 5, 6, -1, -1, 2, 3, 4, -1, &
         -1, 3, -1, 1, 2, 1, 2, 1, 2, 3, 1, 1, 1, 1, 3, 14, 1, 2, 1, -1, &
         -1, 4, -1, 2, 3, 3, -1, 2, 3, 3, 2, 2, 2, 2, -1, -1, 2, 3, 3, -1, &
         -1, 5, -1, -1, -1, -1, -1, -1, -1, -1, -1, 3, 3, 3, -1, -1, 5, 4, 4, -1, &
         -1, 6, -1, -1, -1, -1, -1, -1, -1, -1, -1, 4, 5, 4, -1, -1, -1, 2, -1, -1, &
         -1, 7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2, -1, -1, -1, 9, 6, 10, -1, &
         -1, 8, -1, -1, -1, -1, -1, -1, -1, -1, -1, 8, 9, 10, -1, -1, 8, 6, 6, -1, &
         -1, 9, -1, -1, -1, -1, -1, -1, -1, -1, -1, 7, 8, 7, -1, -1, 7, 8, 7, -1, &
         -1, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, 8, 9, 9, -1, -1, 8, 9, 9, -1, &
         -1, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 10, 10, -1, -1, 11, 10, 10, -1, &
         -1, 12, -1, -1, -1, -1, -1, -1, -1, -1, -1, 12, 11, 11, -1, -1, 12, 11, 11, -1, &
         -1, 14, -1, -1, -1, -1, -1, -1, -1, -1, -1, 5, 12, 12, -1, -1, 4, 12, 12, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 15, 16, 17, 17, 17, 17, 17, 17, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 14, 15, 14, 17, 14, 14, 14, 14, 14, 17, 17, 13, -1, -1, -1, -1, -1, -1, -1, &
         -1, 15, 16, 16, 15, 15, 15, 15, 15, 15, 15, 15, 15, -1, -1, -1, -1, -1, -1, -1, &
         -1, 14, 16, 17, 17, 16, 16, 16, 16, 16, 16, 16, 16, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
         (/nlon,nlat/)))
      allocate(flood_next_cell_lon_index(nlat,nlon))
      flood_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, 4, 5, 7, -1, 8, 9, -1, 11, 12, 13, 12, -1, -1, 17, 18, 18, -1, &
         -1, 1, -1, 4, 3, 5, 14, 8, 7, 10, 10, 11, 12, 13, 16, 19, 17, 16, 18, -1, &
         -1, 1, -1, 5, 3, 4, -1, 9, 7, 8, 10, 11, 12, 13, -1, -1, 18, 16, 17, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, 13, -1, -1, 17, 16, 17, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 12, 11, 13, -1, -1, -1, 15, -1, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 6, -1, -1, -1, 18, 16, 18, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 12, 13, 13, -1, -1, 17, 17, 18, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 12, 11, 13, -1, -1, 17, 16, 18, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 11, 12, -1, -1, 18, 16, 17, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 11, 12, -1, -1, 18, 16, 17, -1, &
         -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 11, 12, -1, -1, 18, 16, 17, -1, &
         -1, 2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 11, 12, -1, -1, 18, 16, 17, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 2, 3, 4, 5, 6, 7, 8, 9, 10, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 2, 1, 3, 1, 5, 6, 7, 8, 9, 11, 12, 1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 3, 1, 2, 4, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, -1, &
         -1, 4, 4, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1/), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lat_index(nlat,nlon))
      connect_next_cell_lat_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 18, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1/), &
         (/nlon,nlat/)))
      allocate(connect_next_cell_lon_index(nlat,nlon))
      connect_next_cell_lon_index = transpose(reshape((/ &
          -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, 14, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
         -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1/), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
      corresponding_surface_cell_lat_index = transpose(reshape((/ &
            1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, &
         3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
      corresponding_surface_cell_lon_index = transpose(reshape((/ &
          1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, &
         1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3 /), &
         (/nlon,nlat/)))
      lake_retention_coefficient_local=0.1_dp
      instant_throughflow_local=.True.
      call add_offset(flood_next_cell_lat_index,1,(/-1/))
      call add_offset(flood_next_cell_lon_index,1,(/-1/))
      call add_offset(connect_next_cell_lat_index,1,(/-1/))
      call add_offset(connect_next_cell_lon_index,1,(/-1/))
      allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
      connect_merge_and_redirect_indices_index(:,:) =0
      allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
      flood_merge_and_redirect_indices_index(:,:) = 0
      allocate(flood_merge_and_redirect_indices_collections(11))
      allocate(connect_merge_and_redirect_indices_collections(1))
      flood_index = 1
      connect_index = 1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      3, &
                                      7, &
                                      1, &
                                      7)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(2,6) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                11, &
                                7, &
                                11)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(2,14) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      3, &
                                      16, &
                                      1, &
                                      16)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,15) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      14, &
                                      19, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(3,16) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .true., &
                                7, &
                                16, &
                                7, &
                                16)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(5,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                1, &
                                7, &
                                0, &
                                1)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(6,18) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                1, &
                                3, &
                                1, &
                                1)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(7,13) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      14, &
                                      2, &
                                      14, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(13,2) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      5, &
                                      13, &
                                      0, &
                                      1)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(13,12) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .true., &
                                      4, &
                                      18, &
                                      1, &
                                      16)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(13,17) = flood_index
      flood_index = flood_index +1
      primary_merge => &
        mergeandredirectindices(.true., &
                                .false., &
                                2, &
                                1, &
                                2, &
                                0)
      allocate(primary_merges(1))
      primary_merges(1)%ptr => primary_merge
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            null())
      flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
      flood_merge_and_redirect_indices_index(16,13) = flood_index
      flood_index = flood_index +1
      secondary_merge => &
              mergeandredirectindices(.false., &
                                      .false., &
                                      18, &
                                      14, &
                                      3, &
                                      3)
      primary_merges => null()
      collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                            secondary_merge)
      connect_merge_and_redirect_indices_collections(connect_index)%ptr => collected_indices
      connect_merge_and_redirect_indices_index(14,2) = connect_index
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      do i = 1,size(connect_merge_and_redirect_indices_collections)
        collected_indices => connect_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%add_offset_to_collection(1)
      end do
      lake_parameters => LakeParameters(lake_centers, &
                                        connection_volume_thresholds, &
                                        flood_volume_thresholds, &
                                        cell_areas_on_surface_model_grid, &
                                        flood_next_cell_lat_index, &
                                        flood_next_cell_lon_index, &
                                        connect_next_cell_lat_index, &
                                        connect_next_cell_lon_index, &
                                        connect_merge_and_redirect_indices_index, &
                                        flood_merge_and_redirect_indices_index, &
                                        connect_merge_and_redirect_indices_collections, &
                                        flood_merge_and_redirect_indices_collections, &
                                        corresponding_surface_cell_lat_index, &
                                        corresponding_surface_cell_lon_index, &
                                        nlat,nlon, &
                                        nlat_coarse,nlon_coarse, &
                                        nlat_surface_model,nlon_surface_model, &
                                        instant_throughflow_local, &
                                        lake_retention_coefficient_local)
      allocate(drainage(4,4))
      drainage(:,:) = 0.0_dp
      allocate(runoff(4,4))
      runoff(:,:) = 0.0_dp
      allocate(drainages(4,4,10000))
      allocate(runoffs(4,4,10000))
      do i = 1,10000
        drainages(:,:,i) = drainage(:,:)
        runoffs(:,:,i) = runoff(:,:)
      end do
      allocate(evaporation(3,3))
      evaporation(:,:) = 1.0_dp
      allocate(lake_evaporations(3,3,10000))
      do i = 1,10000
        lake_evaporations(:,:,i) = evaporation(:,:)
      end do
      allocate(initial_water_to_lake_centers(nlat,nlon))
      initial_water_to_lake_centers = transpose(reshape((/ &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 27.1, 0.0,  0.0, 0.0, 204.1, 0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 173.1,   0.0, 0.0, 0.0, &
         0.0, 66.1,  0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 18.1,  0.0, 0.0, 0.0, 0.0, 63.1,    0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 101.1, 0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0, &
         0.0, 0.0,   0.0, 0.0,  0.0,  0.0, 0.0, 0.0,   0.0, 0.0,  0.0, 0.0,   0.0, 0.0, 0.0, 0.0, 0.0,     0.0, 0.0, 0.0  /), &
         (/nlon,nlat/)))
      allocate(initial_spillover_to_rivers(4,4))
      initial_spillover_to_rivers = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_river_inflow(4,4))
      expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_water_to_ocean(4,4))
      expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_water_to_hd(4,4))
      expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 0, 0, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 7, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_lake_types(nlat,nlon))
      expected_lake_types = transpose(reshape((/ &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(expected_diagnostic_lake_volumes(nlat,nlon))
      expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(expected_lake_fractions(3,3))
      expected_lake_fractions = transpose(reshape((/ &
          0.1388888889,   0.5416666667,   0.3333333333, &
         0.1458333333,   0.015625,   0.02083333333, &
         0.02777777778,   0.0,   0.0 /), &
         (/3,3/)))
      allocate(expected_number_lake_cells(3,3))
      expected_number_lake_cells = transpose(reshape((/ &
           5,    26,   12, &
           7,    1,    1, &
           1,    0,    0 /), &
         (/3,3/)))
      allocate(expected_number_fine_grid_cells(3,3))
      expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(expected_lake_volumes(7))
      expected_lake_volumes = (/0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0/)

      allocate(expected_lake_volumes_all_timesteps(7,115))
      expected_lake_volumes_all_timesteps = reshape((/ &
                                              66.0, 97.3333, 27.0, 204.0, 18.0, 167.146, 63.0, &
                                              66.0, 93.6667, 27.0, 204.0, 18.0, 161.292, 63.0, &
                                              66.0, 90.0, 27.0, 204.0, 18.0, 155.437, 63.0, &
                                              66.0, 86.3333, 27.0, 204.0, 18.0, 149.583, 63.0, &
                                              66.0, 82.6667, 27.0, 204.0, 18.0, 143.729, 63.0, &
                                              66.0, 79.0, 27.0, 204.0, 18.0, 137.875, 63.0, &
                                              66.0, 75.3333, 27.0, 204.0, 18.0, 132.021, 63.0, &
                                              66.0, 71.6667, 27.0, 204.0, 18.0, 126.167, 63.0, &
                                              66.0, 68.0, 27.0, 204.0, 18.0, 120.312, 63.0, &
                                              66.0, 64.3333, 27.0, 204.0, 18.0, 114.458, 63.0, &
                                              66.0, 60.6667, 27.0, 204.0, 18.0, 108.604, 63.0, &
                                              66.0, 57.0, 27.0, 204.0, 18.0, 102.75, 63.0, &
                                              66.0, 53.3333, 27.0, 204.0, 18.0, 96.8958, 63.0, &
                                              66.0, 49.6667, 27.0, 204.0, 18.0, 91.0417, 63.0, &
                                              66.0, 46.0, 27.0, 204.0, 18.0, 85.1875, 63.0, &
                                              64.6667, 43.6667, 27.0, 203.809, 18.0, 79.5243, 63.0, &
                                              63.9514, 40.7153, 27.0, 200.309, 18.0, 77.309, 63.0, &
                                              63.2361, 37.7639, 27.0, 196.809, 18.0, 75.0937, 63.0, &
                                              62.5208, 34.8125, 27.0, 193.309, 18.0, 72.8785, 63.0, &
                                              61.8056, 31.8611, 27.0, 189.809, 18.0, 70.6632, 63.0, &
                                              61.0903, 28.9097, 27.0, 186.309, 18.0, 68.4479, 63.0, &
                                              60.375, 25.9583, 27.0, 182.809, 18.0, 66.2326, 63.0, &
                                              59.6597, 23.0069, 27.0, 179.309, 18.0, 64.0174, 63.0, &
                                              58.9444, 20.0556, 27.0, 175.809, 18.0, 61.8021, 63.0, &
                                              58.2292, 17.1042, 27.0, 172.309, 18.0, 59.5868, 63.0, &
                                              57.5139, 14.1528, 27.0, 168.809, 18.0, 57.3715, 63.0, &
                                              56.7986, 11.2014, 27.0, 165.309, 18.0, 55.1562, 63.0, &
                                              56.0833, 8.25, 27.0, 161.809, 18.0, 52.941, 63.0, &
                                              55.3681, 5.29861, 27.0, 158.309, 18.0, 50.7257, 63.0, &
                                              54.6528, 2.34722, 27.0, 154.809, 18.0, 48.5104, 63.0, &
                                              53.9375, 0.0, 27.0, 151.309, 18.0, 47.8038, 61.4913, &
                                              53.2222, 0.0, 26.967, 147.842, 18.0, 46.9705, 60.1788, &
                                              52.5069, 0.0, 26.342, 145.03, 18.0, 46.1372, 58.8663, &
                                              51.7917, 0.0, 25.717, 142.217, 18.0, 45.3038, 57.5538, &
                                              51.0764, 0.0, 25.092, 139.405, 18.0, 44.4705, 56.2413, &
                                              50.3611, 0.0, 24.467, 136.592, 18.0, 43.6372, 54.9288, &
                                              49.6458, 0.0, 23.842, 133.78, 18.0, 42.8038, 53.6163, &
                                              48.9306, 0.0, 23.217, 130.967, 18.0, 41.9705, 52.3038, &
                                              48.2153, 0.0, 22.592, 128.155, 18.0, 41.1372, 50.9913, &
                                              47.5, 0.0, 21.967, 125.342, 18.0, 40.3038, 49.6788, &
                                              46.7847, 0.0, 21.342, 122.53, 18.0, 39.4705, 48.3663, &
                                              46.0694, 0.0, 20.717, 119.717, 18.0, 38.6372, 47.0538, &
                                              45.3542, 0.0, 20.092, 116.905, 18.0, 37.8038, 45.7413, &
                                              44.6389, 0.0, 19.467, 114.092, 18.0, 36.9705, 44.4288, &
                                              43.9236, 0.0, 18.842, 111.28, 18.0, 36.1372, 43.1163, &
                                              43.2083, 0.0, 18.217, 108.467, 18.0, 35.3038, 41.8038, &
                                              42.4931, 0.0, 17.592, 105.655, 18.0, 34.4705, 40.4913, &
                                              41.7778, 0.0, 16.967, 103.984, 16.8585, 33.6372, 39.1788, &
                                              41.0625, 0.0, 16.342, 102.359, 15.7335, 32.8038, 37.8663, &
                                              40.3472, 0.0, 15.717, 100.734, 14.6085, 31.9705, 36.5538, &
                                              39.6319, 0.0, 15.092, 99.1085, 13.4835, 31.1372, 35.2413, &
                                              38.9167, 0.0, 14.467, 97.4835, 12.3585, 30.3038, 33.9288, &
                                              38.2014, 0.0, 13.842, 95.8585, 11.2335, 29.4705, 32.6163, &
                                              37.4861, 0.0, 13.217, 94.2335, 10.1085, 28.6372, 31.3038, &
                                              36.7708, 0.0, 12.592, 92.6085, 8.98351, 27.8038, 29.9913, &
                                              36.0556, 0.0, 11.967, 90.9835, 7.85851, 26.9705, 28.6788, &
                                              35.3403, 0.0, 11.342, 89.3585, 6.73351, 26.1372, 27.3663, &
                                              34.625, 0.0, 10.717, 87.7335, 5.60851, 25.3038, 26.0538, &
                                              33.9097, 0.0, 10.092, 86.1085, 4.48351, 24.4705, 24.7413, &
                                              33.1944, 0.0, 9.46701, 84.4835, 3.35851, 23.6372, 23.4288, &
                                              32.4792, 0.0, 8.84201, 82.8585, 2.23351, 22.8038, 22.1163, &
                                              31.7639, 0.0, 8.21701, 81.2335, 1.10851, 21.9705, 20.8038, &
                                              31.0486, 0.0, 7.59201, 79.6085, 0.0, 21.1372, 19.4913, &
                                              30.3333, 0.0, 6.96701, 77.9835, 0.0, 20.3038, 18.1788, &
                                              29.6181, 0.0, 6.34201, 76.3585, 0.0, 19.4705, 16.8663, &
                                              28.9028, 0.0, 5.71701, 74.7335, 0.0, 18.6372, 15.5538, &
                                              28.1875, 0.0, 5.09201, 73.1085, 0.0, 17.8038, 14.2413, &
                                              27.4722, 0.0, 4.46701, 71.4835, 0.0, 16.9705, 12.9288, &
                                              26.7569, 0.0, 3.84201, 69.8585, 0.0, 16.1372, 11.6163, &
                                              26.0417, 0.0, 3.21701, 68.2335, 0.0, 15.3038, 10.3038, &
                                              25.3264, 0.0, 2.59201, 66.6085, 0.0, 14.4705, 8.99132, &
                                              24.6111, 0.0, 1.96701, 64.9835, 0.0, 13.6372, 7.67882, &
                                              23.8958, 0.0, 1.34201, 63.3585, 0.0, 12.8038, 6.36632, &
                                              23.1806, 0.0, 0.717014, 61.7335, 0.0, 11.9705, 5.05382, &
                                              22.4653, 0.0, 0.0920139, 60.1085, 0.0, 11.1372, 3.74132, &
                                              21.75, 0.0, 0.0, 58.4835, 0.0, 10.3038, 2.42882, &
                                              21.0347, 0.0, 0.0, 56.8585, 0.0, 9.47049, 1.11632, &
                                              20.3194, 0.0, 0.0, 55.2335, 0.0, 8.63715, 6.66134e-16, &
                                              19.6042, 0.0, 0.0, 53.6085, 0.0, 7.80382, 1.97215e-31, &
                                              18.8889, 0.0, 0.0, 51.9835, 0.0, 6.97049, 0.0, &
                                              18.1736, 0.0, 0.0, 50.3585, 0.0, 6.13715, 0.0, &
                                              17.4583, 0.0, 0.0, 48.7335, 0.0, 5.30382, 0.0, &
                                              16.7431, 0.0, 0.0, 47.1085, 0.0, 4.47049, 0.0, &
                                              16.0278, 0.0, 0.0, 45.4835, 0.0, 3.63715, 0.0, &
                                              15.3125, 0.0, 0.0, 43.8585, 0.0, 2.80382, 0.0, &
                                              14.5972, 0.0, 0.0, 42.2335, 0.0, 1.97049, 0.0, &
                                              13.8819, 0.0, 0.0, 40.6085, 0.0, 1.13715, 0.0, &
                                              13.1667, 0.0, 0.0, 38.9835, 0.0, 0.303819, 0.0, &
                                              12.4514, 0.0, 0.0, 37.3585, 0.0, 0.0, 0.0, &
                                              11.7361, 0.0, 0.0, 35.7335, 0.0, 0.0, 0.0, &
                                              11.0208, 0.0, 0.0, 34.1085, 0.0, 0.0, 0.0, &
                                              10.3056, 0.0, 0.0, 32.4835, 0.0, 0.0, 0.0, &
                                              9.59028, 0.0, 0.0, 30.8585, 0.0, 0.0, 0.0, &
                                              8.875, 0.0, 0.0, 29.2335, 0.0, 0.0, 0.0, &
                                              8.15972, 0.0, 0.0, 27.6085, 0.0, 0.0, 0.0, &
                                              7.44444, 0.0, 0.0, 25.9835, 0.0, 0.0, 0.0, &
                                              6.72917, 0.0, 0.0, 24.3585, 0.0, 0.0, 0.0, &
                                              6.01389, 0.0, 0.0, 22.7335, 0.0, 0.0, 0.0, &
                                              5.29861, 0.0, 0.0, 21.1085, 0.0, 0.0, 0.0, &
                                              4.58333, 0.0, 0.0, 19.4835, 0.0, 0.0, 0.0, &
                                              3.86806, 0.0, 0.0, 17.8585, 0.0, 0.0, 0.0, &
                                              3.15278, 0.0, 0.0, 16.2335, 0.0, 0.0, 0.0, &
                                              2.4375, 0.0, 0.0, 14.6085, 0.0, 0.0, 0.0, &
                                              1.72222, 0.0, 0.0, 12.9835, 0.0, 0.0, 0.0, &
                                              1.00694, 0.0, 0.0, 11.3585, 0.0, 0.0, 0.0, &
                                              0.291667, 0.0, 0.0, 9.73351, 0.0, 0.0, 0.0, &
                                              0.0212121, 0.0, 0.0, 8.10851, 0.0, 0.0, 0.0, &
                                              0.0015427, 0.0, 0.0, 6.48351, 0.0, 0.0, 0.0, &
                                              0.000112196, 0.0, 0.0, 4.85851, 0.0, 0.0, 0.0, &
                                              8.15973e-6, 0.0, 0.0, 3.23351, 0.0, 0.0, 0.0, &
                                              5.93435e-7, 0.0, 0.0, 1.60851, 0.0, 0.0, 0.0, &
                                              4.31589e-8, 0.0, 0.0, 1.33227e-15, 0.0, 0.0, 0.0, &
                                              3.13883e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
                                              2.28279e-10, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
                                              1.66021e-11, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 /), &
                                              (/7,115/))
      allocate(first_intermediate_expected_river_inflow(4,4))
      first_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(first_intermediate_expected_water_to_ocean(4,4))
      first_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(first_intermediate_expected_water_to_hd(4,4))
      first_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.7  /), &
         (/4,4/)))
      first_intermediate_expected_water_to_hd = &
        first_intermediate_expected_water_to_hd/86400.0_dp
      allocate(first_intermediate_expected_lake_numbers(nlat,nlon))
      first_intermediate_expected_lake_numbers = transpose(reshape((/ &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 6, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 6, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_types(nlat,nlon))
      first_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 3, 3, 0, 3, 3, 3, 3, 0, 0, 2, 2, 2, 0, &
         0, 3, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 0, &
         0, 3, 0, 3, 3, 3, 0, 3, 3, 3, 3, 3, 3, 3, 0, 0, 2, 2, 2, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 2, 2, 2, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 2, 0, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      first_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
           0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,&
              0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0, 485.0, 485.0, 485.0,   0.0, 485.0, 485.0,   0.0, 485.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0,  &
          485.0, 485.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0, 485.0, 485.0, 485.0,   0.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0,   0.0, 485.0,   0.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0,   0.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 485.0, 485.0, 485.0,  &
          0.0,   0.0, 485.0, 485.0, 485.0,   0.0, &
         0.0, 167.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0,   0.0,   0.0,   0.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0, 167.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0   /), &
         (/nlon,nlat/)))
      allocate(first_intermediate_expected_lake_fractions(3,3))
      first_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.3611111111, 0.5625, 0.4166666667, &
         0.1458333333, 0.296875, 0.4375, &
         0.5555555556, 0.5208333333, 0.0/), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_lake_cells(3,3))
      first_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          13, 27, 15, &
         7, 19, 21, &
         20, 25, 0/), &
         (/3,3/)))
      allocate(first_intermediate_expected_number_fine_grid_cells(3,3))
      first_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(first_intermediate_expected_lake_volumes(7))
      first_intermediate_expected_lake_volumes = (/66.0, 101.0, 27.0, 204.0, 18.0, 173.0, 63.0/)
      allocate(second_intermediate_expected_river_inflow(4,4))
      second_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(second_intermediate_expected_water_to_ocean(4,4))
      second_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(second_intermediate_expected_water_to_hd(4,4))
      second_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(second_intermediate_expected_lake_numbers(nlat,nlon))
      second_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 6, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 6, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_types(nlat,nlon))
      second_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 3, 3, 0, 3, 3, 3, 3, 0, 0, 1, 1, 1, 0, &
         0, 3, 0, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 0, &
         0, 3, 0, 3, 3, 3, 0, 3, 3, 3, 3, 3, 3, 3, 0, 0, 1, 1, 1, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 1, 1, 1, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 0, 1, 0, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
      second_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,   0.0,   0.0, 397.19, 397.19, 397.19,   0.00, 397.19, 397.19,   0.00, 397.19, 397.19,&
          397.19, 397.19,   0.0,   0.0,  397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0, 397.19, 397.19, 397.19, 397.19, 397.19, 397.19, 397.19, 397.19, 397.19,&
          397.19, 397.19, 397.19, 397.19, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0, 397.19, 397.19, 397.19,   0.00, 397.19, 397.19, 397.19, 397.19, 397.19,&
          397.19, 397.19,  0.0,   0.0,  397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0,   0.0,  397.19,    0.0,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, &
            0.0,    0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 397.19, 397.19,&
          397.19,   0.0,    0.0, 397.19, 397.19, 397.19,   0.0, &
         0.0, 112.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0, &
         0.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0,   0.0,   0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0, &
         0.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0,  112.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0, &
         0.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0,  112.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0, &
         0.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0, 112.0,  112.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0, &
         0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,   0.0  /), &
         (/nlon,nlat/)))
      allocate(second_intermediate_expected_lake_fractions(3,3))
      second_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.3611111111, 0.5625, 0.4166666667, &
         0.1458333333, 0.296875, 0.4375, &
         0.5555555556, 0.5208333333, 0.0 /), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_lake_cells(3,3))
      second_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          13, 27, 15, &
         7, 19, 21, &
         20, 25, 0/), &
         (/3,3/)))
      allocate(second_intermediate_expected_number_fine_grid_cells(3,3))
      second_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(second_intermediate_expected_lake_volumes(7))
      second_intermediate_expected_lake_volumes = (/66.0, 46.0, 27.0, 204.0, 18.0, 85.1875, 63.0 /)

      allocate(third_intermediate_expected_river_inflow(4,4))
      third_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(third_intermediate_expected_water_to_ocean(4,4))
      third_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(third_intermediate_expected_water_to_hd(4,4))
      third_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(third_intermediate_expected_lake_numbers(nlat,nlon))
      third_intermediate_expected_lake_numbers = transpose(reshape((/ &
           0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 6, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_lake_types(nlat,nlon))
      third_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 3, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 3, 3, 3, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/nlon,nlat/)))
      allocate(third_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
#ifdef TRANSPOSED_LAKE_MODEL
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
              0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,     &
                 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0,   0.0, &
         0.0,  0.0,   0.0, 247.76, 247.76, 247.76,   0.0, 247.76, 247.76,   0.00, 247.76,   &
          247.76, 247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0, 247.76, 247.76, 247.76, 247.76, 247.76, 247.76, 247.76, 247.76,  &
          247.76, 247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0, 247.76, 247.76, 247.76,   0.0, 247.76, 247.76, 247.76, 247.76,   &
          247.76, 247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0,   0.0, 143.57,   0.0,     0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
          247.76,   0.0,     0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 247.76,  &
          247.76, 247.76,   0.0,   0.0, 143.57, 143.57, 143.57,   0.0, &
         0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,   0.0, &
           0.0,   0.0,      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,&
           43.67,  43.67,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,&
           43.67,  43.67,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,&
           43.67,  43.67,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0   /), &
         (/nlon,nlat/)))
#else
      third_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
              0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,     &
                 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0,   0.0, &
         0.0,  0.0,   0.0, 248.81, 248.81, 248.81,   0.0, 248.81, 248.81,   0.00, 248.81,   &
          248.81, 248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0, 248.81, 248.81, 248.81, 248.81, 248.81, 248.81, 248.81, 248.81,  &
          248.81, 248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0, 248.81, 248.81, 248.81,   0.0, 248.81, 248.81, 248.81, 248.81,   &
          248.81, 248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0,   0.0, 142.52,   0.0,     0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
          248.81,   0.0,     0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0, 64.67,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 248.81,  &
          248.81, 248.81,   0.0,   0.0, 142.52, 142.52, 142.52,   0.0, &
         0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
          0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,   0.0, &
           0.0,   0.0,      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,&
           43.67,  43.67,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,&
           43.67,  43.67,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0, 43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,  43.67,&
           43.67,  43.67,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, &
         0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   &
            0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0   /), &
         (/nlon,nlat/)))
#endif
      allocate(third_intermediate_expected_lake_fractions(3,3))
      third_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.3611111111, 0.5625,   0.3611111111, &
         0.1458333333, 0.296875, 0.4375, &
         0.5555555556, 0.5208333333, 0.0 /), &
         (/3,3/)))
      allocate(third_intermediate_expected_number_lake_cells(3,3))
      third_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          13, 27, 13, &
         7, 19, 21, &
         20, 25, 0/), &
         (/3,3/)))
      allocate(third_intermediate_expected_number_fine_grid_cells(3,3))
      third_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(third_intermediate_expected_lake_volumes(7))
      third_intermediate_expected_lake_volumes = (/64.6667, 43.6667, 27.0, 203.809, 18.0, 79.5243, 63.0/)
#ifdef TRANSPOSED_LAKE_MODEL
      third_intermediate_expected_lake_volumes(4) = third_intermediate_expected_lake_volumes(4) &
                                                     - 1.048588769
      third_intermediate_expected_lake_volumes(6) = third_intermediate_expected_lake_volumes(6) &
                                                     + 1.048588769
#endif

      allocate(fourth_intermediate_expected_river_inflow(4,4))
      fourth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fourth_intermediate_expected_water_to_ocean(4,4))
      fourth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fourth_intermediate_expected_water_to_hd(4,4))
      fourth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fourth_intermediate_expected_lake_numbers(nlat,nlon))
      fourth_intermediate_expected_lake_numbers = transpose(reshape((/ &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 3, 3, 3, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 6, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 0, 0, 7, 7, 7, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  /), &
         (/nlon,nlat/)))
      allocate(fourth_intermediate_expected_lake_types(nlat,nlon))
      fourth_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 3, 3, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 3, 3, 3, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 3, 3, 3, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0, 3, 3, 3, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0   /), &
         (/nlon,nlat/)))
      allocate(fourth_intermediate_expected_diagnostic_lake_volumes(nlat,nlon))
#ifdef TRANSPOSED_LAKE_MODEL
      fourth_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
              0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    &
              0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,   0.0,    0.0,  244.26, 244.26, 244.26,   0.0,  244.26, 244.26,   0.0,  244.26,&
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,  244.26, 244.26, 244.26, 244.26, 244.26, 244.26, 244.26, 244.26,&
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,  244.26, 244.26, 244.26,   0.00, 244.26, 244.26, 244.26, 244.26,&
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,    0.0,  141.35,   0.0,    0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,  244.26,   0.0,    0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          244.26, 244.26, 244.26,   0.0,    0.0,  141.35, 141.35, 141.35,   0.0, &
         0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,   0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,&
           40.72,  40.72,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,&
           40.72,  40.72,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,&
           40.72,  40.72,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0  /), &
         (/nlon,nlat/)))
#else
      fourth_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
              0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    &
              0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,   0.0,    0.0,  245.31, 245.31, 245.31,   0.0,  245.31, 245.31,   0.0,  245.31,&
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,  245.31, 245.31, 245.31, 245.31, 245.31, 245.31, 245.31, 245.31,&
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,  245.31, 245.31, 245.31,   0.00, 245.31, 245.31, 245.31, 245.31,&
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,    0.0,  140.31,   0.0,    0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,  245.31,   0.0,    0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,  63.95,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
          245.31, 245.31, 245.31,   0.0,    0.0,  140.31, 140.31, 140.31,   0.0, &
         0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,   0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,&
           40.72,  40.72,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,&
           40.72,  40.72,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,  40.72,&
           40.72,  40.72,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
         0.0,   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0, &
            0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0  /), &
         (/nlon,nlat/)))
#endif
        allocate(fourth_intermediate_expected_lake_fractions(3,3))
        fourth_intermediate_expected_lake_fractions = transpose(reshape((/ &
            0.3611111111, 0.5625,   0.3611111111, &
           0.1458333333, 0.296875, 0.4375, &
           0.5555555556, 0.5208333333, 0.0 /), &
           (/3,3/)))
        allocate(fourth_intermediate_expected_number_lake_cells(3,3))
      fourth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          13, 27, 13, &
         7, 19, 21, &
         20, 25, 0/), &
         (/3,3/)))
      allocate(fourth_intermediate_expected_number_fine_grid_cells(3,3))
      fourth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(fourth_intermediate_expected_lake_volumes(7))
      fourth_intermediate_expected_lake_volumes= (/63.9514, 40.7153, 27.0, 200.309, 18.0, 77.309, 63.0/)
#ifdef TRANSPOSED_LAKE_MODEL
      fourth_intermediate_expected_lake_volumes(4) = fourth_intermediate_expected_lake_volumes(4) &
                                                     - 1.048588769
      fourth_intermediate_expected_lake_volumes(6) = fourth_intermediate_expected_lake_volumes(6) &
                                                     + 1.048588769
#endif

      allocate(fifth_intermediate_expected_river_inflow(4,4))
      fifth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fifth_intermediate_expected_water_to_ocean(4,4))
      fifth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fifth_intermediate_expected_water_to_hd(4,4))
      fifth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(fifth_intermediate_expected_lake_numbers(20,20))
      fifth_intermediate_expected_lake_numbers = transpose(reshape((/ &
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 0, 0, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 7, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(fifth_intermediate_expected_lake_types(20,20))
      fifth_intermediate_expected_lake_types = transpose(reshape((/ &
             0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(fifth_intermediate_expected_diagnostic_lake_volumes(20,20))
      fifth_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,  0.0,   0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 47.11, 47.11,  0.0,  47.11, 47.11, 47.11, 47.11, 0.0, 0.0, 4.47, 4.47, 4.47, 0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0, 47.11, 47.11, 47.11, 47.11, 47.11, 47.11, 47.11, 0.0, 0.0, 4.47, 4.47, 4.47, 0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0, 47.11, 47.11, 47.11, 47.11, 47.11, 47.11, 47.11, 0.0, 0.0, 4.47, 4.47, 4.47, 0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,   47.11, 47.11, 47.11, 0.0, 0.0, 4.47, 4.47, 4.47, 0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,   47.11, 47.11, 47.11, 0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0, 16.74, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,  0.0,    0.0,   0.0,   0.0,  0.0, 0.0, 0.0,  0.0, 0.0, 0.0 /), &
         (/20,20/)))
      allocate(fifth_intermediate_expected_lake_fractions(3,3))
      fifth_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.1388888889,   0.5416666667,   0.3333333333, &
         0.1458333333,   0.015625,   0.02083333333, &
         0.02777777778,   0.0,   0.0 /), &
         (/3,3/)))
      allocate(fifth_intermediate_expected_number_lake_cells(3,3))
      fifth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
           5, 26, 12, &
         7,  1,  1, &
         1,  0, 0 /), &
         (/3,3/)))
      allocate(fifth_intermediate_expected_number_fine_grid_cells(3,3))
      fifth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(fifth_intermediate_expected_lake_volumes(7))
      fifth_intermediate_expected_lake_volumes= (/16.7431, 0.0, 0.0, 47.1085, 0.0, 4.47049, 0.0/)

      allocate(sixth_intermediate_expected_river_inflow(4,4))
      sixth_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(sixth_intermediate_expected_water_to_ocean(4,4))
      sixth_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(sixth_intermediate_expected_water_to_hd(4,4))
      sixth_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(sixth_intermediate_expected_lake_numbers(20,20))
      sixth_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 0, 0, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 7, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(sixth_intermediate_expected_lake_types(20,20))
      sixth_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0/), &
         (/20,20/)))
      allocate(sixth_intermediate_expected_diagnostic_lake_volumes(20,20))
      sixth_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0, 0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 45.48, 45.48,  0.0,  45.48, 45.48, 45.48, 45.48, 0.0, 0.0, 3.64,  3.64, 3.64, 0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0, 45.48, 45.48, 45.48, 45.48, 45.48, 45.48, 45.48, 0.0, 0.0, 3.64,  3.64, 3.64, 0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0, 45.48, 45.48, 45.48, 45.48, 45.48, 45.48, 45.48, 0.0, 0.0, 3.64,  3.64, 3.64, 0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,  45.48, 45.48, 45.48, 0.0, 0.0, 3.64,  3.64, 3.64, 0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,  45.48, 45.48, 45.48, 0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0, 16.03, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0,   0.0,  0.0,  0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0,0.0  /), &
         (/20,20/)))
      allocate(sixth_intermediate_expected_lake_fractions(3,3))
      sixth_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.1388888889,   0.5416666667,   0.3333333333, &
         0.1458333333,   0.015625,   0.02083333333, &
         0.02777777778,   0.0,   0.0  /), &
         (/3,3/)))
      allocate(sixth_intermediate_expected_number_lake_cells(3,3))
      sixth_intermediate_expected_number_lake_cells = transpose(reshape((/ &
          5, 26, 12, &
         7,  1, 1, &
         1,  0, 0 /), &
         (/3,3/)))
      allocate(sixth_intermediate_expected_number_fine_grid_cells(3,3))
      sixth_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(sixth_intermediate_expected_lake_volumes(7))
      sixth_intermediate_expected_lake_volumes= (/16.0278, 0.0, 0.0, 45.4835, 0.0, 3.63715, 0.0/)

      allocate(seventh_intermediate_expected_river_inflow(4,4))
      seventh_intermediate_expected_river_inflow = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(seventh_intermediate_expected_water_to_ocean(4,4))
      seventh_intermediate_expected_water_to_ocean = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(seventh_intermediate_expected_water_to_hd(4,4))
      seventh_intermediate_expected_water_to_hd = transpose(reshape((/ &
          0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0, &
         0.0, 0.0, 0.0, 0.0 /), &
         (/4,4/)))
      allocate(seventh_intermediate_expected_lake_numbers(20,20))
      seventh_intermediate_expected_lake_numbers = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 3, 0, 0, 0, 4, 4, 0, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 4, 4, 4, 4, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 6, 6, 6, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 4, 4, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 0, 0, 0, 0, 7, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(seventh_intermediate_expected_lake_types(20,20))
      seventh_intermediate_expected_lake_types = transpose(reshape((/ &
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
         0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
         (/20,20/)))
      allocate(seventh_intermediate_expected_diagnostic_lake_volumes(20,20))
      seventh_intermediate_expected_diagnostic_lake_volumes = transpose(reshape((/ &
          0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 43.86, 43.86,  0.00, 43.86, 43.86, 43.86, 43.86, 0.0, 0.0, 2.8, 2.8, 2.8, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0, 43.86, 43.86, 43.86, 43.86, 43.86, 43.86, 43.86, 0.0, 0.0, 2.8, 2.8, 2.8, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0, 43.86, 43.86, 43.86, 43.86, 43.86, 43.86, 43.86, 0.0, 0.0, 2.8, 2.8, 2.8, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,  43.86, 43.86, 43.86, 0.0, 0.0, 2.8, 2.8, 2.8, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,  43.86, 43.86, 43.86, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0, 15.31, 0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, &
         0.0,  0.0,  0.0, 0.0, 0.0, 0.0, 0.0,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,  0.0, 0.0, 0.0, 0.0, 0.0, 0.0  /), &
         (/20,20/)))
      allocate(seventh_intermediate_expected_lake_fractions(3,3))
      seventh_intermediate_expected_lake_fractions = transpose(reshape((/ &
          0.1388888889,   0.5416666667,   0.3333333333, &
         0.1458333333,   0.015625,   0.02083333333, &
         0.02777777778,   0.0,   0.0  /), &
         (/3,3/)))
      allocate(seventh_intermediate_expected_number_lake_cells(3,3))
      seventh_intermediate_expected_number_lake_cells = transpose(reshape((/ &
           5, 26, 12, &
         7,  1,  1, &
         1,  0, 0 /), &
         (/3,3/)))
      allocate(seventh_intermediate_expected_number_fine_grid_cells(3,3))
      seventh_intermediate_expected_number_fine_grid_cells = transpose(reshape((/ &
          36, 48, 36, &
         48, 64, 48, &
         36, 48, 36  /), &
         (/3,3/)))
      allocate(seventh_intermediate_expected_lake_volumes(7))
      seventh_intermediate_expected_lake_volumes= (/15.3125, 0.0, 0.0, 43.8585, 0.0, 2.80382, 0.0/)

      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(0,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      allocate(lake_types(nlat,nlon))
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      allocate(lake_volumes(7))
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(first_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(first_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(first_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.00001_dp)
      call assert_equals(first_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(first_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(first_intermediate_expected_lake_volumes,lake_volumes,7)
      call assert_equals(diagnostic_lake_volumes,&
                         first_intermediate_expected_diagnostic_lake_volumes,20,20)
      call assert_equals(first_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(first_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(first_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(15,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(second_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(second_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(second_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(second_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(second_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(second_intermediate_expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         second_intermediate_expected_diagnostic_lake_volumes,20,20,0.05_dp)
      call assert_equals(second_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(second_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(second_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(16,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(third_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(third_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(third_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(third_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(third_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(third_intermediate_expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         third_intermediate_expected_diagnostic_lake_volumes,20,20,0.05_dp)
      call assert_equals(third_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(third_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(third_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(17,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(fourth_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(fourth_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(fourth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(fourth_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(fourth_intermediate_expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         fourth_intermediate_expected_diagnostic_lake_volumes,20,20,0.05_dp)
      call assert_equals(fourth_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(fourth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(fourth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(83,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(fifth_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(fifth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(fifth_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(fifth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(fifth_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(fifth_intermediate_expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         fifth_intermediate_expected_diagnostic_lake_volumes,20,20,0.05_dp)
      call assert_equals(fifth_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(fifth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(fifth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(84,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(sixth_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(sixth_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(sixth_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(sixth_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(sixth_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(sixth_intermediate_expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         sixth_intermediate_expected_diagnostic_lake_volumes,20,20,0.05_dp)
      call assert_equals(sixth_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(sixth_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(sixth_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(85,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(seventh_intermediate_expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(seventh_intermediate_expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(seventh_intermediate_expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(seventh_intermediate_expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(seventh_intermediate_expected_lake_types,lake_types,20,20)
      call assert_equals(seventh_intermediate_expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         seventh_intermediate_expected_diagnostic_lake_volumes,20,20,0.05_dp)
      call assert_equals(seventh_intermediate_expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(seventh_intermediate_expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(seventh_intermediate_expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      call river_fields%riverprognosticfieldsdestructor()
      deallocate(river_fields)
      do i = 1,size(flood_merge_and_redirect_indices_collections)
        collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
        call collected_indices%reset_collection()
      end do
      collected_indices => connect_merge_and_redirect_indices_collections(1)%ptr
      call collected_indices%reset_collection()
      river_fields => riverprognosticfields(nlat_coarse,nlon_coarse,1,1,5)
      allocate(lake_volumes_all_timesteps(7,115))
      call init_hd_model_for_testing(river_parameters,river_fields,.True., &
                                     lake_parameters, &
                                     initial_water_to_lake_centers, &
                                     initial_spillover_to_rivers)
      call run_hd_model(115,runoffs,drainages,lake_evaporations,&
                            use_realistic_surface_coupling_in, &
                            "",lake_volumes_all_timesteps)
      call assert_equals(lake_volumes_all_timesteps,expected_lake_volumes_all_timesteps, &
                         7,115,0.01_dp)
      lake_types(:,:) = 0
      lake_prognostics_out => get_lake_prognostics()
      lake_fields_out => get_lake_fields()
      do i = 1,nlat
        do j = 1,nlon
          lake_number = lake_fields_out%lake_numbers(i,j)
          if (lake_number > 0) then
            working_lake_ptr = lake_prognostics_out%lakes(lake_number)
            lake_type = working_lake_ptr%lake_pointer%lake_type
              if (lake_type == filling_lake_type) then
                lake_types(i,j) = 1
              else if (lake_type == overflowing_lake_type) then
                lake_types(i,j) = 2
              else if (lake_type == subsumed_lake_type) then
                lake_types(i,j) = 3
              else
                lake_types(i,j) = 4
              end if
          end if
        end do
      end do
      do i = 1,size(lake_volumes)
        working_lake_ptr = lake_prognostics_out%lakes(i)
        lake_volumes(i) = working_lake_ptr%lake_pointer%lake_volume
      end do
      diagnostic_lake_volumes => calculate_diagnostic_lake_volumes(lake_parameters,&
                                                                   lake_prognostics_out,&
                                                                   lake_fields_out)
      call calculate_lake_fraction_on_surface_grid(lake_parameters,lake_fields_out, &
                                                   lake_fractions)
#ifdef TRANSPOSED_LAKE_MODEL
      call renumber_lakes_two(lake_fields_out)
      call reorder_lake_volumes_two(lake_volumes)
#endif
      call assert_equals(expected_river_inflow,river_fields%river_inflow,4,4,&
                         0.00000001_dp)
      call assert_equals(expected_water_to_ocean,&
                         river_fields%water_to_ocean,4,4,0.00001_dp)
      call assert_equals(expected_water_to_hd,&
                         lake_fields_out%water_to_hd,4,4,0.000000000001_dp)
      call assert_equals(expected_lake_numbers,lake_fields_out%lake_numbers,20,20)
      call assert_equals(expected_lake_types,lake_types,20,20)
      call assert_equals(expected_lake_volumes,lake_volumes,7,0.0001_dp)
      call assert_equals(diagnostic_lake_volumes,&
                         expected_diagnostic_lake_volumes,20,20,0.01_dp)
      call assert_equals(expected_lake_fractions,lake_fractions,3,3,0.000001_dp)
      call assert_equals(expected_number_lake_cells,lake_fields_out%number_lake_cells,3,3)
      call assert_equals(expected_number_fine_grid_cells, &
                         lake_parameters%number_fine_grid_cells,3,3)
      deallocate(diagnostic_lake_volumes)
      deallocate(lake_fractions)
      deallocate(lake_volumes)
      deallocate(drainage)
      deallocate(drainages)
      deallocate(runoff)
      deallocate(runoffs)
      deallocate(evaporation)
      deallocate(lake_evaporations)
      deallocate(initial_spillover_to_rivers)
      deallocate(initial_water_to_lake_centers)
      deallocate(expected_river_inflow)
      deallocate(expected_water_to_ocean)
      deallocate(expected_water_to_hd)
      deallocate(expected_lake_numbers)
      deallocate(expected_lake_types)
      deallocate(expected_lake_volumes)
      deallocate(expected_diagnostic_lake_volumes)
      deallocate(expected_lake_fractions)
      deallocate(expected_number_lake_cells)
      deallocate(expected_number_fine_grid_cells)
      deallocate(first_intermediate_expected_river_inflow)
      deallocate(first_intermediate_expected_water_to_ocean)
      deallocate(first_intermediate_expected_water_to_hd)
      deallocate(first_intermediate_expected_lake_numbers)
      deallocate(first_intermediate_expected_lake_types)
      deallocate(first_intermediate_expected_lake_volumes)
      deallocate(first_intermediate_expected_diagnostic_lake_volumes)
      deallocate(first_intermediate_expected_lake_fractions)
      deallocate(first_intermediate_expected_number_lake_cells)
      deallocate(first_intermediate_expected_number_fine_grid_cells)
      deallocate(second_intermediate_expected_river_inflow)
      deallocate(second_intermediate_expected_water_to_ocean)
      deallocate(second_intermediate_expected_water_to_hd)
      deallocate(second_intermediate_expected_lake_numbers)
      deallocate(second_intermediate_expected_lake_types)
      deallocate(second_intermediate_expected_lake_volumes)
      deallocate(second_intermediate_expected_diagnostic_lake_volumes)
      deallocate(second_intermediate_expected_lake_fractions)
      deallocate(second_intermediate_expected_number_lake_cells)
      deallocate(second_intermediate_expected_number_fine_grid_cells)
      deallocate(third_intermediate_expected_river_inflow)
      deallocate(third_intermediate_expected_water_to_ocean)
      deallocate(third_intermediate_expected_water_to_hd)
      deallocate(third_intermediate_expected_lake_numbers)
      deallocate(third_intermediate_expected_lake_types)
      deallocate(third_intermediate_expected_lake_volumes)
      deallocate(third_intermediate_expected_diagnostic_lake_volumes)
      deallocate(third_intermediate_expected_lake_fractions)
      deallocate(third_intermediate_expected_number_lake_cells)
      deallocate(third_intermediate_expected_number_fine_grid_cells)
      deallocate(fourth_intermediate_expected_river_inflow)
      deallocate(fourth_intermediate_expected_water_to_ocean)
      deallocate(fourth_intermediate_expected_water_to_hd)
      deallocate(fourth_intermediate_expected_lake_numbers)
      deallocate(fourth_intermediate_expected_lake_types)
      deallocate(fourth_intermediate_expected_lake_volumes)
      deallocate(fourth_intermediate_expected_diagnostic_lake_volumes)
      deallocate(fourth_intermediate_expected_lake_fractions)
      deallocate(fourth_intermediate_expected_number_lake_cells)
      deallocate(fourth_intermediate_expected_number_fine_grid_cells)
      deallocate(fifth_intermediate_expected_river_inflow)
      deallocate(fifth_intermediate_expected_water_to_ocean)
      deallocate(fifth_intermediate_expected_water_to_hd)
      deallocate(fifth_intermediate_expected_lake_numbers)
      deallocate(fifth_intermediate_expected_lake_types)
      deallocate(fifth_intermediate_expected_lake_volumes)
      deallocate(fifth_intermediate_expected_diagnostic_lake_volumes)
      deallocate(fifth_intermediate_expected_lake_fractions)
      deallocate(fifth_intermediate_expected_number_lake_cells)
      deallocate(fifth_intermediate_expected_number_fine_grid_cells)
      deallocate(sixth_intermediate_expected_river_inflow)
      deallocate(sixth_intermediate_expected_water_to_ocean)
      deallocate(sixth_intermediate_expected_water_to_hd)
      deallocate(sixth_intermediate_expected_lake_numbers)
      deallocate(sixth_intermediate_expected_lake_types)
      deallocate(sixth_intermediate_expected_lake_volumes)
      deallocate(sixth_intermediate_expected_diagnostic_lake_volumes)
      deallocate(sixth_intermediate_expected_lake_fractions)
      deallocate(sixth_intermediate_expected_number_lake_cells)
      deallocate(sixth_intermediate_expected_number_fine_grid_cells)
      deallocate(seventh_intermediate_expected_river_inflow)
      deallocate(seventh_intermediate_expected_water_to_ocean)
      deallocate(seventh_intermediate_expected_water_to_hd)
      deallocate(seventh_intermediate_expected_lake_numbers)
      deallocate(seventh_intermediate_expected_lake_types)
      deallocate(seventh_intermediate_expected_lake_volumes)
      deallocate(seventh_intermediate_expected_diagnostic_lake_volumes)
      deallocate(seventh_intermediate_expected_lake_fractions)
      deallocate(seventh_intermediate_expected_number_lake_cells)
      deallocate(seventh_intermediate_expected_number_fine_grid_cells)
      deallocate(lake_types)
      deallocate(lake_volumes_all_timesteps)
      deallocate(expected_lake_volumes_all_timesteps)
      call clean_lake_model()
      call clean_hd_model()
end subroutine testLakeModel17

subroutine testLakeNumberRetrieval
  use latlon_lake_model_mod
  use latlon_lake_model_io_mod, only: add_offset
  use latlon_lake_model_retrieve_lake_numbers
  type(lakeparameters),  pointer :: lake_parameters
  type(lakeprognostics), pointer :: lake_prognostics
  type(lakefields),      pointer :: lake_fields
  real(dp),dimension(:,:),pointer :: cell_areas_on_surface_model_grid
  logical,dimension(:,:), pointer :: lake_centers
  real(dp),dimension(:,:), pointer :: connection_volume_thresholds
  real(dp),dimension(:,:), pointer :: flood_volume_thresholds
  integer,dimension(:,:), pointer :: flood_next_cell_lat_index
  integer,dimension(:,:), pointer :: flood_next_cell_lon_index
  integer,dimension(:,:), pointer :: connect_next_cell_lat_index
  integer,dimension(:,:), pointer :: connect_next_cell_lon_index
  integer, pointer, dimension(:,:) :: connect_merge_and_redirect_indices_index
  integer, pointer, dimension(:,:) :: flood_merge_and_redirect_indices_index
  type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    connect_merge_and_redirect_indices_collections
  type(mergeandredirectindicescollectionpointer), pointer, dimension(:) :: &
    flood_merge_and_redirect_indices_collections
  type(mergeandredirectindicescollection), pointer :: collected_indices
  type(mergeandredirectindicespointer), dimension(:), pointer :: primary_merges
  type(mergeandredirectindices), pointer :: secondary_merge
  type(mergeandredirectindices), pointer :: primary_merge
  integer,dimension(:,:), pointer :: corresponding_surface_cell_lat_index
  integer,dimension(:,:), pointer :: corresponding_surface_cell_lon_index
  integer,dimension(:,:), pointer :: expected_lake_numbers
  integer :: nlat,nlon
  integer :: nlat_coarse,nlon_coarse
  integer :: nlat_surface_model,nlon_surface_model
  logical :: instant_throughflow_local
  real(dp) :: lake_retention_coefficient_local
  integer :: flood_index
  integer :: i
    nlat = 20
    nlon = 20
    nlat_coarse = 4
    nlon_coarse = 4
    nlat_surface_model = 3
    nlon_surface_model = 3
    allocate(lake_centers(nlat,nlon))
    lake_centers = transpose(reshape((/ &
        .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False.,  &
                .False., .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .True.,  .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .True.,  .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .True.,  .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .True.,  .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,    .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .True.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .True.,  .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False., &
       .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., .False., &
                .False., .False., .False., .False., .False.,   .False., .False., .False., .False. /), &
       (/nlon,nlat/)))
    allocate(connection_volume_thresholds(nlat,nlon))
    connection_volume_thresholds = transpose(reshape((/ &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0, 186.0, 23.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, 56.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0, -1.0, -1.0, -1.0, -1.0,  -1.0, -1.0,  -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
             -1.0, -1.0, -1.0, -1.0, -1.0 &
       /), &
       (/nlon,nlat/)))
    allocate(flood_volume_thresholds(nlat,nlon))
    flood_volume_thresholds = transpose(reshape((/ &
       -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, &
              -1.0, -1.0, -1.0, -1.0, -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0, 5.0, &
       0.0, 262.0,  5.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0, 111.0, 111.0, 56.0, &
            111.0,   -1.0,    -1.0,   -1.0, 2.0, &
       -1.0,   5.0,  5.0,    -1.0,   -1.0, 340.0, 262.0,   -1.0,   -1.0,  -1.0,  -1.0, 111.0,   1.0,   1.0, 56.0, &
            56.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,   5.0,  5.0,    -1.0,   -1.0,  10.0,  10.0, 38.0, 10.0,  -1.0,  -1.0,    -1.0,   0.0,   1.0,  1.0, &
            26.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,   5.0,  5.0, 186.0,  2.0,   2.0,    -1.0, 10.0, 10.0,  -1.0, 1.0,   6.0,   1.0,   0.0,  1.0,  &
            26.0, 26.0, 111.0,   -1.0,  -1.0, &
       16.0,  16.0, 16.0,    -1.0,  2.0,   0.0,   2.0,  2.0, 10.0,  -1.0, 1.0,   0.0,   0.0,   1.0,  1.0, &
             1.0, 26.0,  56.0,   -1.0,  -1.0, &
       -1.0,  46.0, 16.0,    -1.0,   -1.0,   2.0,    -1.0, 23.0,   -1.0,  -1.0,  -1.0,   1.0,   0.0,   1.0,  1.0, &
             1.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,  56.0,   1.0,   1.0,  1.0, &
            26.0, 56.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,  56.0,  56.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
             0.0,  3.0,   3.0, 10.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
             0.0,  3.0,   3.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,   1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0, &
       -1.0,    -1.0,   -1.0,    -1.0,   -1.0,    -1.0,    -1.0,   -1.0,   -1.0,  -1.0,  -1.0,    -1.0,    -1.0,    -1.0,   -1.0, &
              -1.0,   -1.0,    -1.0,   -1.0,  -1.0 /), &
       (/nlon,nlat/)))
    allocate(cell_areas_on_surface_model_grid(nlat_surface_model,nlon_surface_model))
    cell_areas_on_surface_model_grid = transpose(reshape((/ &
          2.5,3.0,2.5, &
          3.0,4.0,3.0, &
          2.5,3.0,2.5 /), &
      (/nlon_surface_model,nlat_surface_model/)))
    allocate(flood_next_cell_lat_index(nlat,nlon))
    flood_next_cell_lat_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, &
       2,  3,  5, -1, -1, -1, -1, -1, -1, -1, -1, -1,  2,  2,  4,  5, -1, -1, -1,  1, &
       -1,  4,  2, -1, -1,  8,  2, -1, -1, -1, -1,  2,  5,  3,  9,  2, -1, -1, -1, -1, &
       -1,  3,  4, -1, -1,  6,  4,  6,  3, -1, -1, -1,  7,  3,  4,  3,  6, -1, -1, -1, &
       -1,  6,  5,  3,  6,  7, -1,  4,  4, -1,  5,  7,  6,  6,  4,  8,  4,  3, -1, -1, &
       7,  6,  6, -1,  5,  5,  6,  5,  5, -1,  5,  5,  4,  8,  6,  6,  5,  5, -1, -1, &
       -1,  6,  7, -1, -1,  6, -1,  4, -1, -1, -1,  5,  6,  6,  8,  7,  5, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  7,  7,  8,  6,  7, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  8,  9, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 14, 14, 13, 16, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 13, 14, 13, -1, -1, &
       -1, -1, -1, 17, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    allocate(flood_next_cell_lon_index(nlat,nlon))
    flood_next_cell_lon_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,  1, &
       19,  5,  2, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 12, 16,  3, -1, -1, -1, 19, &
       -1,  2,  2, -1, -1, 18,  1, -1, -1, -1, -1, 13, 15, 12, 13, 14, -1, -1, -1, -1, &
       -1,  2,  1, -1, -1,  8,  5, 10,  6, -1, -1, -1, 12, 13, 13, 14, 17, -1, -1, -1, &
       -1,  2,  1,  5,  7,  5, -1,  6,  8, -1, 14, 14, 10, 12, 14, 15, 15, 11, -1, -1, &
       2,  0,  1, -1,  4,  5,  4,  7,  8, -1, 10, 11, 12, 12, 13, 14, 16, 17, -1, -1, &
       -1,  4,  1, -1, -1,  6, -1,  7, -1, -1, -1, 12, 11, 15, 14, 13,  9, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 11, 15, 13, 16, 16, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 11, 12, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, 16, 18, 15, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, -1, -1, &
       -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    allocate(connect_next_cell_lat_index(nlat,nlon))
    connect_next_cell_lat_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1,  3,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1,  3, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    allocate(connect_next_cell_lon_index(nlat,nlon))
    connect_next_cell_lon_index = transpose(reshape((/ &
        -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1,  6,  7, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
       -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 /), &
       (/nlon,nlat/)))
    call add_offset(flood_next_cell_lat_index,1,(/-1/))
    call add_offset(flood_next_cell_lon_index,1,(/-1/))
    call add_offset(connect_next_cell_lat_index,1,(/-1/))
    call add_offset(connect_next_cell_lon_index,1,(/-1/))
    instant_throughflow_local=.True.
    lake_retention_coefficient_local=0.1_dp
      allocate(corresponding_surface_cell_lat_index(nlat,nlon))
    corresponding_surface_cell_lat_index = transpose(reshape((/ &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3, &
                                                           3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))
      allocate(corresponding_surface_cell_lon_index(nlat,nlon))
    corresponding_surface_cell_lon_index = transpose(reshape((/ &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3, &
                                                           1,1,1,1,1,1,1,2,2,2,2,2,2,3,3,3,3,3,3,3 /), &
         (/nlon,nlat/)))

    allocate(connect_merge_and_redirect_indices_index(nlat,nlon))
    connect_merge_and_redirect_indices_index(:,:) =0
    allocate(flood_merge_and_redirect_indices_index(nlat,nlon))
    flood_merge_and_redirect_indices_index(:,:) = 0
allocate(flood_merge_and_redirect_indices_collections(9))
    connect_merge_and_redirect_indices_collections=> null()
    flood_index = 1
    primary_merge => &
    mergeandredirectindices(.true.,&
                            .false., &
                            6, &
                            2, &
                            1, &
                            0)
    allocate(primary_merges(1))
    primary_merges(1)%ptr => primary_merge
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          null())
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(3,16) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    8, &
                                    18, &
                                    1, &
                                    3)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(4,6) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .true., &
                                    6, &
                                    10, &
                                    7, &
                                    14)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(5,8) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .true., &
                                    7, &
                                    14, &
                                    7, &
                                    14)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(6,12) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    6, &
                                    4, &
                                    1, &
                                    0)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(8,2) = flood_index
    flood_index = flood_index + 1
    primary_merge => &
      mergeandredirectindices(.true., &
                              .true., &
                              6, &
                              8, &
                              6, &
                              5)
    allocate(primary_merges(1))
    primary_merges(1)%ptr => primary_merge
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          null())
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(8,17) = flood_index
    flood_index = flood_index + 1
    primary_merge => &
      mergeandredirectindices(.true., &
                              .true., &
                              7, &
                              12, &
                              5, &
                              13)
    allocate(primary_merges(1))
    primary_merges(1)%ptr => primary_merge
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          null())
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(9,15) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    16, &
                                    15, &
                                    3, &
                                    3)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(14,19) = flood_index
    flood_index = flood_index + 1
    secondary_merge => &
            mergeandredirectindices(.false., &
                                    .false., &
                                    17, &
                                    3, &
                                    3, &
                                    1)
    primary_merges => null()
    collected_indices => mergeandredirectindicescollection(primary_merges, &
                                                          secondary_merge)
    flood_merge_and_redirect_indices_collections(flood_index)%ptr => collected_indices
    flood_merge_and_redirect_indices_index(16,4) = flood_index
    do i = 1,size(flood_merge_and_redirect_indices_collections)
      collected_indices => flood_merge_and_redirect_indices_collections(i)%ptr
      call collected_indices%add_offset_to_collection(1)
    end do
    lake_parameters => LakeParameters(lake_centers, &
                                      connection_volume_thresholds, &
                                      flood_volume_thresholds, &
                                      cell_areas_on_surface_model_grid, &
                                      flood_next_cell_lat_index, &
                                      flood_next_cell_lon_index, &
                                      connect_next_cell_lat_index, &
                                      connect_next_cell_lon_index, &
                                      connect_merge_and_redirect_indices_index, &
                                      flood_merge_and_redirect_indices_index, &
                                      connect_merge_and_redirect_indices_collections, &
                                      flood_merge_and_redirect_indices_collections, &
                                      corresponding_surface_cell_lat_index, &
                                      corresponding_surface_cell_lon_index, &
                                      nlat,nlon, &
                                      nlat_coarse,nlon_coarse, &
                                      nlat_surface_model,nlon_surface_model, &
                                      instant_throughflow_local, &
                                      lake_retention_coefficient_local)
      allocate(expected_lake_numbers(nlat,nlon))
      expected_lake_numbers = transpose(reshape((/ &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, &
       1, 5, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 0, 0, 0, 1, &
       0, 1, 1, 0, 0, 5, 5, 0, 0, 0, 0, 5, 5, 5, 5, 5, 0, 0, 0, 0, &
       0, 1, 1, 0, 0, 3, 3, 3, 3, 0, 0, 0, 4, 5, 5, 5, 5, 0, 0, 0, &
       0, 1, 1, 5, 3, 3, 0, 3, 3, 5, 5, 4, 5, 4, 5, 5, 5, 5, 0, 0, &
       1, 1, 1, 0, 3, 3, 3, 3, 3, 0, 5, 4, 4, 5, 5, 5, 5, 5, 0, 0, &
       0, 1, 1, 0, 0, 3, 0, 3, 0, 0, 0, 5, 4, 5, 5, 5, 5, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 6, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 6, 6, 6, 0, 0, &
       0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, &
       0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 /), &
       (/nlon,nlat/)))
      lake_fields => lakefields(lake_parameters)
      lake_prognostics => lakeprognostics(lake_parameters, &
                                          lake_fields)
      call run_lake_number_retrieval(lake_prognostics)
      call assert_equals(lake_fields%lake_numbers,expected_lake_numbers,20,20)
      deallocate(expected_lake_numbers)
      call lake_fields%lakefieldsdestructor()
      call lake_prognostics%lakeprognosticsdestructor()
      call lake_parameters%lakeparametersdestructor()
      deallocate(lake_parameters)
      deallocate(lake_fields)
      deallocate(lake_prognostics)
end subroutine testLakeNumberRetrieval

end module latlon_hd_and_lake_model_test_mod
