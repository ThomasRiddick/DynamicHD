module cotat_plus_test_mod
use fruit
implicit none

contains

    subroutine setup
    end subroutine setup

    subroutine teardown
    end subroutine teardown

    subroutine testSmallGrid
    use cotat_plus
    use cotat_parameters_mod
    integer, dimension(:,:), allocatable :: input_fine_river_directions
    integer, dimension(:,:), allocatable :: input_fine_total_cumulative_flow
    integer, dimension(:,:), allocatable :: output_coarse_river_directions
    integer, dimension(5,5) :: expected_result
        allocate(input_fine_river_directions(15,15))
        allocate(input_fine_total_cumulative_flow(15,15))
        allocate(output_coarse_river_directions(5,5))
        output_coarse_river_directions = -999
        MUFP = 1.5
        area_threshold = 9
        run_check_for_sinks = .True.
        input_fine_river_directions = transpose(reshape((/ &
!
            -1,-1,-1, -1,0,4,   2,2,2, 2,2,2, 3,2,2, &
            -1,-1,-1, -1,-1,-1, 0,4,4, 4,4,1, 4,4,1, &
            -1,-1,-1, -1,-1,9,  8,8,8, 1,7,7, 4,4,4, &
!
            -1,-1,-1, -1,-1,0, 4,4,4,       6,8,5, 8,4,8, &
            -1,0,4, 4,4,5, 7,1,8,       4,6,7, 6,5,4, &
            -1,0,4, 4,5,7, 4,4,1,       9,6,8, 1,6,2, &
!
            -1,-1,0, 4,6,8, 4,4,6,       6,6,7, 4,2,5, &
            -1,-1,-1, 7,6,8, 4,1,3,       9,9,8, 8,7,4, &
            -1,0,0, 4,6,8, 4,4,5,       1,5,5, 9,1,7, &
!
            0,8,7, 7,7,7, 7,4,4,       6,7,4, 4,1,2, &
            8,8,8, 8,1,2, 6,7,5,       9,8,6, 8,7,4, &
            9,2,7, 4,4,2, 9,8,7,       9,8,4, 9,8,8, &
!
            6,6,8, 4,8,1, 2,1,8,       3,8,2, 3,5,8, &
            4,6,8, 7,8,7, 4,4,3,       3,2,6, 6,5,8, &
            9,8,8, 7,8,5, 8,9,8,       6,6,8, 9,8,7  &
!
            /), shape(transpose(input_fine_river_directions))))
        input_fine_total_cumulative_flow = transpose(reshape((/ &
!
        1,  1,  1,    1,  1,  1,    1,  1,  1,    1,  1,  1,    1,  1,  1, &
        1,  1,  1,    1,  1,  1,   52, 48, 45,   42, 11,  6,    4,  3,  2, &
        1,  1,  1,    1,  1,  1,    1,  1,  1,    1, 29,  9,    8,  5,  2, &
!
        1,  1,  1,    1,  1,  8,    6,  5,  4,    1, 22,  1,    2,  1,  1, &
        1, 55, 54,   53, 52,  1,    1,  1,  2,    1,  2, 20,    1,  3,  1, &
        1,  3,  2,    1,  1, 51,    3,  1,  1,    1, 16, 17,    1,  1,  2, &
!
        1,  1,  3,    1,  1, 47,    3,  2,  1,    2,  4, 15,    7,  1,  3, &
        1,  1,  1,    1,  1, 42,    1,  1,  1,    1,  1,  1,    1,  5,  1, &
        1, 35,  5,    2,  2, 39,    3,  1,  1,   24,  1,  1,    1,  1,  1, &
!
        2, 32,  2,    2,  1,  1,   33, 26, 25,    1, 22, 14,   13,  1,  1, &
        1, 31,  1,    1,  1,  1,    1,  6,  1,    1,  5,  1,    3,  8,  5, &
        1,  1, 29,   15, 13,  2,    1,  1,  2,    1,  3,  1,    1,  1,  3, &
!
        1,  3, 13,    1, 12,  3,    1,  1,  1,    1,  1,  1,    1,  1,  2, &
        1,  4,  7,    1,  5,  6,    5,  1,  3,    1,  2, 11,   12, 17,  1, &
        1,  1,  1,    1,  1,  1,    1,  1,  1,    4,  8,  9,    1,  1,  1  &
!
            /), shape(transpose(input_fine_total_cumulative_flow))))

        expected_result = transpose(reshape((/ &
        !
            -1,6,0,4,4, &
             0,4,4,8,5, &
             0,7,4,8,7, &
             8,4,7,4,7, &
             8,7,7,6,5 &
        !
            /), shape(transpose(expected_result))))

        call cotat_plus_latlon(input_fine_river_directions,input_fine_total_cumulative_flow,&
                               output_coarse_river_directions)
        call assert_equals(expected_result,output_coarse_river_directions,5,5)

    end subroutine testSmallGrid

    subroutine testSmallGridTwo
    use cotat_plus
    use cotat_parameters_mod
    integer, dimension(:,:), allocatable :: input_fine_river_directions
    integer, dimension(:,:), allocatable :: input_fine_total_cumulative_flow
    integer, dimension(:,:), allocatable :: output_coarse_river_directions
    integer, dimension(5,5) :: expected_result
        allocate(input_fine_river_directions(15,15))
        allocate(input_fine_total_cumulative_flow(15,15))
        allocate(output_coarse_river_directions(5,5))
        output_coarse_river_directions = -999
        MUFP = 1.5
        area_threshold = 9
        run_check_for_sinks = .True.
        input_fine_river_directions = transpose(reshape((/ &
!
            -1,-1,-1, -1,0,4,   2,2,2, 2,2,2, 5,5,2, &
            -1,-1,-1, -1,-1,-1, 0,4,4, 4,4,1, 8,8,2, &
            4,-1,-1, -1,-1,9,  8,8,8, 1,7,3, 2,1,4, &
!
            -1,-1,-1, -1,-1,0, 4,4,4,   6,8,2, 1,6,8, &
            -1,0,4, 4,4,5, 7,1,8,       4,6,1, 9,6,8, &
            -1,0,4, 4,5,7, 4,4,1,       9,1,8, 5,9,8, &
!
            -1,-1,0, 4,6,8, 4,4,6,       2,6,7, 4,2,5, &
            -1,-1,-1, 7,6,8, 4,1,3,       5,9,8, 8,7,4, &
            -1,0,0, 4,6,8, 4,4,5,       1,5,5, 9,1,7, &
!
            0,8,7, 7,7,7, 7,4,4,       6,7,4, 4,1,2, &
            8,8,8, 8,1,2, 6,7,5,       9,8,6, 8,7,4, &
            9,2,7, 4,4,2, 9,8,7,       9,8,4, 9,8,8, &
!
            6,6,8, 4,8,1, 2,1,8,       3,8,2, 3,5,8, &
            4,6,8, 7,8,7, 4,4,3,       3,2,6, 6,5,8, &
            9,8,8, 7,8,5, 8,9,8,       6,6,8, 9,8,7  &
!
            /), shape(transpose(input_fine_river_directions))))
        input_fine_total_cumulative_flow = transpose(reshape((/ &
!
        1,  1,  1,    1,  1,  1,    1,  1,  1,    1,  1,  1,    5,  8,  3, &
        1,  1,  1,    1,  1,  1,   52, 48, 45,   42, 11,  6,    5,  6,  9, &
        529,  1,  1,    1,  1,  1,    1,  1,  1,    1, 29,  9,    5,  560,  530, &
!
        1,  1,  1,    1,  1,  8,    6,  5,  4,    1, 22, 108,    570,1,  9, &
        1, 55, 54,   53, 52,  1,    1,  1,  2,    1,  2, 711,    1,  1,  7, &
        1,  3,  2,    1,  1, 51,    3,  1,  1,    1, 821, 17,    1,  1,  4, &
!
        1,  1,  3,    1,  1, 47,    3,  2,  1,    825,  4, 15,    7,  1,  3, &
        1,  1,  1,    1,  1, 42,    1,  1,  1,    826,  1,  1,    1,  5,  1, &
        1, 35,  5,    2,  2, 39,    3,  1,  1,   24,  1,  1,    1,  1,  1, &
!
        2, 32,  2,    2,  1,  1,   33, 26, 25,    1, 22, 14,   13,  1,  1, &
        1, 31,  1,    1,  1,  1,    1,  6,  1,    1,  5,  1,    3,  8,  5, &
        1,  1, 29,   15, 13,  2,    1,  1,  2,    1,  3,  1,    1,  1,  3, &
!
        1,  3, 13,    1, 12,  3,    1,  1,  1,    1,  1,  1,    1,  1,  2, &
        1,  4,  7,    1,  5,  6,    5,  1,  3,    1,  2, 11,   12, 17,  1, &
        1,  1,  1,    1,  1,  1,    1,  1,  1,    4,  8,  9,    1,  1,  1  &
!
            /), shape(transpose(input_fine_total_cumulative_flow))))

        expected_result = transpose(reshape((/ &
        !
            4,6,0,4,2, &
             0,4,4,2,4, &
             0,7,4,5,7, &
             8,4,7,4,7, &
             8,7,7,6,5 &
        !
            /), shape(transpose(expected_result))))

        call cotat_plus_latlon(input_fine_river_directions,input_fine_total_cumulative_flow,&
                               output_coarse_river_directions)
        call assert_equals(expected_result,output_coarse_river_directions,5,5)

    end subroutine testSmallGridTwo

    subroutine testSmallGridLatLonToIcon
    use cotat_plus
    use cotat_parameters_mod
    integer, dimension(:,:), pointer :: cell_neighbors
    real(kind=double_precision), dimension(:,:), allocatable :: cell_vertices_lats
    real(kind=double_precision), dimension(:,:), allocatable :: cell_vertices_lons
    real(kind=double_precision), dimension(:), allocatable :: pixel_center_lats
    real(kind=double_precision), dimension(:), allocatable :: pixel_center_lons
    integer, dimension(80)  :: output_coarse_next_cell_index
    integer, dimension(12,40) :: input_fine_river_directions
    integer, dimension(12,40) :: input_fine_total_cumulative_flow
        allocate(cell_neighbors(80,3))
        allocate(cell_vertices_lats(80,3))
        allocate(cell_vertices_lons(80,3))
        allocate(pixel_center_lats(12))
        allocate(pixel_center_lons(40))

        input_fine_river_directions(:,:) = transpose( reshape((/&
            3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, &
            3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, &
            3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, &
            3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, &
            3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, 3,2,2,2,2,2,2,2,2,1, &
            6,6,6,6,6,6,6,6,6,6, 6,6,6,6,6,6,6,6,6,6, 6,6,6,6,6,0,4,4,4,4, 4,4,4,4,4,4,4,4,4,4, &
            9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, &
            9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, &
            9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, &
            9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, &
            9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, &
            9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8, 9,7,7,7,7,7,7,7,7,8 /), (/40,12/)))

        input_fine_total_cumulative_flow(:,:) = transpose( reshape((/&
            1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1, &
            1,3,2,2,2,2,2,2,3,1,1,3,2,2,2,2,2,2,3,1,1,3,2,2,2,2,2,2,3,1,1,3,2,2,2,2,2,2,3,1, &
            1,5,3,3,3,3,3,3,5,1,1,5,3,3,3,3,3,3,5,1,1,5,3,3,3,3,3,3,5,1,1,5,3,3,3,3,3,3,5,1, &
            1,7,4,4,4,4,4,4,7,1,1,7,4,4,4,4,4,4,7,1,1,7,4,4,4,4,4,4,7,1,1,7,4,4,4,4,4,4,7,1, &
            1,9,5,5,5,5,5,5,9,1,1,9,5,5,5,5,5,5,9,1,1,9,5,5,5,5,5,5,9,1,1,9,5,5,5,5,5,5,9,1, &
            16,45,57,68,78,87,95,102,113,120,136,165,177,188,198,207,215,222,233,240,256,285,297,308,&
                318, 480,153,145,138,127,120,104,75,63,52,42,33,25,18,7, &
            12,15,6,6,5,4,3,2,1,6,2,5,6,6,5,4,3,2,1,6,2,5,6,6,5,4,3,2,1,6,2,5,6,6,5,4,3,2,1,6, &
            9,11,5,5,5,4,3,2,1,5,9,1,5,5,5,4,3,2,1,5,9,1,5,5,5,4,3,2,1,5,9,1,5,5,5,4,3,2,1,5, &
            6,8,4,4,4,4,3,2,1,4,6,8,4,4,4,4,3,2,1,4,6,8,4,4,4,4,3,2,1,4,6,8,4,4,4,4,3,2,1,4, &
            4,5,3,3,3,3,3,2,1,3,4,5,3,3,3,3,3,2,1,3,4,5,3,3,3,3,3,2,1,3,4,5,3,3,3,3,3,2,1,3, &
            2,3,2,2,2,2,2,2,1,2,2,3,2,2,2,2,2,2,1,2,2,3,2,2,2,2,2,2,1,2,2,3,2,2,2,2,2,2,1,2, &
            1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1 /), (/40,12/)))
        cell_neighbors = transpose( reshape((/ 5,7,2, &
                                               1,10,3, &
                                               2,13,4, &
                                               3,16,5, &
                                               4,19,1, &
                                               20,21,7, &
                                               1,6,8, &
                                               7,23,9, &
                                               8,25,10, &
                                               2,9,11, &
                                               10,27,12, &
                                               11,29,13, &
                                               3,12,14, &
                                               13,31,15, &
                                               14,33,16, &
                                               4,15,17, &
                                               16,35,18, &
                                               17,37,19, &
                                               5,18,20, &
                                               19,39,6, &
                                               6,40,22, &
                                               21,41,23, &
                                               8,22,24, &
                                               23,43,25, &
                                               24,26,9, &
                                               25,45,27, &
                                               11,26,28, &
                                               27,47,29, &
                                               12,28,30, &
                                               29,49,31, &
                                               14,30,32, &
                                               31,51,33, &
                                               15,32,34, &
                                               33,53,35, &
                                               17,34,36, &
                                               35,55,37, &
                                               18,36,38, &
                                               37,57,39, &
                                               20,38,40, &
                                               39,59,21, &
                                               22,60,42, &
                                               41,61,43, &
                                               24,42,44, &
                                               43,63,45, &
                                               26,44,46, &
                                               45,64,47, &
                                               28,46,48, &
                                               47,66,49, &
                                               30,48,50, &
                                               49,67,51, &
                                               32,50,52, &
                                               51,69,53, &
                                               34,52,54, &
                                               53,70,55, &
                                               36,54,56, &
                                               55,72,57, &
                                               38,56,58, &
                                               57,73,59, &
                                               40,58,60, &
                                               59,75,41, &
                                               42,75,62, &
                                               61,76,63, &
                                               44,62,64, &
                                               46,63,65, &
                                               64,77,66, &
                                               48,65,67, &
                                               50,66,68, &
                                               67,78,69, &
                                               52,68,70, &
                                               54,69,71, &
                                               70,79,72, &
                                               56,71,73, &
                                               58,72,74, &
                                               73,80,75, &
                                               60,74,61, &
                                               62,80,77, &
                                               65,76,78, &
                                               68,77,79, &
                                               71,78,80, &
                                               74,79,76 /), (/3,80/)))
        cell_vertices_lats = transpose(reshape((/  90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0 /), (/3,80/)))
        cell_vertices_lons = transpose(reshape((/ 0.0, 324.0,  36.0, &
                                                  0.0,  36.0, 108.0, &
                                                  0.0, 108.0, 180.0, &
                                                  0.0, 180.0, 252.0, &
                                                  0.0, 252.0, 324.0, &
                                                324.0, 324.0,   0.0, &
                                                324.0,   0.0,  36.0, &
                                                 36.0,   0.0,  36.0, &
                                                 36.0,  36.0,  72.0, &
                                                 36.0,  72.0, 108.0, &
                                                108.0,  72.0, 108.0, &
                                                108.0, 108.0, 144.0, &
                                                108.0, 144.0, 180.0, &
                                                180.0, 144.0, 180.0, &
                                                180.0, 180.0, 216.0, &
                                                180.0, 216.0, 252.0, &
                                                252.0, 216.0, 252.0, &
                                                252.0, 252.0, 288.0, &
                                                252.0, 288.0, 324.0, &
                                                324.0, 288.0, 324.0, &
                                                324.0, 342.0,   0.0, &
                                                  0.0, 342.0,  18.0, &
                                                  0.0,  18.0,  36.0, &
                                                 36.0,  18.0,  54.0, &
                                                 36.0,  54.0,  72.0, &
                                                 72.0,  54.0,  90.0, &
                                                 72.0,  90.0, 108.0, &
                                                108.0,  90.0, 126.0, &
                                                108.0, 126.0, 144.0, &
                                                144.0, 126.0, 162.0, &
                                                144.0, 162.0, 180.0, &
                                                180.0, 162.0, 198.0, &
                                                180.0, 198.0, 216.0, &
                                                216.0, 198.0, 234.0, &
                                                216.0, 234.0, 252.0, &
                                                252.0, 234.0, 270.0, &
                                                252.0, 270.0, 288.0, &
                                                288.0, 270.0, 306.0, &
                                                288.0, 306.0, 324.0, &
                                                324.0, 306.0, 342.0, &
                                                342.0,   0.0,  18.0, &
                                                 18.0,   0.0,  36.0, &
                                                 18.0,  36.0,  54.0, &
                                                 54.0,  36.0,  72.0, &
                                                 54.0,  72.0,  90.0, &
                                                 90.0,  72.0, 108.0, &
                                                 90.0, 108.0, 126.0, &
                                                126.0, 108.0, 144.0, &
                                                126.0, 144.0, 162.0, &
                                                162.0, 144.0, 180.0, &
                                                162.0, 180.0, 198.0, &
                                                198.0, 180.0, 216.0, &
                                                198.0, 216.0, 234.0, &
                                                234.0, 216.0, 252.0, &
                                                234.0, 252.0, 270.0, &
                                                270.0, 252.0, 288.0, &
                                                270.0, 288.0, 306.0, &
                                                306.0, 288.0, 324.0, &
                                                306.0, 324.0, 342.0, &
                                                342.0, 324.0,   0.0, &
                                                  0.0,   0.0,  36.0, &
                                                 36.0,   0.0,  72.0, &
                                                 36.0,  72.0,  72.0, &
                                                 72.0,  72.0, 108.0, &
                                                108.0,  72.0, 144.0, &
                                                108.0, 144.0, 144.0, &
                                                144.0, 144.0, 180.0, &
                                                180.0, 144.0, 216.0, &
                                                180.0, 216.0, 216.0, &
                                                216.0, 216.0, 252.0, &
                                                252.0, 216.0, 288.0, &
                                                252.0, 288.0, 288.0, &
                                                288.0, 288.0, 324.0, &
                                                324.0, 288.0,   0.0, &
                                                324.0,   0.0,   0.0, &
                                                  0.0,   0.0,  72.0, &
                                                 72.0,   0.0, 144.0, &
                                                144.0,   0.0, 216.0, &
                                                216.0,   0.0, 288.0, &
                                                288.0,   0.0,   0.0 /), (/3,80/)))
        pixel_center_lats = (/ 82.5, 67.5, 52.5, 37.5, 22.5, 7.5, &
                               -7.5,-22.5,-37.5,-52.5,-67.5,-82.5 /)
        pixel_center_lons = (/ 4.5, 13.5, 22.5, 31.5, 40.5, 49.5, 58.5, 67.5, 76.5, 85.5, &
                              94.5,103.5,112.5,121.5,130.5,139.5,148.5,157.5,166.5,175.5, &
                             184.5,193.5,202.5,211.5,220.5,229.5,238.5,247.5,256.5,265.5, &
                             274.5,283.5,292.5,301.5,310.5,319.5,328.5,337.5,346.5,355.5 /)
        call cotat_plus_icon_icosohedral_cell_latlon_pixel(input_fine_river_directions,&
                                                           input_fine_total_cumulative_flow,&
                                                           output_coarse_next_cell_index,&
                                                           pixel_center_lats,&
                                                           pixel_center_lons,&
                                                           cell_vertices_lats, &
                                                           cell_vertices_lons, &
                                                           cell_neighbors)
        deallocate(cell_neighbors)
        deallocate(cell_vertices_lats)
        deallocate(cell_vertices_lons)
        deallocate(pixel_center_lats)
        deallocate(pixel_center_lons)
    end subroutine testSmallGridLatLonToIcon

    subroutine testSmallGridLatLonToIconTwo
    use cotat_plus
    use cotat_parameters_mod
    integer, dimension(:,:), pointer :: cell_neighbors
    real(kind=double_precision), dimension(:,:), allocatable :: cell_vertices_lats
    real(kind=double_precision), dimension(:,:), allocatable :: cell_vertices_lons
    real(kind=double_precision), dimension(:), allocatable :: pixel_center_lats
    real(kind=double_precision), dimension(:), allocatable :: pixel_center_lons
    integer, dimension(80)  :: output_coarse_next_cell_index
    integer, dimension(12,40) :: input_fine_river_directions
    integer, dimension(12,40) :: input_fine_total_cumulative_flow
        allocate(cell_neighbors(80,3))
        allocate(cell_vertices_lats(80,3))
        allocate(cell_vertices_lons(80,3))
        allocate(pixel_center_lats(12))
        allocate(pixel_center_lons(40))

        input_fine_river_directions(:,:) = transpose( reshape((/&
            6,6,6,6,6,6,6,6,1,4, 4,4,4,4,4,4,4,4,4,4, 2,2,2,2,2,2,2,2,2,2, 2,2,2,2,2,2,2,2,6,6, &
            4,4,6,6,6,6,6,1,7,7, 7,7,4,4,4,4,4,4,4,4, 6,6,6,6,6,6,6,0,6,6, 6,6,6,6,2,4,4,4,4,4, &
            4,4,6,2,1,4,4,7,7,7, 7,7,4,2,4,4,4,6,6,6, 6,6,6,6,6,6,9,8,6,6, 6,6,6,6,2,4,4,4,4,4, &
            4,4,2,1,7,7,7,7,7,7, 7,7,4,2,4,4,4,6,6,6, 6,6,8,8,8,8,8,8,6,6, 6,6,6,6,2,4,4,4,4,4, &
            4,4,1,4,4,4,4,4,4,4, 4,4,4,2,4,4,4,6,6,6, 6,6,8,8,8,8,8,8,6,6, 6,6,6,6,3,4,4,4,4,4, &
            4,1,8,7,4,4,4,4,4,4, 2,2,4,2,4,4,4,6,6,6, 6,6,8,8,8,8,8,8,6,6, 6,6,6,6,6,3,4,4,4,4, &
            1,8,8,6,7,4,4,4,4,4, 2,2,4,2,4,4,6,6,6,9, 8,8,8,8,8,8,8,8,6,6, 6,6,6,6,6,6,3,4,4,4, &
            8,8,8,6,8,4,4,4,4,4, 2,6,6,6,6,9,8,8,8,8, 8,8,8,8,8,8,8,8,6,6, 6,6,6,6,6,6,6,1,4,4, &
            8,8,8,6,8,4,4,4,4,4, 9,8,8,8,8,8,8,8,8,8, 2,2,2,2,2,2,2,2,2,2, 2,2,6,6,1,4,4,8,8,8, &
            6,6,6,6,6,6,6,6,6,9, 8,8,8,8,8,8,8,8,8,8, 2,2,2,2,2,2,2,2,2,2, 2,2,4,4,8,8,8,8,8,8, &
            6,6,6,6,6,6,6,6,9,4, 8,8,8,8,8,8,8,8,8,8, 6,6,6,6,6,6,6,6,6,6, 6,5,8,8,8,8,8,8,8,8, &
            6,6,6,6,6,6,6,9,4,4, 8,8,8,8,8,8,8,8,8,8, 8,8,8,8,8,8,8,8,8,8, 8,8,8,8,8,8,8,8,8,8 /), (/40,12/)))

        input_fine_total_cumulative_flow(:,:) = transpose( reshape((/&
    3, 4, 5, 6, 7, 8, 9,13,41,23,19, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, &
    2, 1, 1, 2, 3, 4, 7,51, 3, 4, 3, 9, 8, 7, 6, 5, 4, 3, 2, 1, 2, 4, 6, 8,10,12,14,185,2, 4, 6, 8,10,12,24,10, 8, 6, 4, 3, &
    2, 1, 1, 3,57,55,53, 2, 2, 2, 3, 2, 1, 4, 3, 2, 1, 1, 2, 3, 4, 5,139,145,151,157,163,6,1,2,3,4, 5, 6,38, 7, 6, 5, 4, 3, &
    2, 1, 1,61, 1, 1, 1, 1, 1, 1, 1, 2, 1, 8, 3, 2, 1, 1, 2, 3, 4, 5,133,5, 5, 5, 5, 5, 1, 2, 3, 4, 5, 6,52, 7, 6, 5, 4, 3, &
    2, 1,105,10,9, 8, 7, 6, 5, 4, 3, 2, 1,12, 3, 2, 1, 1, 2, 3, 4, 5,127,4, 4, 4, 4, 4, 1, 2, 3, 4, 5, 6,66, 7, 6, 5, 4, 3, &
    1,109,4,28, 6, 5, 4, 3, 2, 1, 1, 2, 1,16, 3, 2, 1, 1, 2, 3,115,118,121,3,3,3, 3, 3, 1, 2, 3, 4, 5, 6, 7,79, 5, 4, 3, 2, &
  112, 3, 3, 1,21, 5, 4, 3, 2, 1, 2, 4, 1,19, 2, 1,91,97,103,109,2,2, 2, 2, 2, 2, 2, 2, 1, 2, 3, 4, 5, 6, 7, 8,91, 3, 2, 1, &
    2, 2, 2, 1,14, 5, 4, 3, 2, 1, 3,46,51,75,80,85, 5, 5, 5, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 6,7,8,9,227,122,117, &
    1, 1, 1, 1, 7, 5, 4, 3, 2, 1,37, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2,241,235,231,4,4,4, &
    1, 2, 3, 4, 5, 6, 7, 8, 9,30, 3, 3, 3, 3, 3, 3, 3, 3,  3,  3,  2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,249,247,244,3,3,3,3,3,3, &
    1, 2, 3, 4, 5, 6, 7, 8,20, 1, 2, 2, 2,2, 2, 2, 2, 2,  2, 2, 4, 8,12,16,20,24,28,32,36,40,44,295, 2, 2, 2, 2, 2, 2, 2,2, &
    1, 2, 3, 4, 5, 6, 7,10, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 /),&
     (/40,12/)))
        cell_neighbors = transpose( reshape((/ 5,7,2, &
                                               1,10,3, &
                                               2,13,4, &
                                               3,16,5, &
                                               4,19,1, &
                                               20,21,7, &
                                               1,6,8, &
                                               7,23,9, &
                                               8,25,10, &
                                               2,9,11, &
                                               10,27,12, &
                                               11,29,13, &
                                               3,12,14, &
                                               13,31,15, &
                                               14,33,16, &
                                               4,15,17, &
                                               16,35,18, &
                                               17,37,19, &
                                               5,18,20, &
                                               19,39,6, &
                                               6,40,22, &
                                               21,41,23, &
                                               8,22,24, &
                                               23,43,25, &
                                               24,26,9, &
                                               25,45,27, &
                                               11,26,28, &
                                               27,47,29, &
                                               12,28,30, &
                                               29,49,31, &
                                               14,30,32, &
                                               31,51,33, &
                                               15,32,34, &
                                               33,53,35, &
                                               17,34,36, &
                                               35,55,37, &
                                               18,36,38, &
                                               37,57,39, &
                                               20,38,40, &
                                               39,59,21, &
                                               22,60,42, &
                                               41,61,43, &
                                               24,42,44, &
                                               43,63,45, &
                                               26,44,46, &
                                               45,64,47, &
                                               28,46,48, &
                                               47,66,49, &
                                               30,48,50, &
                                               49,67,51, &
                                               32,50,52, &
                                               51,69,53, &
                                               34,52,54, &
                                               53,70,55, &
                                               36,54,56, &
                                               55,72,57, &
                                               38,56,58, &
                                               57,73,59, &
                                               40,58,60, &
                                               59,75,41, &
                                               42,75,62, &
                                               61,76,63, &
                                               44,62,64, &
                                               46,63,65, &
                                               64,77,66, &
                                               48,65,67, &
                                               50,66,68, &
                                               67,78,69, &
                                               52,68,70, &
                                               54,69,71, &
                                               70,79,72, &
                                               56,71,73, &
                                               58,72,74, &
                                               73,80,75, &
                                               60,74,61, &
                                               62,80,77, &
                                               65,76,78, &
                                               68,77,79, &
                                               71,78,80, &
                                               74,79,76 /), (/3,80/)))
        cell_vertices_lats = transpose(reshape((/  90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0 /), (/3,80/)))
        cell_vertices_lons = transpose(reshape((/ 0.0, 324.0,  36.0, &
                                                  0.0,  36.0, 108.0, &
                                                  0.0, 108.0, 180.0, &
                                                  0.0, 180.0, 252.0, &
                                                  0.0, 252.0, 324.0, &
                                                324.0, 324.0,   0.0, &
                                                324.0,   0.0,  36.0, &
                                                 36.0,   0.0,  36.0, &
                                                 36.0,  36.0,  72.0, &
                                                 36.0,  72.0, 108.0, &
                                                108.0,  72.0, 108.0, &
                                                108.0, 108.0, 144.0, &
                                                108.0, 144.0, 180.0, &
                                                180.0, 144.0, 180.0, &
                                                180.0, 180.0, 216.0, &
                                                180.0, 216.0, 252.0, &
                                                252.0, 216.0, 252.0, &
                                                252.0, 252.0, 288.0, &
                                                252.0, 288.0, 324.0, &
                                                324.0, 288.0, 324.0, &
                                                324.0, 342.0,   0.0, &
                                                  0.0, 342.0,  18.0, &
                                                  0.0,  18.0,  36.0, &
                                                 36.0,  18.0,  54.0, &
                                                 36.0,  54.0,  72.0, &
                                                 72.0,  54.0,  90.0, &
                                                 72.0,  90.0, 108.0, &
                                                108.0,  90.0, 126.0, &
                                                108.0, 126.0, 144.0, &
                                                144.0, 126.0, 162.0, &
                                                144.0, 162.0, 180.0, &
                                                180.0, 162.0, 198.0, &
                                                180.0, 198.0, 216.0, &
                                                216.0, 198.0, 234.0, &
                                                216.0, 234.0, 252.0, &
                                                252.0, 234.0, 270.0, &
                                                252.0, 270.0, 288.0, &
                                                288.0, 270.0, 306.0, &
                                                288.0, 306.0, 324.0, &
                                                324.0, 306.0, 342.0, &
                                                342.0,   0.0,  18.0, &
                                                 18.0,   0.0,  36.0, &
                                                 18.0,  36.0,  54.0, &
                                                 54.0,  36.0,  72.0, &
                                                 54.0,  72.0,  90.0, &
                                                 90.0,  72.0, 108.0, &
                                                 90.0, 108.0, 126.0, &
                                                126.0, 108.0, 144.0, &
                                                126.0, 144.0, 162.0, &
                                                162.0, 144.0, 180.0, &
                                                162.0, 180.0, 198.0, &
                                                198.0, 180.0, 216.0, &
                                                198.0, 216.0, 234.0, &
                                                234.0, 216.0, 252.0, &
                                                234.0, 252.0, 270.0, &
                                                270.0, 252.0, 288.0, &
                                                270.0, 288.0, 306.0, &
                                                306.0, 288.0, 324.0, &
                                                306.0, 324.0, 342.0, &
                                                342.0, 324.0,   0.0, &
                                                  0.0,   0.0,  36.0, &
                                                 36.0,   0.0,  72.0, &
                                                 36.0,  72.0,  72.0, &
                                                 72.0,  72.0, 108.0, &
                                                108.0,  72.0, 144.0, &
                                                108.0, 144.0, 144.0, &
                                                144.0, 144.0, 180.0, &
                                                180.0, 144.0, 216.0, &
                                                180.0, 216.0, 216.0, &
                                                216.0, 216.0, 252.0, &
                                                252.0, 216.0, 288.0, &
                                                252.0, 288.0, 288.0, &
                                                288.0, 288.0, 324.0, &
                                                324.0, 288.0,   0.0, &
                                                324.0,   0.0,   0.0, &
                                                  0.0,   0.0,  72.0, &
                                                 72.0,   0.0, 144.0, &
                                                144.0,   0.0, 216.0, &
                                                216.0,   0.0, 288.0, &
                                                288.0,   0.0,   0.0 /), (/3,80/)))
        pixel_center_lats = (/ 82.5, 67.5, 52.5, 37.5, 22.5, 7.5, &
                               -7.5,-22.5,-37.5,-52.5,-67.5,-82.5 /)
        pixel_center_lons = (/ 4.5, 13.5, 22.5, 31.5, 40.5, 49.5, 58.5, 67.5, 76.5, 85.5, &
                              94.5,103.5,112.5,121.5,130.5,139.5,148.5,157.5,166.5,175.5, &
                             184.5,193.5,202.5,211.5,220.5,229.5,238.5,247.5,256.5,265.5, &
                             274.5,283.5,292.5,301.5,310.5,319.5,328.5,337.5,346.5,355.5 /)
        call cotat_plus_icon_icosohedral_cell_latlon_pixel(input_fine_river_directions,&
                                                           input_fine_total_cumulative_flow,&
                                                           output_coarse_next_cell_index,&
                                                           pixel_center_lats,&
                                                           pixel_center_lons,&
                                                           cell_vertices_lats, &
                                                           cell_vertices_lons, &
                                                           cell_neighbors)
        deallocate(cell_neighbors)
        deallocate(cell_vertices_lats)
        deallocate(cell_vertices_lons)
        deallocate(pixel_center_lats)
        deallocate(pixel_center_lons)
    end subroutine testSmallGridLatLonToIconTwo

  subroutine testSmallGridLatLonToIconThree
    use cotat_plus
    use cotat_parameters_mod
    integer, dimension(:,:), pointer :: cell_neighbors
    real(kind=double_precision), dimension(:,:), allocatable :: cell_vertices_lats
    real(kind=double_precision), dimension(:,:), allocatable :: cell_vertices_lons
    real(kind=double_precision), dimension(:), allocatable :: pixel_center_lats
    real(kind=double_precision), dimension(:), allocatable :: pixel_center_lons
    integer, dimension(80)  :: output_coarse_next_cell_index
    integer, dimension(12,40) :: input_fine_river_directions
    integer, dimension(12,40) :: input_fine_total_cumulative_flow
        allocate(cell_neighbors(80,3))
        allocate(cell_vertices_lats(80,3))
        allocate(cell_vertices_lons(80,3))
        allocate(pixel_center_lats(12))
        allocate(pixel_center_lons(40))

        input_fine_river_directions(:,:) = transpose( reshape((/&
            6,6,6,6,6,6,6,6,1,4, 4,4,4,4,4,4,4,4,4,4, 2,2,2,2,2,2,2,2,2,2, 2,2,2,2,2,2,2,2,6,6, &
            4,4,6,6,6,6,6,1,7,7, 7,7,4,4,4,4,4,4,4,4, 6,6,6,6,6,6,6,0,6,6, 6,6,6,6,2,4,4,4,4,4, &
            4,4,6,2,1,4,4,7,7,7, 7,7,4,2,4,4,4,6,6,6, 6,6,6,6,6,6,9,8,6,6, 6,6,6,6,2,4,4,4,4,4, &
            4,4,2,1,7,7,7,7,7,7, 7,7,4,2,4,4,4,6,6,6, 6,6,8,8,8,8,8,8,6,6, 6,6,6,6,2,4,4,4,4,4, &
            4,4,1,4,4,4,4,4,4,4, 4,4,4,2,4,4,4,6,6,6, 6,6,8,8,8,8,8,8,6,6, 6,6,6,6,3,4,4,4,4,4, &
            4,1,8,7,4,4,4,4,4,4, 2,2,4,2,4,4,4,6,6,6, 6,6,8,8,8,8,8,8,6,6, 6,6,6,6,6,3,4,4,4,4, &
            1,8,8,6,7,4,4,4,4,4, 2,2,4,2,4,4,6,6,6,9, 8,8,8,8,8,8,8,8,6,6, 6,6,6,6,6,6,3,4,4,4, &
            8,8,8,6,8,4,4,4,4,4, 2,6,6,6,6,9,8,8,8,8, 8,8,8,8,8,8,8,8,6,6, 6,6,6,6,6,6,6,1,4,4, &
            8,8,8,6,8,4,4,4,4,4, 9,8,8,8,8,8,8,8,8,8, 2,2,2,2,2,2,2,2,2,2, 2,2,6,6,1,4,4,8,8,8, &
            6,6,6,6,6,6,6,6,6,9, 8,8,8,8,8,8,8,8,8,8, 2,2,2,2,2,2,2,2,2,2, 2,2,4,4,8,8,8,8,8,8, &
            6,6,6,6,6,6,6,6,9,4, 8,8,8,8,8,8,8,8,8,8, 6,6,6,6,6,6,6,6,6,6, 6,5,8,8,8,8,8,8,8,8, &
            6,6,6,6,6,6,6,9,4,4, 8,8,8,8,8,8,8,8,8,8, 8,8,8,8,8,8,8,8,8,8, 8,8,8,8,8,8,8,8,8,8 /), (/40,12/)))

        input_fine_total_cumulative_flow(:,:) = transpose( reshape((/&
    3, 4, 5, 6, 7, 8, 9,13,41,23,19, 9, 8, 7, 6, 5, 4, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, &
    2, 1, 1, 2, 3, 4, 7,51, 3, 4, 3, 9, 8, 7, 6, 5, 4, 3, 2, 1, 2, 4, 6, 8,10,12,14,185,2, 4, 6, 8,10,12,24,10, 8, 6, 4, 3, &
    2, 1, 1, 3,57,55,53, 2, 2, 2, 3, 2, 1, 4, 3, 2, 1, 1, 2, 3, 4, 5,139,145,151,157,163,6,1,2,3,4, 5, 6,38, 7, 6, 5, 4, 3, &
    2, 1, 1,61, 1, 1, 1, 1, 1, 1, 1, 2, 1, 8, 3, 2, 1, 1, 2, 3, 4, 5,133,5, 5, 5, 5, 5, 1, 2, 3, 4, 5, 6,52, 7, 6, 5, 4, 3, &
    2, 1,105,10,9, 8, 7, 6, 5, 4, 3, 2, 1,12, 3, 2, 1, 1, 2, 3, 4, 5,127,4, 4, 4, 4, 4, 1, 2, 3, 4, 5, 6,66, 7, 6, 5, 4, 3, &
    1,109,4,28, 6, 5, 4, 3, 2, 1, 1, 2, 1,16, 3, 2, 1, 1, 2, 3,115,118,121,3,3,3, 3, 3, 1, 2, 3, 4, 5, 6, 7,79, 5, 4, 3, 2, &
  112, 3, 3, 1,21, 5, 4, 3, 2, 1, 2, 4, 1,19, 2, 1,91,97,103,109,2,2, 2, 2, 2, 2, 2, 2, 1, 2, 3, 4, 5, 6, 7, 8,91, 3, 2, 1, &
    2, 2, 2, 1,14, 5, 4, 3, 2, 1, 3,46,51,75,80,85, 5, 5, 5, 5, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 3, 4, 5, 6,7,8,9,227,122,117, &
    1, 1, 1, 1, 7, 5, 4, 3, 2, 1,37, 4, 4, 4, 4, 4, 4, 4, 4, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2,241,235,231,4,4,4, &
    1, 2, 3, 4, 5, 6, 7, 8, 9,30, 3, 3, 3, 3, 3, 3, 3, 3,  3,  3,  2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,249,247,244,3,3,3,3,3,3, &
    1, 2, 3, 4, 5, 6, 7, 8,20, 1, 2, 2, 2,2, 2, 2, 2, 2,  2, 2, 4, 8,12,16,20,24,28,32,36,40,44,295, 2, 2, 2, 2, 2, 2, 2,2, &
    1, 2, 3, 4, 5, 6, 7,10, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 /),&
     (/40,12/)))
        cell_neighbors = transpose( reshape((/ 5,7,2, &
                                               1,10,3, &
                                               2,13,4, &
                                               3,16,5, &
                                               4,19,1, &
                                               20,21,7, &
                                               1,6,8, &
                                               7,23,9, &
                                               8,25,10, &
                                               2,9,11, &
                                               10,27,12, &
                                               11,29,13, &
                                               3,12,14, &
                                               13,31,15, &
                                               14,33,16, &
                                               4,15,17, &
                                               16,35,18, &
                                               17,37,19, &
                                               5,18,20, &
                                               19,39,6, &
                                               6,40,22, &
                                               21,41,23, &
                                               8,22,24, &
                                               23,43,25, &
                                               24,26,9, &
                                               25,45,27, &
                                               11,26,28, &
                                               27,47,29, &
                                               12,28,30, &
                                               29,49,31, &
                                               14,30,32, &
                                               31,51,33, &
                                               15,32,34, &
                                               33,53,35, &
                                               17,34,36, &
                                               35,55,37, &
                                               18,36,38, &
                                               37,57,39, &
                                               20,38,40, &
                                               39,59,21, &
                                               22,60,42, &
                                               41,61,43, &
                                               24,42,44, &
                                               43,63,45, &
                                               26,44,46, &
                                               45,64,47, &
                                               28,46,48, &
                                               47,66,49, &
                                               30,48,50, &
                                               49,67,51, &
                                               32,50,52, &
                                               51,69,53, &
                                               34,52,54, &
                                               53,70,55, &
                                               36,54,56, &
                                               55,72,57, &
                                               38,56,58, &
                                               57,73,59, &
                                               40,58,60, &
                                               59,75,41, &
                                               42,75,62, &
                                               61,76,63, &
                                               44,62,64, &
                                               46,63,65, &
                                               64,77,66, &
                                               48,65,67, &
                                               50,66,68, &
                                               67,78,69, &
                                               52,68,70, &
                                               54,69,71, &
                                               70,79,72, &
                                               56,71,73, &
                                               58,72,74, &
                                               73,80,75, &
                                               60,74,61, &
                                               62,80,77, &
                                               65,76,78, &
                                               68,77,79, &
                                               71,78,80, &
                                               74,79,76 /), (/3,80/)))
        cell_vertices_lats = transpose(reshape((/  90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   90.0,  60.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  30.0, &
                                                   60.0,  30.0,  60.0, &
                                                   60.0,  30.0,  30.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                   30.0,   0.0,  30.0, &
                                                   30.0,   0.0,   0.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                    0.0, -30.0,   0.0, &
                                                    0.0, -30.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -30.0, -60.0, -60.0, &
                                                  -30.0, -60.0, -30.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0, &
                                                  -60.0, -90.0, -60.0 /), (/3,80/)))
        cell_vertices_lons = transpose(reshape((/ 0.0, -36.0,  36.0, &
                                                  0.0,  36.0, 108.0, &
                                                  0.0, 108.0, 180.0, &
                                                  0.0, 180.0,-108.0, &
                                                  0.0,-108.0, -36.0, &
                                                -36.0, -36.0,   0.0, &
                                                -36.0,   0.0,  36.0, &
                                                 36.0,   0.0,  36.0, &
                                                 36.0,  36.0,  72.0, &
                                                 36.0,  72.0, 108.0, &
                                                108.0,  72.0, 108.0, &
                                                108.0, 108.0, 144.0, &
                                                108.0, 144.0, 180.0, &
                                                180.0, 144.0, 180.0, &
                                                180.0, 180.0,-144.0, &
                                                180.0,-144.0,-108.0, &
                                               -108.0,-144.0,-108.0, &
                                               -108.0,-108.0, -72.0, &
                                               -108.0, -72.0, -36.0, &
                                                -36.0, -72.0, -36.0, &
                                                -36.0, -18.0,   0.0, &
                                                  0.0, -18.0,  18.0, &
                                                  0.0,  18.0,  36.0, &
                                                 36.0,  18.0,  54.0, &
                                                 36.0,  54.0,  72.0, &
                                                 72.0,  54.0,  90.0, &
                                                 72.0,  90.0, 108.0, &
                                                108.0,  90.0, 126.0, &
                                                108.0, 126.0, 144.0, &
                                                144.0, 126.0, 162.0, &
                                                144.0, 162.0, 180.0, &
                                                180.0, 162.0,-162.0, &
                                                180.0,-162.0,-144.0, &
                                               -144.0,-162.0,-126.0, &
                                               -144.0,-126.0,-108.0, &
                                               -108.0,-126.0, -90.0, &
                                               -108.0, -90.0, -72.0, &
                                                -72.0, -90.0, -54.0, &
                                                -72.0, -54.0, -36.0, &
                                                -36.0, -54.0, -18.0, &
                                                -18.0,   0.0,  18.0, &
                                                 18.0,   0.0,  36.0, &
                                                 18.0,  36.0,  54.0, &
                                                 54.0,  36.0,  72.0, &
                                                 54.0,  72.0,  90.0, &
                                                 90.0,  72.0, 108.0, &
                                                 90.0, 108.0, 126.0, &
                                                126.0, 108.0, 144.0, &
                                                126.0, 144.0, 162.0, &
                                                162.0, 144.0, 180.0, &
                                                162.0, 180.0,-162.0, &
                                               -162.0, 180.0,-144.0, &
                                               -162.0,-144.0,-126.0, &
                                               -126.0,-144.0,-108.0, &
                                               -126.0,-108.0, -90.0, &
                                                -90.0,-108.0, -72.0, &
                                                -90.0, -72.0, -54.0, &
                                                -54.0, -72.0, -36.0, &
                                                -54.0, -36.0, -18.0, &
                                                -18.0, -36.0,   0.0, &
                                                  0.0,   0.0,  36.0, &
                                                 36.0,   0.0,  72.0, &
                                                 36.0,  72.0,  72.0, &
                                                 72.0,  72.0, 108.0, &
                                                108.0,  72.0, 144.0, &
                                                108.0, 144.0, 144.0, &
                                                144.0, 144.0, 180.0, &
                                                180.0, 144.0,-144.0, &
                                                180.0,-144.0,-144.0, &
                                               -144.0,-144.0,-108.0, &
                                               -108.0,-144.0, -72.0, &
                                               -108.0, -72.0, -72.0, &
                                                -72.0, -72.0, -36.0, &
                                                -36.0, -72.0,   0.0, &
                                                -36.0,   0.0,   0.0, &
                                                  0.0,   0.0,  72.0, &
                                                 72.0,   0.0, 144.0, &
                                                144.0,   0.0,-144.0, &
                                               -144.0,   0.0, -72.0, &
                                                -72.0,   0.0,   0.0 /), (/3,80/)))
        pixel_center_lats = (/ 82.5, 67.5, 52.5, 37.5, 22.5, 7.5, &
                               -7.5,-22.5,-37.5,-52.5,-67.5,-82.5 /)
        pixel_center_lons = (/ 4.5, 13.5, 22.5, 31.5, 40.5, 49.5, 58.5, 67.5, 76.5, 85.5, &
                              94.5,103.5,112.5,121.5,130.5,139.5,148.5,157.5,166.5,175.5, &
                             184.5,193.5,202.5,211.5,220.5,229.5,238.5,247.5,256.5,265.5, &
                             274.5,283.5,292.5,301.5,310.5,319.5,328.5,337.5,346.5,355.5 /)
        call cotat_plus_icon_icosohedral_cell_latlon_pixel(input_fine_river_directions,&
                                                           input_fine_total_cumulative_flow,&
                                                           output_coarse_next_cell_index,&
                                                           pixel_center_lats,&
                                                           pixel_center_lons,&
                                                           cell_vertices_lats, &
                                                           cell_vertices_lons, &
                                                           cell_neighbors, .true. )
        deallocate(cell_neighbors)
        deallocate(cell_vertices_lats)
        deallocate(cell_vertices_lons)
        deallocate(pixel_center_lats)
        deallocate(pixel_center_lons)
  end subroutine testSmallGridLatLonToIconThree

  subroutine testFindingLocalizedLoops
    use cotat_plus
    use cotat_parameters_mod
    type(icon_icosohedral_grid), pointer :: coarse_grid
    type(icon_single_index_index_based_rdirs_field) :: index_based_rdirs_field
    integer, dimension(:,:), pointer :: cell_neighbors
    integer, dimension(:,:), pointer :: secondary_neighbors
    integer, dimension(80)  :: coarse_next_cell_index
    logical, dimension(:), allocatable :: cells_to_reprocess
    logical, dimension(:,:), pointer :: cells_to_reprocess_local
    type(generic_1d_section_coords),pointer :: coarse_grid_shape
    integer :: i
        allocate(cell_neighbors(80,3))
        cell_neighbors = transpose( reshape((/ 5,7,2, &
                                               1,10,3, &
                                               2,13,4, &
                                               3,16,5, &
                                               4,19,1, &
                                               20,21,7, &
                                               1,6,8, &
                                               7,23,9, &
                                               8,25,10, &
                                               2,9,11, &
                                               10,27,12, &
                                               11,29,13, &
                                               3,12,14, &
                                               13,31,15, &
                                               14,33,16, &
                                               4,15,17, &
                                               16,35,18, &
                                               17,37,19, &
                                               5,18,20, &
                                               19,39,6, &
                                               6,40,22, &
                                               21,41,23, &
                                               8,22,24, &
                                               23,43,25, &
                                               24,26,9, &
                                               25,45,27, &
                                               11,26,28, &
                                               27,47,29, &
                                               12,28,30, &
                                               29,49,31, &
                                               14,30,32, &
                                               31,51,33, &
                                               15,32,34, &
                                               33,53,35, &
                                               17,34,36, &
                                               35,55,37, &
                                               18,36,38, &
                                               37,57,39, &
                                               20,38,40, &
                                               39,59,21, &
                                               22,60,42, &
                                               41,61,43, &
                                               24,42,44, &
                                               43,63,45, &
                                               26,44,46, &
                                               45,64,47, &
                                               28,46,48, &
                                               47,66,49, &
                                               30,48,50, &
                                               49,67,51, &
                                               32,50,52, &
                                               51,69,53, &
                                               34,52,54, &
                                               53,70,55, &
                                               36,54,56, &
                                               55,72,57, &
                                               38,56,58, &
                                               57,73,59, &
                                               40,58,60, &
                                               59,75,41, &
                                               42,75,62, &
                                               61,76,63, &
                                               44,62,64, &
                                               46,63,65, &
                                               64,77,66, &
                                               48,65,67, &
                                               50,66,68, &
                                               67,78,69, &
                                               52,68,70, &
                                               54,69,71, &
                                               70,79,72, &
                                               56,71,73, &
                                               58,72,74, &
                                               73,80,75, &
                                               60,74,61, &
                                               62,80,77, &
                                               65,76,78, &
                                               68,77,79, &
                                               71,78,80, &
                                               74,79,76 /), (/3,80/)))
    coarse_next_cell_index = (/ 2, 1, 13, 16, 19, &
                                7, 6, 23, 25, 26, 3, 29, 3, 3, 33, 34, 35, 37, 38, -5, &
      -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, &
      -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, &
                               -2,-2, -2, -2, -2,-2, -2,-2,-2, -2, -2,-2, -2, -2, -2, &
                               -2, -2, -2, -2, -2 /)
    coarse_grid => icon_icosohedral_grid(cell_neighbors)
    call coarse_grid%calculate_secondary_neighbors()
    secondary_neighbors => coarse_grid%get_cell_secondary_neighbors()
    allocate(coarse_grid_shape)
    coarse_grid_shape = generic_1d_section_coords(cell_neighbors,&
                                                  secondary_neighbors)
    index_based_rdirs_field = &
      icon_single_index_index_based_rdirs_field(coarse_grid_shape,&
                                                coarse_next_cell_index)
    cells_to_reprocess_local => index_based_rdirs_field%check_field_for_localized_loops()
    call index_based_rdirs_field%destructor()
    allocate(cells_to_reprocess(size(cells_to_reprocess_local,1)))
    cells_to_reprocess(:) = cells_to_reprocess_local(:,1)
    write(*,"(5(5X,(L2),5X))") (cells_to_reprocess(i), i=1,5)
    write(*,"(15(1X,L2,1X))") (cells_to_reprocess(i), i=6,20)
    write(*,"(20(1X,L2))") (cells_to_reprocess(i), i=21,40)
    write(*,"(20(1X,L2))") (cells_to_reprocess(i), i=41,60)
    write(*,"(15(1X,L2,1X))") (cells_to_reprocess(i), i=61,75)
    write(*,"(5(5X,(L2),5X))") (cells_to_reprocess(i), i=76,80)
    write(*,*) " "
    call coarse_grid%unstructured_grid_destructor()
    deallocate(cell_neighbors)
    deallocate(coarse_grid)
    call coarse_grid_shape%generic_1d_section_coords_destructor()
    deallocate(coarse_grid_shape)
    deallocate(cells_to_reprocess)
    deallocate(cells_to_reprocess_local)
  end subroutine testFindingLocalizedLoops
end module cotat_plus_test_mod
